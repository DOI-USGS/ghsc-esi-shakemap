
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>shakemap.coremods.model &#8212; ShakeMap Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for shakemap.coremods.model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Process a ShakeMap, based on the configuration and data found in</span>
<span class="sd">shake_data.hdf, and produce output in shake_result.hdf.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">gmtime</span><span class="p">,</span> <span class="n">strftime</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib</span> <span class="kn">import</span> <span class="n">imt</span>
<span class="kn">import</span> <span class="nn">openquake.hazardlib.const</span> <span class="k">as</span> <span class="nn">oqconst</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">cartopy.io.shapereader</span> <span class="k">as</span> <span class="nn">shpreader</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">shape</span>

<span class="kn">import</span> <span class="nn">concurrent.futures</span> <span class="k">as</span> <span class="nn">cf</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">mapio.geodict</span> <span class="kn">import</span> <span class="n">GeoDict</span>
<span class="kn">from</span> <span class="nn">mapio.grid2d</span> <span class="kn">import</span> <span class="n">Grid2D</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">CoreModule</span><span class="p">,</span> <span class="n">Contents</span>
<span class="kn">from</span> <span class="nn">shakelib.rupture.point_rupture</span> <span class="kn">import</span> <span class="n">PointRupture</span>
<span class="kn">from</span> <span class="nn">shakelib.sites</span> <span class="kn">import</span> <span class="n">Sites</span>
<span class="kn">from</span> <span class="nn">shakelib.distance</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Distance</span><span class="p">,</span>
                               <span class="n">get_distance</span><span class="p">,</span>
                               <span class="n">get_distance_measures</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">shakelib.multigmpe</span> <span class="kn">import</span> <span class="n">MultiGMPE</span>
<span class="kn">from</span> <span class="nn">shakelib.virtualipe</span> <span class="kn">import</span> <span class="n">VirtualIPE</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.utils</span> <span class="kn">import</span> <span class="n">get_extent</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.imt_string</span> <span class="kn">import</span> <span class="n">oq_to_file</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.containers</span> <span class="kn">import</span> <span class="n">ShakeMapInputContainer</span>
<span class="kn">from</span> <span class="nn">impactutils.io.smcontainers</span> <span class="kn">import</span> <span class="n">ShakeMapOutputContainer</span>
<span class="kn">from</span> <span class="nn">shakelib.rupture</span> <span class="kn">import</span> <span class="n">constants</span>

<span class="kn">from</span> <span class="nn">shakemap.utils.config</span> <span class="kn">import</span> <span class="n">get_config_paths</span>
<span class="kn">from</span> <span class="nn">shakemap.utils.utils</span> <span class="kn">import</span> <span class="n">get_object_from_config</span>
<span class="kn">from</span> <span class="nn">shakemap._version</span> <span class="kn">import</span> <span class="n">get_versions</span>
<span class="kn">from</span> <span class="nn">shakemap.utils.generic_amp</span> <span class="kn">import</span> <span class="n">get_generic_amp_factors</span>
<span class="kn">from</span> <span class="nn">shakemap.c.clib</span> <span class="kn">import</span> <span class="p">(</span><span class="n">make_sigma_matrix</span><span class="p">,</span>
                             <span class="n">geodetic_distance_fast</span><span class="p">,</span>
                             <span class="n">make_sd_array</span><span class="p">)</span>
<span class="c1"># from shakemap.utils.exception import TerminateShakeMap</span>

<span class="kn">from</span> <span class="nn">shakelib.directivity.rowshandel2013</span> <span class="kn">import</span> <span class="n">Rowshandel2013</span>

<span class="c1">#</span>
<span class="c1"># TODO: Some constants; these should maybe be in a configuration</span>
<span class="c1"># or in a constants module or be GMICE-specific.</span>
<span class="c1">#</span>
<span class="c1"># default_mmi_stddev: the standard deviation of MMI values if it</span>
<span class="c1">#                     is not specified in the input</span>
<span class="c1"># min_mmi_convert: the minimum MMI to convert to PGM -- low</span>
<span class="c1">#                  intensities don&#39;t convert very accurately</span>
<span class="c1"># default_stddev_inter: This is a stand-in for tau when the gmpe set</span>
<span class="c1">#                       doesn&#39;t provide it. It is an educated guess based</span>
<span class="c1">#                       on the NGA-west, Akkar et al, and BC Hydro gmpes.</span>
<span class="c1">#                       It&#39;s not perfect, but probably isn&#39;t too far off.</span>
<span class="c1">#                       It is only used when the GMPE(s) don&#39;t provide a</span>
<span class="c1">#                       breakdown of the uncertainty terms. When used,</span>
<span class="c1">#                       this value is multiplied by the total standard</span>
<span class="c1">#                       deviation to get tau. The square of tau is then</span>
<span class="c1">#                       subtracted from the squared total stddev and the</span>
<span class="c1">#                       square root of the result is then used as the</span>
<span class="c1">#                       within-event stddev (phi).</span>
<span class="c1">#</span>
<span class="n">SM_CONSTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default_mmi_stddev&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="s1">&#39;min_mmi_convert&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
    <span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span>
    <span class="s1">&#39;default_stddev_inter_mmi&#39;</span><span class="p">:</span> <span class="mf">0.55</span>
<span class="p">}</span>


<div class="viewcode-block" id="DataFrame"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.DataFrame">[docs]</a><span class="k">class</span> <span class="nc">DataFrame</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span>
        <span class="n">imts</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span></div>


<div class="viewcode-block" id="ModelModule"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule">[docs]</a><span class="k">class</span> <span class="nc">ModelModule</span><span class="p">(</span><span class="n">CoreModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    model -- Interpolate ground motions to a grid or list of locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">command_name</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;products/shake_result\.hdf&#39;</span><span class="p">]</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;shake_data.hdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>

    <span class="n">no_seismic</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">no_macroseismic</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">no_rupture</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_simulations</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">rock_vs30</span> <span class="o">=</span> <span class="mf">760.0</span>
    <span class="n">soil_vs30</span> <span class="o">=</span> <span class="mf">180.0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventid</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">eventid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">eventid</span><span class="p">)</span>

<div class="viewcode-block" id="ModelModule.parseArgs"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule.parseArgs">[docs]</a>    <span class="k">def</span> <span class="nf">parseArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arglist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the object to accept the --no_seismic, --no_macroseismic,</span>
<span class="sd">        and --no_rupture flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">prog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">command_name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--no_seismic&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Exclude instrumental seismic data from &#39;</span>
                            <span class="s1">&#39;the processing, ignoring any that may exist in &#39;</span>
                            <span class="s1">&#39;the input directory.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--no_macroseismic&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Exclude macroseismic data from the &#39;</span>
                            <span class="s1">&#39;processing, ignoring any that may exist in the &#39;</span>
                            <span class="s1">&#39;input directory.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--no_rupture&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Exclude a rupture model from the &#39;</span>
                            <span class="s1">&#39;processing, ignoring any that may exist in the &#39;</span>
                            <span class="s1">&#39;input directory.&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># This line should be in any modules that overrides this</span>
        <span class="c1"># one. It will collect up everything after the current</span>
        <span class="c1"># modules options in args.rem, which should be returned</span>
        <span class="c1"># by this function. Note: doing parser.parse_known_args()</span>
        <span class="c1"># will not work as it will suck up any later modules&#39;</span>
        <span class="c1"># options that are the same as this one&#39;s.</span>
        <span class="c1">#</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;rem&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">arglist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_seismic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_seismic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_macroseismic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_macroseismic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_rupture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_rupture</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">rem</span></div>

<div class="viewcode-block" id="ModelModule.execute"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate ground motions to a grid or list of locations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotADirectoryError: When the event data directory does not exist.</span>
<span class="sd">            FileNotFoundError: When the the shake_data HDF file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting model...&#39;</span><span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Make the input container and extract the config</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setInputContainer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getConfig</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getArrays</span><span class="p">()</span>
                              <span class="k">if</span> <span class="s1">&#39;simulations&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_simulations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Clear away results from previous runs</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clearProducts</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Retrieve a bunch of config options and set them as attributes</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setConfigOptions</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Instantiate the gmpe, gmice, and ipe</span>
        <span class="c1"># Here we make a placeholder gmpe so that we can make the</span>
        <span class="c1"># rupture and distance contexts; later we&#39;ll make the</span>
        <span class="c1"># IMT-specific gmpes</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s1">&#39;gmice&#39;</span><span class="p">,</span> <span class="s1">&#39;modeling&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ipe_modules&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> \
                <span class="s1">&#39;VirtualIPE&#39;</span><span class="p">:</span>
            <span class="n">pgv_imt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">)</span>
            <span class="n">ipe_gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">pgv_imt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span> <span class="o">=</span> <span class="n">VirtualIPE</span><span class="o">.</span><span class="n">fromFuncs</span><span class="p">(</span><span class="n">ipe_gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ipe</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s1">&#39;ipe&#39;</span><span class="p">,</span> <span class="s1">&#39;modeling&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;vs30&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ipe</span><span class="o">.</span><span class="n">REQUIRES_SITES_PARAMETERS</span><span class="p">:</span>
                <span class="c1"># REQUIRES_SITES_PARAMETERS is now a frozen set so we have to</span>
                <span class="c1"># work around it</span>
                <span class="n">tmpset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ipe</span><span class="o">.</span><span class="n">REQUIRES_SITES_PARAMETERS</span><span class="p">)</span>
                <span class="n">tmpset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;vs30&#39;</span><span class="p">)</span>
                <span class="n">ipe</span><span class="o">.</span><span class="n">REQUIRES_SITES_PARAMETERS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">tmpset</span><span class="p">)</span>
            <span class="n">ipe</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_COMPONENT</span> <span class="o">=</span> \
                <span class="n">oqconst</span><span class="o">.</span><span class="n">IMC</span><span class="o">.</span><span class="n">GREATER_OF_TWO_HORIZONTAL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span><span class="n">ipe</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>

        <span class="n">ipe_sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span><span class="o">.</span><span class="n">DEFINED_FOR_STANDARD_DEVIATION_TYPES</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipe_sd_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">,</span>
                                     <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTER_EVENT</span><span class="p">,</span>
                                     <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTRA_EVENT</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Get the rupture object and rupture context</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getRuptureObject</span><span class="p">()</span>
        <span class="c1"># If the --no_rupture flag is used, switch to a PointRupture</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_rupture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span> <span class="o">=</span> <span class="n">PointRupture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;mechanism&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">setMechanism</span><span class="p">(</span>
                <span class="n">mech</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;mechanism&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">getRuptureContext</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">])</span>
        <span class="c1"># TODO: figure out how to not have to do this</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">rake</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">rake</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#</span>
        <span class="c1"># Set up the coordinates for the attenuation curves</span>
        <span class="c1">#</span>
        <span class="n">repi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">getHypo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;lons&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">repi</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
            <span class="s1">&#39;lats&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">111.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">repi</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_source</span> <span class="o">=</span> <span class="n">PointRupture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># The output locations: either a grid or a list of points</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting output params...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setOutputParams</span><span class="p">()</span>

        <span class="n">landmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLandMask</span><span class="p">()</span>
        <span class="c1"># We used to do this, but we&#39;ve decided not to. Leaving the code</span>
        <span class="c1"># in place in case we change our minds.</span>
        <span class="c1"># if landmask is not None and np.all(landmask):</span>
        <span class="c1">#     raise TerminateShakeMap(&quot;Mapped area is entirely water&quot;)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># If the gmpe doesn&#39;t break down its stardard deviation into</span>
        <span class="c1"># within- and between-event terms, we need to handle things</span>
        <span class="c1"># somewhat differently.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">gmpe_sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="o">.</span><span class="n">DEFINED_FOR_STANDARD_DEVIATION_TYPES</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmpe_sd_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">,</span>
                                      <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTER_EVENT</span><span class="p">,</span>
                                      <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTRA_EVENT</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Are we going to include directivity?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Config option?</span>
        <span class="n">dir_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;directivity&#39;</span><span class="p">]</span>

        <span class="c1"># Is the rupture not a point source?</span>
        <span class="n">rup_check</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dir_conf</span> <span class="ow">and</span> <span class="n">rup_check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># The following attribute will be used to store a list of tuples,</span>
            <span class="c1"># where each tuple will contain the 1) result of the directivity</span>
            <span class="c1"># model (for the periods defined by Rowshandel2013) and 2) the</span>
            <span class="c1"># associated distance context. The distance context is needed</span>
            <span class="c1"># within the _gmas function for figuring out which of the results</span>
            <span class="c1"># should be used when combining it with the GMPE result. We store</span>
            <span class="c1"># the pre-defined period first and interpolate later because there</span>
            <span class="c1"># is some optimization to doing it this way (some of the</span>
            <span class="c1"># calculation is period independent).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># But if we want to save the results that were actually used for</span>
            <span class="c1"># each IMT, so we use a dictionary. This uses keys that are</span>
            <span class="c1"># the same ass self.outgrid.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Station data: Create DataFrame(s) with the input data:</span>
        <span class="c1"># df1 for instrumented data</span>
        <span class="c1"># df2 for non-instrumented data</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting data frames...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDataFrames</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the predictions, etc. to the data frames</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Populating data frames...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populateDataFrames</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Try to make all the derived IMTs possible from MMI (if we have MMI)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deriveIMTsFromMMI</span><span class="p">()</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deriveMMIFromIMTs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting combined IMTs&#39;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Get the combined set of input and output IMTs, their periods,</span>
        <span class="c1"># and an index dictionary, then make the cross-correlation function</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Ignore what is in the configuration and make maps only for the</span>
            <span class="c1"># IMTs that are in the set of simulations (and MMI).</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span><span class="p">:</span>
                <span class="n">dset</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getArray</span><span class="p">([</span><span class="s1">&#39;simulations&#39;</span><span class="p">],</span> <span class="n">imtstr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;MMI&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">|=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">imts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imt_per</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span> <span class="o">=</span> <span class="n">_get_period_arrays</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s1">&#39;ccf&#39;</span><span class="p">,</span> <span class="s1">&#39;modeling&#39;</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Doing bias&#39;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Do the bias for all of the input and output IMTs. Hold on</span>
        <span class="c1"># to some of the products that will be used for the interpolation.</span>
        <span class="c1"># The &quot;raw&quot; values are the stddevs that have not been inflated by</span>
        <span class="c1"># the additional sigma (if any) of the point-source to finite</span>
        <span class="c1"># rupture approximation.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># The numerator term of the bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># The denominator of the bias (w/o the tau term)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># raw phi (intra-event stddev) of the output points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psd</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c1"># phi (intra-event stddev) of the output points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c1"># tau (inter-event stddev) of the output points</span>

        <span class="c1">#</span>
        <span class="c1"># These are arrays (keyed by IMT) of the station data that will be</span>
        <span class="c1"># used to compute the bias and do the interpolation, they are filled</span>
        <span class="c1"># in the _fillDataArrays method</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_period_ix</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_total</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_tau</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_imtstr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_rrups</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fillDataArrays</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_computeBias</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_computeDirectivityPredictionLocations</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Now do the MVN with the intra-event residuals</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># Holds the interpolated output arrays keyed by IMT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># Holds the standard deviation arrays keyed by IMT</span>

        <span class="c1">#</span>
        <span class="c1"># Places to put the results for the attenuation plots</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_mean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_sd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_sd</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Doing MVN...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_computeMVN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">)</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>  <span class="c1"># Check threads for possible exceptions, etc.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">imt_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_computeMVN</span><span class="p">(</span><span class="n">imt_str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_applyCustomMask</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Output the data and metadata</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">product_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">product_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">product_path</span><span class="p">)</span>
        <span class="n">oc</span> <span class="o">=</span> <span class="n">ShakeMapOutputContainer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">product_path</span><span class="p">,</span> <span class="s1">&#39;shake_result.hdf&#39;</span><span class="p">))</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Might as well stick the whole config in the result</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># We&#39;re going to need masked arrays of the output grids later, so</span>
        <span class="c1"># make them now.</span>
        <span class="c1">#</span>
        <span class="n">moutgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMaskedGrids</span><span class="p">(</span><span class="n">landmask</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Get the info dictionary that will become info.json, and</span>
        <span class="c1"># store it in the output container</span>
        <span class="c1">#</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInfo</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">)</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the rupture JSON as a text string</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setRuptureDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_geojson</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Fill the station dictionary for stationlist.json and add it to</span>
        <span class="c1"># the output container</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">sjdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillStationJSON</span><span class="p">()</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setStationDict</span><span class="p">(</span><span class="n">sjdict</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the output grids or points to the output; include some</span>
        <span class="c1"># metadata.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storeGriddedData</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storePointData</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_storeAttenuationData</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>

        <span class="n">oc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">addFile</span><span class="p">(</span><span class="s1">&#39;shakemapHDF&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Comprehensive ShakeMap HDF Data File&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;HDF file containing all ShakeMap results.&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;shake_result.hdf&#39;</span><span class="p">,</span> <span class="s1">&#39;application/x-bag&#39;</span><span class="p">)</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># End execute()</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_setInputContainer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the input container and set</span>
<span class="sd">        the event&#39;s current data directory.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotADirectoryError: When the event data directory does not exist.</span>
<span class="sd">            FileNotFoundError: When the the shake_data HDF file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Find the shake_data.hdf file</span>
        <span class="c1">#</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">data_path</span> <span class="o">=</span> <span class="n">get_config_paths</span><span class="p">()</span>
        <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid directory.&#39;</span> <span class="o">%</span> <span class="n">datadir</span><span class="p">)</span>

        <span class="n">datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;shake_data.hdf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">datafile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ic</span> <span class="o">=</span> <span class="n">ShakeMapInputContainer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clearProducts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to delete an event&#39;s products directory if it exists.</span>

<span class="sd">        Returns:</span>
<span class="sd">            nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">products_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">products_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">products_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pdl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;pdl&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pdl_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">pdl_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setConfigOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull various useful configuration options out of the config</span>
<span class="sd">        dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Processing parameters</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;max_workers&#39;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Do we apply the generic amplification factors?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;apply_generic_amp_factors&#39;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Bias parameters</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;do_bias&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;max_range&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;max_mag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_dsigma</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;max_delta_sigma&#39;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Outlier parameters</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_outliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;outlier&#39;</span><span class="p">][</span><span class="s1">&#39;do_outliers&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_deviation_level</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;outlier&#39;</span><span class="p">][</span><span class="s1">&#39;max_deviation&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_max_mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;outlier&#39;</span><span class="p">][</span><span class="s1">&#39;max_mag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_valid_stations</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;outlier&#39;</span><span class="p">][</span><span class="s1">&#39;valid_stations&#39;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># These are the IMTs we want to make</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;imt_list&#39;</span><span class="p">])</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># The x and y resolution of the output grid</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;xres&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;yres&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;nmax&#39;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Get the Vs30 file name</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;vs30default&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;vs30file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;maskfile&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_setOutputParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set variables dealing with the output grid or points</span>

<span class="sd">        Returns:</span>
<span class="sd">            nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">imt_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">imt_grp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">myimt</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">geodict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getArray</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">myimt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span>
                <span class="n">defaultVs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">,</span>
                <span class="n">vs30File</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getNxNy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">()</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="o">.</span><span class="n">fromSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="ow">and</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
            <span class="c1">#</span>
            <span class="c1"># FILE: Open the file and get the output points</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">in_sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">],</span>
                <span class="n">autostrip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="s1">&#39;&lt;U80&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">in_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Points file is empty; nothing to do&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">in_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="n">idents</span> <span class="o">=</span> <span class="n">in_sites</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idents</span> <span class="o">=</span> <span class="p">[</span><span class="n">idents</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">in_sites</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vs30</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smny</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span>
                <span class="n">defaultVs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">,</span>
                <span class="n">vs30File</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;lats&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span>
                 <span class="s1">&#39;lons&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># Replace the Vs30 from the grid (or default) with the Vs30</span>
            <span class="c1"># provided with the site list.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># GRID: Figure out the grid parameters and get output points</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;extent&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;extent&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">get_extent</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span>
                <span class="p">)</span>

            <span class="c1"># Adjust resolution to be under nmax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_adjustResolution</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span>
                <span class="n">defaultVs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">,</span>
                <span class="n">vs30File</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getNxNy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">()</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="o">.</span><span class="n">fromSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># TODO: This will break if the IPE needs distance measures</span>
        <span class="c1"># that the GMPE doesn&#39;t; should make this a union of the</span>
        <span class="c1"># requirements of both</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span> <span class="o">=</span> <span class="n">dist_obj_out</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Set up the sites and distance contexts for the attenuation curves</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">,</span> <span class="n">rock_vs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rock_vs30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">,</span> <span class="n">rock_vs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">soil_vs30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s1">&#39;lons&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s1">&#39;lats&#39;</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s1">&#39;lons&#39;</span><span class="p">]),</span>
            <span class="n">rupture</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">point_source</span><span class="p">)</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lats_out_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">def</span> <span class="nf">_setDataFrames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the StationList object from the input container and</span>
<span class="sd">        fill the DataFrame class and keep a list of dataframes.</span>

<span class="sd">            - df1 holds the instrumented data (PGA, PGV, SA)</span>
<span class="sd">            - df2 holds the non-instrumented data (MMI)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getStationList</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">dfid</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;df1&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;df2&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">dfid</span> <span class="o">==</span> <span class="s1">&#39;df1&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_seismic</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">dfid</span> <span class="o">==</span> <span class="s1">&#39;df2&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_macroseismic</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sdf</span><span class="p">,</span> <span class="n">imts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">getStationDictionary</span><span class="p">(</span><span class="n">instrumented</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
                <span class="n">df</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">sdf</span>
                <span class="n">df</span><span class="o">.</span><span class="n">imts</span> <span class="o">=</span> <span class="n">imts</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfid</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfid</span><span class="p">)</span>

        <span class="c1"># Flag the stations in the bad stations list from the config</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;df1&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">evdt</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">nostart</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;bad_stations&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">dates</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;bad_stations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ondate</span><span class="p">,</span> <span class="n">offdate</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ondate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
            <span class="n">ondt</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offdate</span><span class="p">:</span>
                <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">offdate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
                <span class="n">offdt</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offdt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ondt</span> <span class="o">==</span> <span class="n">nostart</span> <span class="ow">or</span> <span class="n">ondt</span> <span class="o">&lt;=</span> <span class="n">evdt</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="n">offdt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">offdt</span> <span class="o">&gt;=</span> <span class="n">evdt</span><span class="p">):</span>
                <span class="n">bad</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_populateDataFrames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the sites and distance contexts for each dataframe then</span>
<span class="sd">        compute the predictions for the IMTs in that dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dfid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">dfn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfid</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dfn</span><span class="o">.</span><span class="n">df</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Get the sites and distance contexts</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
            <span class="n">lldict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;lons&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span>
                <span class="s1">&#39;lats&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span><span class="n">lldict</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_rock</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_rock</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="o">.</span><span class="n">vs30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rock_vs30</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_soil</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_soil</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="o">.</span><span class="n">vs30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil_vs30</span><span class="p">)</span>
            <span class="n">dist_obj</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
            <span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">dist_obj</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>

            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Are we doing directivity?</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Directivity for </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">dfid</span><span class="p">)</span>
                <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">dir_df</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">T</span><span class="o">=</span><span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">(),</span>
                    <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dir_df</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">))</span>
                <span class="n">directivity_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Directivity </span><span class="si">%s</span><span class="s1"> evaluation time: </span><span class="si">%f</span><span class="s1"> sec&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">dfid</span><span class="p">,</span> <span class="n">directivity_time</span><span class="p">))</span>

            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Do the predictions and other bookkeeping for each IMT</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">dfn</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
                <span class="n">gmpe</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                                     <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">&quot;Input IMT </span><span class="si">%s</span><span class="s2"> not supported by GMPE: ignoring&quot;</span> <span class="o">%</span>
                            <span class="n">imtstr</span><span class="p">)</span>
                        <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">not_supported</span><span class="p">:</span>
                    <span class="n">pmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pmean_rock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pmean_soil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span>
                    <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span>
                    <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
                    <span class="n">pmean_rock</span><span class="p">,</span> <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">sx_rock</span><span class="p">,</span>
                                                          <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
                    <span class="n">pmean_soil</span><span class="p">,</span> <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">sx_soil</span><span class="p">,</span>
                                                          <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_rock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_rock</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma_rock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_soil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_soil</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma_soil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter_mmi&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">total_only</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># Compute the total residual</span>
                <span class="c1">#</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># Do the outlier flagging if we have a fault, or we don&#39;t</span>
                <span class="c1"># have a fault but the event magnitude is under the limit</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_outliers</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span> <span class="ow">or</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlier_max_mag</span><span class="p">):</span>
                    <span class="c1">#</span>
                    <span class="c1"># Make a boolean array of stations that have been</span>
                    <span class="c1"># manually rehabilitated by the operator</span>
                    <span class="c1">#</span>
                    <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">valid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlier_valid_stations</span><span class="p">:</span>
                        <span class="n">is_valid</span> <span class="o">|=</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="c1"># turn off nan warnings for this statement</span>
                    <span class="c1">#</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">flagged</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">])</span> <span class="o">&gt;</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">outlier_deviation_level</span> <span class="o">*</span>
                               <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">is_valid</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="c1"># Add NaN values to the list of outliers</span>
                    <span class="c1">#</span>
                    <span class="n">flagged</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;IMT: </span><span class="si">%s</span><span class="s1">, flagged: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flagged</span><span class="p">)))</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagged</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="c1"># Not doing outliers, but should still flag NaNs</span>
                    <span class="c1">#</span>
                    <span class="n">flagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">])</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagged</span>
                <span class="c1">#</span>
                <span class="c1"># If uncertainty hasn&#39;t been set for MMI, give it</span>
                <span class="c1"># the default value</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_mmi_stddev&#39;</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1"># Get the lons/lats in radians while we&#39;re at it</span>
            <span class="c1">#</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon_rad&#39;</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon_rad&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="c1">#</span>
            <span class="c1"># It will be handy later on to have the rupture distance</span>
            <span class="c1"># in the dataframes</span>
            <span class="c1">#</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">([</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span>
                              <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;rrup_var&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rrup_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;rrup_var&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rrup_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_deriveIMTsFromMMI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute all the IMTs possible from MMI</span>
<span class="sd">        TODO: This logic needs to be revisited. We should probably make what</span>
<span class="sd">        we have to to do the CMS to make the needed output IMTs, but</span>
<span class="sd">        for now, we&#39;re just going to use what we have and the ccf.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;df2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span>
        <span class="k">for</span> <span class="n">gmice_imt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span> <span class="o">==</span> <span class="n">gmice_imt</span><span class="p">:</span>
                <span class="n">iterlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterlist</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">iterlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">period</span><span class="p">:</span>
                    <span class="n">oqimt</span> <span class="o">=</span> <span class="n">gmice_imt</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oqimt</span> <span class="o">=</span> <span class="n">gmice_imt</span><span class="p">()</span>
                <span class="n">imtstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)</span>

                <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getGMfromMI</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span>
                                                        <span class="n">dists</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span>
                                                        <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;min_mmi_convert&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getMI2GMsd</span><span class="p">()[</span><span class="n">oqimt</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">imts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Get the predictions and stddevs</span>
                <span class="c1">#</span>
                <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Input IMT </span><span class="si">%s</span><span class="s2"> not supported by GMPE: ignoring&quot;</span> <span class="o">%</span>
                        <span class="n">imtstr</span><span class="p">)</span>
                    <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">not_supported</span><span class="p">:</span>
                    <span class="n">pmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
                    <span class="n">pmean_rock</span><span class="p">,</span> <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">sx_rock</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
                    <span class="n">pmean_soil</span><span class="p">,</span> <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">sx_soil</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_rock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_rock</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma_rock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_soil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_soil</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma_soil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter_mmi&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">total_only</span><span class="p">:</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmean</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">])</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_deriveMMIFromIMTs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make derived MMI from each of the IMTs in the input (for</span>
<span class="sd">        which the GMICE is defined; then select the best MMI for</span>
<span class="sd">        each station based on a list of &quot;preferred&quot; IMTs; also</span>
<span class="sd">        calculate the predicted MMI and the residual.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;df1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span>
        <span class="n">gmice_imts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span>
        <span class="n">gmice_pers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getPreferredMI</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">dists</span><span class="o">=</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span>
                                               <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getPreferredSD</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
            <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oqimt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gmice_imts</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oqimt</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="n">oqimt</span><span class="o">.</span><span class="n">period</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gmice_pers</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;derived_MMI_from_&#39;</span> <span class="o">+</span> <span class="n">imtstr</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getMIfromGM</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span>
                                       <span class="n">dists</span><span class="o">=</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span>
                                       <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;derived_MMI_from_&#39;</span> <span class="o">+</span> <span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getGM2MIsd</span><span class="p">()[</span><span class="n">oqimt</span><span class="p">])</span>

        <span class="n">preferred_imts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="s1">&#39;PGA&#39;</span><span class="p">,</span> <span class="s1">&#39;SA(1.0)&#39;</span><span class="p">,</span> <span class="s1">&#39;SA(0.3)&#39;</span><span class="p">,</span> <span class="s1">&#39;SA(3.0&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">preferred_imts</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;derived_MMI_from_&#39;</span> <span class="o">+</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">df1</span><span class="p">:</span>
                <span class="n">ixx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">])</span> \
                    <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;derived_MMI_from_&#39;</span> <span class="o">+</span> <span class="n">imtstr</span><span class="p">])</span>
                        <span class="o">|</span> <span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">])</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;derived_MMI_from_&#39;</span> <span class="o">+</span> <span class="n">imtstr</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;derived_MMI_from_&#39;</span> <span class="o">+</span> <span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">imts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Get the prediction and stddevs</span>
        <span class="c1">#</span>
        <span class="n">gmpe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
        <span class="n">pmean_rock</span><span class="p">,</span> <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">sx_rock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
        <span class="n">pmean_soil</span><span class="p">,</span> <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">sx_soil</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_rock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_rock</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma_rock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_soil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_soil</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma_soil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span><span class="p">:</span>
            <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter_mmi&#39;</span><span class="p">]</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmean</span>
        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_fillDataArrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each IMT get lists of the amplitudes that can contribute</span>
<span class="sd">        to the bias and the interpolation. Keep lists of, IMT, period</span>
<span class="sd">        index, lons, lats, residuals, tau, phi, additional uncertainty,</span>
<span class="sd">        and rupture distance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Get the valid imts for each station</span>
        <span class="c1">#</span>
        <span class="n">imtsets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">imtsets</span><span class="p">[</span><span class="n">ndf</span><span class="p">],</span> <span class="n">sasets</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_imt_lists</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Fill the station arrays; here we use lists and append to</span>
            <span class="c1"># them because it is much faster than appending to a numpy</span>
            <span class="c1"># array; after the loop, the lists are converted to numpy</span>
            <span class="c1"># arrays:</span>
            <span class="c1">#</span>
            <span class="n">imtlist</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># The input IMT</span>
            <span class="n">period_ix</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># The index of the (pseudo-)period of the input IMT</span>
            <span class="n">lons_rad</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># longitude (in radians) of the input station</span>
            <span class="n">lats_rad</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># latitude (in radians) of the input station</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># The residual of the input IMT</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="p">[]</span>        <span class="c1"># The between-event stddev of the input IMT</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="p">[]</span>        <span class="c1"># The within-event stddev of the input IMT</span>
            <span class="n">sig_extra</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Additional stddev of the input IMT</span>
            <span class="n">rrups</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># The rupture distance of the input station</span>
            <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
                <span class="n">sdf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])):</span>
                    <span class="c1">#</span>
                    <span class="c1"># Each station can provide 0, 1, or 2 IMTs:</span>
                    <span class="c1">#</span>
                    <span class="k">for</span> <span class="n">imtin</span> <span class="ow">in</span> <span class="n">_get_nearest_imts</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">imtsets</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                                   <span class="n">sasets</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">imtlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imtin</span><span class="p">)</span>
                        <span class="n">period_ix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtin</span><span class="p">])</span>
                        <span class="n">lons_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;lon_rad&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">lats_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;lat_rad&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">resids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">tau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">phi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">sig_extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">rrups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_imtstr</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">imtlist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">period_ix</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons_rad</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> \
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig_extra</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_total</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_rrups</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rrups</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_computeBias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a bias for all of the IMTs in the inputs and outputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span><span class="p">:</span>
            <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">continue</span>
            <span class="c1">#</span>
            <span class="c1"># Get the index of the (pseudo-) period of the output IMT</span>
            <span class="c1">#</span>
            <span class="n">outperiod_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1"># Get the distance-limited set of data for use in computing</span>
            <span class="c1"># the bias</span>
            <span class="c1">#</span>
            <span class="n">dix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_rrups</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_range</span>
            <span class="n">sta_phi_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dix</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_tau_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dix</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_sig_total_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_total</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dix</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_lons_rad_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dix</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">sta_lats_rad_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dix</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">sta_period_ix_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dix</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_resids_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dix</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad_dl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">continue</span>
            <span class="c1">#</span>
            <span class="c1"># This builds the omega factors to apply to the covariance</span>
            <span class="c1">#</span>
            <span class="n">corr_adj</span> <span class="o">=</span> <span class="n">sta_phi_dl</span> <span class="o">/</span> <span class="n">sta_sig_total_dl</span>
            <span class="n">corr_adj22</span> <span class="o">=</span> <span class="n">corr_adj</span> <span class="o">*</span> <span class="n">corr_adj</span><span class="o">.</span><span class="n">T</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_adj22</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Build the covariance matrix of the residuals</span>
            <span class="c1">#</span>
            <span class="n">nsta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad_dl</span><span class="p">)</span>
            <span class="n">matrix22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="n">nsta</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="n">geodetic_distance_fast</span><span class="p">(</span><span class="n">sta_lons_rad_dl</span><span class="p">,</span>
                                   <span class="n">sta_lats_rad_dl</span><span class="p">,</span>
                                   <span class="n">sta_lons_rad_dl</span><span class="p">,</span>
                                   <span class="n">sta_lats_rad_dl</span><span class="p">,</span> <span class="n">matrix22</span><span class="p">)</span>
            <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsta</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
            <span class="n">t1_22</span> <span class="o">=</span> <span class="n">sta_period_ix_dl</span> <span class="o">*</span> <span class="n">ones</span>
            <span class="n">t2_22</span> <span class="o">=</span> <span class="n">sta_period_ix_dl</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">ones</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_22</span><span class="p">,</span> <span class="n">t2_22</span><span class="p">,</span> <span class="n">matrix22</span><span class="p">)</span>
            <span class="n">sta_phi_dl_flat</span> <span class="o">=</span> <span class="n">sta_phi_dl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">make_sigma_matrix</span><span class="p">(</span><span class="n">matrix22</span><span class="p">,</span> <span class="n">corr_adj22</span><span class="p">,</span>
                              <span class="n">sta_phi_dl_flat</span><span class="p">,</span>
                              <span class="n">sta_phi_dl_flat</span><span class="p">)</span>
            <span class="n">sigma22inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">matrix22</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Compute the bias numerator and denominator pieces</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_bias</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span>
                                 <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_mag</span><span class="p">):</span>
                <span class="c1">#</span>
                <span class="c1"># Get the correlation between the inputs and outputs</span>
                <span class="c1">#</span>
                <span class="n">out_ix_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">sta_period_ix_dl</span><span class="p">,</span> <span class="n">outperiod_ix</span><span class="p">)</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">out_ix_arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">sta_period_ix_dl</span><span class="p">,</span> <span class="n">out_ix_arr</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Scale the correlation factor (Z) by the correlation</span>
                <span class="c1"># adjustment due to observational uncertainty</span>
                <span class="c1">#</span>
                <span class="n">Z</span> <span class="o">*=</span> <span class="n">corr_adj</span>
                <span class="c1">#</span>
                <span class="c1"># Compute the bias denominator and numerator terms</span>
                <span class="c1">#</span>
                <span class="n">ztmp</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma22inv</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ztmp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span> <span class="o">*</span> <span class="n">sta_resids_dl</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ztmp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">nom_tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sta_tau_dl</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">nom_variance</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">nom_tau</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">nom_variance</span>
            <span class="n">bias_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
            <span class="c1">#</span>
            <span class="c1"># Write the nominal values of the bias and its stddev to log</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: nom bias </span><span class="si">%f</span><span class="s1"> nom stddev </span><span class="si">%f</span><span class="s1">; </span><span class="si">%d</span><span class="s1"> stations (time=</span><span class="si">%f</span><span class="s1"> sec)&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nom_variance</span><span class="p">),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad_dl</span><span class="p">),</span> <span class="n">bias_time</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_computeDirectivityPredictionLocations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figure out if we need the directivity factors, and if so, pre-calculate</span>
<span class="sd">        them. These will be used later in _computeMVN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Directivity for prediction locations...&#39;</span><span class="p">)</span>
            <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Precompute directivity at all periods</span>
            <span class="n">dir_out</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">),</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">T</span><span class="o">=</span><span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">(),</span>
                <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dir_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">))</span>
            <span class="c1"># Precompute directivity for the attenuation curves</span>
            <span class="n">dir_out</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s1">&#39;lats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s1">&#39;lons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s1">&#39;lats&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">T</span><span class="o">=</span><span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">(),</span>
                <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dir_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">))</span>
            <span class="n">directivity_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Directivity prediction evaluation time: </span><span class="si">%f</span><span class="s1"> sec&#39;</span>
                <span class="o">%</span> <span class="n">directivity_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directivity</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_computeMVN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do the MVN computations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;computeMVN: doing IMT </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">imtstr</span><span class="p">)</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Get the index of the (pesudo-) period of the output IMT</span>
        <span class="c1">#</span>
        <span class="n">outperiod_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Get the predictions at the output points</span>
        <span class="c1">#</span>
        <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
            <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gmpe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span>

        <span class="n">pout_mean</span><span class="p">,</span> <span class="n">pout_sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                <span class="n">pout_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getPreferredMI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span><span class="p">,</span>
                                                      <span class="n">dists</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="o">.</span><span class="n">rrup</span><span class="p">,</span>
                                                      <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pout_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># While we have the gmpe for this IMT, we should make</span>
        <span class="c1"># the attenuation curves</span>
        <span class="c1">#</span>
        <span class="n">x_mean</span><span class="p">,</span> <span class="n">x_sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_rock</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">,</span>
                                  <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_mean</span><span class="p">,</span> <span class="n">x_sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span><span class="n">gmpe</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_soil</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">,</span>
                                  <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># If there are no data, just use the unbiased prediction</span>
        <span class="c1"># and the total stddev</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_mean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c1">#</span>
        <span class="c1"># Get an array of the within-event standard deviations for the</span>
        <span class="c1"># output IMT at the output points</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
            <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span>
            <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span>
            <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter_mmi&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">total_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pout_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pout_sd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Bias the predictions, and add the residual variance to</span>
        <span class="c1"># phi</span>
        <span class="c1">#</span>
        <span class="n">out_bias_var</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
        <span class="n">out_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">out_bias_var</span>
        <span class="n">pout_mean</span> <span class="o">+=</span> <span class="n">out_bias</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pout_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">out_bias_var</span><span class="p">)</span>
        <span class="n">pout_sd2</span> <span class="o">+=</span> <span class="n">out_bias_var</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pout_sd2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">out_bias_var</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pout_sd2</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1">#</span>
        <span class="c1"># Unbias the station residuals and compute the</span>
        <span class="c1"># new phi that includes the variance of the bias</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])):</span>
            <span class="n">imtin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_imtstr</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">in_bias_var</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">imtin</span><span class="p">])</span>
            <span class="n">in_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">imtin</span><span class="p">]</span> <span class="o">*</span> <span class="n">in_bias_var</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">in_bias</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">in_bias_var</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Update the omega factors to account for the bias and the</span>
        <span class="c1"># new value of phi</span>
        <span class="c1">#</span>
        <span class="n">corr_adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">corr_adj22</span> <span class="o">=</span> <span class="n">corr_adj</span> <span class="o">*</span> <span class="n">corr_adj</span><span class="o">.</span><span class="n">T</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_adj22</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">sta_lons_rad_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">sta_lats_rad_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Re-build the covariance matrix of the residuals with</span>
        <span class="c1"># the full set of data</span>
        <span class="c1">#</span>
        <span class="n">nsta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad_flat</span><span class="p">)</span>
        <span class="n">matrix22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="n">nsta</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">geodetic_distance_fast</span><span class="p">(</span><span class="n">sta_lons_rad_flat</span><span class="p">,</span>
                               <span class="n">sta_lats_rad_flat</span><span class="p">,</span>
                               <span class="n">sta_lons_rad_flat</span><span class="p">,</span>
                               <span class="n">sta_lats_rad_flat</span><span class="p">,</span>
                               <span class="n">matrix22</span><span class="p">)</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsta</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="n">t1_22</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">ones</span>
        <span class="n">t2_22</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">ones</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_22</span><span class="p">,</span> <span class="n">t2_22</span><span class="p">,</span> <span class="n">matrix22</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Rebuild sigma22_inv now that we have updated phi and</span>
        <span class="c1"># the correlation adjustment factors</span>
        <span class="c1">#</span>
        <span class="n">sta_phi_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">make_sigma_matrix</span><span class="p">(</span><span class="n">matrix22</span><span class="p">,</span> <span class="n">corr_adj22</span><span class="p">,</span> <span class="n">sta_phi_flat</span><span class="p">,</span> <span class="n">sta_phi_flat</span><span class="p">)</span>
        <span class="n">sigma22inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">matrix22</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Now do the MVN itself...</span>
        <span class="c1">#</span>
        <span class="n">dtime</span> <span class="o">=</span> <span class="n">mtime</span> <span class="o">=</span> <span class="n">ddtime</span> <span class="o">=</span> <span class="n">ctime</span> <span class="o">=</span> <span class="n">stime</span> <span class="o">=</span> <span class="n">atime</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ampgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">)</span>
        <span class="n">sdgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">)</span>
        <span class="n">corr_adj12</span> <span class="o">=</span> <span class="n">corr_adj</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Stuff that doesn&#39;t change within the loop:</span>
        <span class="n">lons_out_rad_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lats_out_rad_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats_out_rad</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">d12_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
        <span class="n">t2_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">d12_cols</span><span class="p">,</span> <span class="n">nsta</span><span class="p">),</span> <span class="n">outperiod_ix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="n">t1_12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">d12_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                       <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="c1"># sdsta is the standard deviation of the stations</span>
        <span class="n">sdsta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">matrix12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">t2_12</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">rcmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">t2_12</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smny</span><span class="p">):</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
            <span class="n">se</span> <span class="o">=</span> <span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">geodetic_distance_fast</span><span class="p">(</span>
                <span class="n">sta_lons_rad_flat</span><span class="p">,</span>
                <span class="n">sta_lats_rad_flat</span><span class="p">,</span>
                <span class="n">lons_out_rad_flat</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">],</span>
                <span class="n">lats_out_rad_flat</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">],</span>
                <span class="n">matrix12</span><span class="p">)</span>
            <span class="n">ddtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_12</span><span class="p">,</span> <span class="n">t2_12</span><span class="p">,</span> <span class="n">matrix12</span><span class="p">)</span>
            <span class="n">ctime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># sdarr is the standard deviation of the output sites</span>
            <span class="n">sdarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">make_sigma_matrix</span><span class="p">(</span><span class="n">matrix12</span><span class="p">,</span> <span class="n">corr_adj12</span><span class="p">,</span> <span class="n">sdsta</span><span class="p">,</span> <span class="n">sdarr</span><span class="p">)</span>
            <span class="n">stime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># Sigma12 * Sigma22^-1 is known as the &#39;regression</span>
            <span class="c1"># coefficient&#39; matrix (rcmatrix)</span>
            <span class="c1">#</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix12</span><span class="p">,</span> <span class="n">sigma22inv</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">rcmatrix</span><span class="p">)</span>
            <span class="n">dtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1">#</span>
            <span class="c1"># This is the MVN solution for the conditional mean</span>
            <span class="c1">#</span>
            <span class="n">adj_resid</span> <span class="o">=</span> <span class="n">corr_adj</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="n">ampgrid</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                <span class="n">pout_mean</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">rcmatrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">adj_resid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
            <span class="n">atime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># We only want the diagonal elements of the conditional</span>
            <span class="c1"># covariance matrix, so there is no point in doing the</span>
            <span class="c1"># full solution with the dot product, e.g.:</span>
            <span class="c1"># sdgrid[ss:se] = pout_sd2[ss:se] -</span>
            <span class="c1">#       np.diag(rcmatrix.dot(sigma21))</span>
            <span class="c1">#</span>
            <span class="n">make_sd_array</span><span class="p">(</span><span class="n">sdgrid</span><span class="p">,</span> <span class="n">pout_sd2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">rcmatrix</span><span class="p">,</span> <span class="n">matrix12</span><span class="p">)</span>
            <span class="n">mtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>

        <span class="c1">#</span>
        <span class="c1"># This processing can result in MMI values that go beyond</span>
        <span class="c1"># the 1 to 10 bounds of MMI, so we apply that constraint again</span>
        <span class="c1"># here</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
            <span class="n">ampgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ampgrid</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdgrid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> distance=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">ddtime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> correlation=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">ctime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> sigma=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">stime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> rcmatrix=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">dtime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> amp calc=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">atime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> sd calc=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;total time for </span><span class="si">%s</span><span class="s1">=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_applyCustomMask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply custom masks to IMT grid outputs. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">grid</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span> <span class="nf">_getLandMask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the landmask for this map. Land will be False, water will</span>
<span class="sd">        be True (because of the way masked arrays work).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;CALLED_FROM_PYTEST&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">oceans</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oceans</span> <span class="o">=</span> <span class="n">shpreader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="s1">&#39;physical&#39;</span><span class="p">,</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span>
                                             <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMask</span><span class="p">(</span><span class="n">oceans</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a masked array for this map corresponding to the given vector</span>
<span class="sd">        feature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">gd</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="o">.</span><span class="n">createDictFromBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">)</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">gd</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gd</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">tshapes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">))</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tshp</span> <span class="ow">in</span> <span class="n">tshapes</span><span class="p">:</span>
                <span class="n">shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">tshp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">):</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="o">.</span><span class="n">rasterizeFromGeometry</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">gd</span><span class="p">,</span> <span class="n">fillValue</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">grid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gd</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMaskedGrids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bmask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each grid in the output, generate a grid with the water areas</span>
<span class="sd">        masked out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">moutgrid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">imtout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
                <span class="n">moutgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">moutgrid</span>
        <span class="k">for</span> <span class="n">imtout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
            <span class="n">moutgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">bmask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">moutgrid</span>

    <span class="k">def</span> <span class="nf">_getInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moutgrid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an info dictionary that can be made into the info.json file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Get the map grade</span>
        <span class="c1">#</span>
        <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span> <span class="o">=</span> <span class="n">_get_map_grade</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">,</span> <span class="n">moutgrid</span><span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># This is the metadata for creating info.json</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;strec&#39;</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;input&#39;</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="s1">&#39;event_information&#39;</span>
        <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="s1">&#39;ground_motions&#39;</span>
        <span class="n">mi</span> <span class="o">=</span> <span class="s1">&#39;map_information&#39;</span>
        <span class="n">un</span> <span class="o">=</span> <span class="s1">&#39;uncertainty&#39;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="s1">&#39;processing&#39;</span>
        <span class="n">gmm</span> <span class="o">=</span> <span class="s1">&#39;ground_motion_modules&#39;</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="s1">&#39;miscellaneous&#39;</span>
        <span class="n">sv</span> <span class="o">=</span> <span class="s1">&#39;shakemap_versions&#39;</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="s1">&#39;site_response&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_depth</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span>

        <span class="c1"># look for the presence of a strec_results file and read it in</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">data_path</span> <span class="o">=</span> <span class="n">get_config_paths</span><span class="p">()</span>
        <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">)</span>
        <span class="n">strecfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;strec_results.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">strecfile</span><span class="p">):</span>
            <span class="n">strec_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">strecfile</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">))</span>
            <span class="n">info</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">strec_results</span>

        <span class="c1"># the following items are primarily useful for PDL</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;eventsource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">netid</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;netid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">netid</span>
        <span class="c1"># The netid could be a valid part of the eventsourcecode, so we have</span>
        <span class="c1"># to check here if it ***starts with*** the netid</span>
        <span class="k">if</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">netid</span><span class="p">):</span>
            <span class="n">eventsourcecode</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">netid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eventsourcecode</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;eventsourcecode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventsourcecode</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;productcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">productcode</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;productsource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;source_network&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;producttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;product_type&#39;</span><span class="p">]</span>

        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;fault_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">getReference</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;df2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;intensity_observations&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;intensity_observations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lat</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lon</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">locstring</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;magnitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;origin_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TIMEFMT</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;df1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;seismic_stations&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;seismic_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;src_mech&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">mech</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;source_description&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_description&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;source_description&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">locstring</span>
        <span class="c1"># This AND src_mech?</span>
        <span class="c1"># look at the origin information for indications that this</span>
        <span class="c1"># event is a scenario</span>
        <span class="n">condition1</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;event_type&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">origin</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;scenario&#39;</span>
        <span class="n">condition2</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_se&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">condition1</span> <span class="ow">or</span> <span class="n">condition2</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SCENARIO&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ACTUAL&#39;</span>

        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
            <span class="k">elif</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;PGV&#39;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;cms&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="k">if</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">myimt</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">or</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;PGV&#39;</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;max_grid&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_string_round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_string_round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;max_grid&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_string_round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">])),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_string_round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">])),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smny</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="mf">360.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">min_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="n">max_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the negative side</span>
                <span class="n">min_long</span> <span class="o">=</span> <span class="n">min_long</span> <span class="o">-</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_long</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the positive side</span>
                <span class="n">max_long</span> <span class="o">=</span> <span class="n">max_long</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="n">min_long</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="n">max_long</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mygrade</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;mean_uncertainty_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="n">mean_rat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;df2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;total_flagged_mi&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">]</span> <span class="o">|</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;total_flagged_mi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;df1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">all_flagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">in</span> <span class="n">imtstr</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">all_flagged</span> <span class="o">|=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">|</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="n">all_flagged</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">]</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;total_flagged_pgm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_flagged</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;total_flagged_pgm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ipe_modules&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gmice_modules&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ccf_modules&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;basin_correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;basin_correction&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;basin_correction&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;directivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;directivity&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;directivity&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;bias_max_dsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_max_dsigma</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;bias_max_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_max_mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;bias_max_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_max_range</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;median_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;do_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_outliers</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;outlier_deviation_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outlier_deviation_level</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;outlier_max_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outlier_max_mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;shakemap_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_versions</span><span class="p">()[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;shakemap_revision_id&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">get_versions</span><span class="p">()[</span><span class="s1">&#39;full-revisionid&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;process_time&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">strftime</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ALT_TIMEFMT</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">())</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;map_version&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s1">&#39;history&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;map_comment&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s1">&#39;history&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;map_data_history&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;map_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;map_status&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">][</span><span class="s1">&#39;vs30default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">][</span><span class="s1">&#39;site_correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GMPE native&#39;</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">_fillStationJSON</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the station JSON dictionary and then add a bunch of stuff to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stations&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;eventid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">,</span>
                    <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">sjdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Compute a bias for all the IMTs in the data frames</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
            <span class="n">imts</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">imts</span>
            <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="n">imts</span><span class="p">:</span>
                <span class="n">mybias_var</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> \
                    <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">bias_den</span><span class="p">[</span><span class="n">myimt</span><span class="p">])</span>
                <span class="n">mybias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_num</span><span class="p">[</span><span class="n">myimt</span><span class="p">]</span> <span class="o">*</span> <span class="n">mybias_var</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s1">&#39;_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mybias</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s1">&#39;_bias_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mybias_var</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the station data. The stationlist object has the original</span>
        <span class="c1"># data and produces a GeoJSON object (a dictionary, really), but</span>
        <span class="c1"># we need to add peak values and flagging that has been done here.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1">#</span>
        <span class="c1"># First make a dictionary of distances</span>
        <span class="c1">#</span>
        <span class="n">dist_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">dx</span>
            <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
                <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">dm</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm_arr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rrup&#39;</span><span class="p">,</span> <span class="s1">&#39;rjb&#39;</span><span class="p">):</span>
                    <span class="n">dm_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dm</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dm_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">dm</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm_var</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">dm</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Get the index for each station ID</span>
        <span class="c1">#</span>
        <span class="n">sjdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">getGeoJson</span><span class="p">()</span>
        <span class="n">sta_ix</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
            <span class="n">sta_ix</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))))</span>
        <span class="c1">#</span>
        <span class="c1"># Now go through the GeoJSON and add various properties and</span>
        <span class="c1"># amps from the df_dict dictionaries</span>
        <span class="c1">#</span>
        <span class="n">sjdict_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sjdict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">sjdict_copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]:</span>
                <span class="n">ndf</span> <span class="o">=</span> <span class="s1">&#39;df1&#39;</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;station_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;seismic&#39;</span>
            <span class="k">elif</span> <span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">]:</span>
                <span class="n">ndf</span> <span class="o">=</span> <span class="s1">&#39;df2&#39;</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;station_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;macroseismic&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We&#39;re probably using --no_seismic or --no_macroseismic</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_seismic</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_macroseismic</span><span class="p">:</span>
                    <span class="n">sjdict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown station </span><span class="si">%s</span><span class="s1"> in stationlist&#39;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
            <span class="n">dfx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="n">dfx</span><span class="o">.</span><span class="n">df</span>
            <span class="n">six</span> <span class="o">=</span> <span class="n">sta_ix</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
            <span class="c1">#</span>
            <span class="c1"># Set the &#39;intensity&#39;, &#39;pga&#39;, and &#39;pga&#39; peak properties</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">in</span> <span class="n">sdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]):</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity_stddev&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;MMI_nresp&#39;</span> <span class="ow">in</span> <span class="n">sdf</span><span class="p">:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;nresp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI_nresp&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;nresp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity_stddev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;nresp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">in</span> <span class="n">sdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGA_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGA&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span> \
                    <span class="ow">and</span> <span class="p">(</span><span class="n">ndf</span> <span class="o">!=</span> <span class="s1">&#39;df1&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]):</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pga&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_round_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGA&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">sdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGV_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGV&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span> \
                    <span class="ow">and</span> <span class="p">(</span><span class="n">ndf</span> <span class="o">!=</span> <span class="s1">&#39;df1&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]):</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_round_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGV&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
            <span class="c1">#</span>
            <span class="c1"># Add vs30</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;vs30&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">dfx</span><span class="o">.</span><span class="n">sx</span><span class="o">.</span><span class="n">vs30</span><span class="p">[</span><span class="n">six</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Add the predictions so we can plot residuals</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sdf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_pred&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">myamp</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">myamp_rock</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_rock&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">myamp_soil</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_soil&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">tau_str</span> <span class="o">=</span> <span class="s1">&#39;ln_tau&#39;</span>
                <span class="n">phi_str</span> <span class="o">=</span> <span class="s1">&#39;ln_phi&#39;</span>
                <span class="n">sigma_str</span> <span class="o">=</span> <span class="s1">&#39;ln_sigma&#39;</span>
                <span class="n">sigma_str_rock</span> <span class="o">=</span> <span class="s1">&#39;ln_sigma_rock&#39;</span>
                <span class="n">sigma_str_soil</span> <span class="o">=</span> <span class="s1">&#39;ln_sigma_soil&#39;</span>
                <span class="n">bias_str</span> <span class="o">=</span> <span class="s1">&#39;ln_bias&#39;</span>
                <span class="n">bias_sigma_str</span> <span class="o">=</span> <span class="s1">&#39;ln_bias_sigma&#39;</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span>
                    <span class="n">value_rock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_rock</span><span class="p">)</span>
                    <span class="n">value_soil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_soil</span><span class="p">)</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;cm/s&#39;</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">myamp</span>
                    <span class="n">value_rock</span> <span class="o">=</span> <span class="n">myamp_rock</span>
                    <span class="n">value_soil</span> <span class="o">=</span> <span class="n">myamp_soil</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
                    <span class="n">tau_str</span> <span class="o">=</span> <span class="s1">&#39;tau&#39;</span>
                    <span class="n">phi_str</span> <span class="o">=</span> <span class="s1">&#39;phi&#39;</span>
                    <span class="n">sigma_str</span> <span class="o">=</span> <span class="s1">&#39;sigma&#39;</span>
                    <span class="n">sigma_str_rock</span> <span class="o">=</span> <span class="s1">&#39;sigma_rock&#39;</span>
                    <span class="n">sigma_str_soil</span> <span class="o">=</span> <span class="s1">&#39;sigma_soil&#39;</span>
                    <span class="n">bias_str</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span>
                    <span class="n">bias_sigma_str</span> <span class="o">=</span> <span class="s1">&#39;bias_sigma&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">value_rock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_rock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">value_soil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_soil</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span><span class="p">:</span>
                    <span class="n">mytau</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mytau</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_tau&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">myphi</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_phi&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">mysigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mytau</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">myphi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">mysigma_rock</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_sigma_rock&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">mysigma_soil</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_sigma_soil&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">imt_name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">mybias</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">imt_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_bias&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">mybias_sigma</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">imt_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_bias_sigma&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">imt_name</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="s1">&#39;value_rock&#39;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value_rock</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="s1">&#39;value_soil&#39;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value_soil</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                    <span class="n">tau_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mytau</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">phi_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">myphi</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">sigma_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysigma</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">sigma_str_rock</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysigma_rock</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">sigma_str_soil</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysigma_soil</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">bias_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mybias</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">bias_sigma_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mybias_sigma</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="c1">#</span>
            <span class="c1"># For df1 stations, add the MMIs comverted from PGM</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">ndf</span> <span class="o">==</span> <span class="s1">&#39;df1&#39;</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;mmi_from_pgm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">dimtstr</span> <span class="o">=</span> <span class="s1">&#39;derived_MMI_from_&#39;</span> <span class="o">+</span> <span class="n">myimt</span>
                    <span class="k">if</span> <span class="n">dimtstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sdf</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">imt_name</span> <span class="o">=</span> <span class="n">myimt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">myamp</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">dimtstr</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">mysd</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">dimtstr</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">myamp</span><span class="p">):</span>
                        <span class="n">myamp</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                        <span class="n">mysd</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;Outlier&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;mmi_from_pgm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">imt_name</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">myamp</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysd</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;flag&#39;</span><span class="p">:</span> <span class="n">flag</span>
                    <span class="p">})</span>

            <span class="c1">#</span>
            <span class="c1"># For df2 stations, add the PGMs converted from MMI</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">ndf</span> <span class="o">==</span> <span class="s1">&#39;df2&#39;</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pgm_from_mmi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">imt_name</span> <span class="o">=</span> <span class="n">myimt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">myamp</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">mysd</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;PGV&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;cm/s&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                        <span class="n">mysd</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;Outlier&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pgm_from_mmi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">imt_name</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                        <span class="s1">&#39;ln_sigma&#39;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysd</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="s1">&#39;flag&#39;</span><span class="p">:</span> <span class="n">flag</span>
                    <span class="p">})</span>
            <span class="c1">#</span>
            <span class="c1"># Set the generic distance property (this is rrup)</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">_round_float</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;distance_stddev&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">_round_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;rrup_var&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Set the specific distances properties</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span> <span class="ow">in</span> <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;distances&#39;</span><span class="p">][</span><span class="n">dm</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">_round_float</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">[</span><span class="n">six</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Set the outlier flags</span>
            <span class="c1">#</span>
            <span class="n">mflag</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="k">if</span> <span class="n">ndf</span> <span class="o">==</span> <span class="s1">&#39;df1&#39;</span> <span class="ow">and</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                <span class="n">mflag</span> <span class="o">=</span> <span class="s1">&#39;ManuallyFlagged&#39;</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">amp</span> <span class="ow">in</span> <span class="n">channel</span><span class="p">[</span><span class="s1">&#39;amplitudes&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                        <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">mflag</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mflag</span>
                    <span class="n">Name</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">sdf</span><span class="p">[</span><span class="n">Name</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                            <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Outlier&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,Outlier&#39;</span>
        <span class="n">sjdict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eventid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">sjdict</span>

    <span class="k">def</span> <span class="nf">_storeGriddedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store gridded data in the output container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">min_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="n">max_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the negative side</span>
                <span class="n">min_long</span> <span class="o">=</span> <span class="n">min_long</span> <span class="o">-</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_long</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the positive side</span>
                <span class="n">max_long</span> <span class="o">=</span> <span class="n">max_long</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_long</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_long</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;nx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;ny&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smny</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span>
        <span class="c1">#</span>
        <span class="c1"># Put the Vs30 grid in the output container</span>
        <span class="c1">#</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="s1">&#39;vs30&#39;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([],</span> <span class="s1">&#39;vs30&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">vs30</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Now do the distance grids</span>
        <span class="c1">#</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
            <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;distances&#39;</span><span class="p">],</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rrup&#39;</span><span class="p">,</span> <span class="s1">&#39;rjb&#39;</span><span class="p">):</span>
                <span class="n">dm_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dm_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">)</span>
                <span class="n">dm_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dm_var</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;distances&#39;</span><span class="p">],</span> <span class="n">dm</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">,</span> <span class="n">dm_std</span><span class="p">,</span>
                            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Output the data and uncertainty grids</span>
        <span class="c1">#</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;component&#39;</span><span class="p">]</span>
        <span class="n">std_metadata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># set the data grid</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span>

            <span class="c1"># set the uncertainty grid</span>
            <span class="n">std_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">)</span>
            <span class="n">std_metadata</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="n">std_metadata</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setIMTGrids</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                           <span class="n">std_metadata</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Directivity</span>
        <span class="c1">#</span>
        <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">imtstr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;directivity&#39;</span><span class="p">],</span> <span class="n">imtstr</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_storePointData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store point data in the output container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Store the Vs30</span>
        <span class="c1">#</span>
        <span class="n">vs30_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m/s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">}</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([],</span> <span class="s1">&#39;vs30&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">vs30</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">vs30_metadata</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Store the distances</span>
        <span class="c1">#</span>
        <span class="n">distance_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;km&#39;</span><span class="p">,</span>
            <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
            <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;distances&#39;</span><span class="p">],</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">distance_metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rrup&#39;</span><span class="p">,</span> <span class="s1">&#39;rjb&#39;</span><span class="p">):</span>
                <span class="n">dm_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dm_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;distances&#39;</span><span class="p">],</span> <span class="n">dm</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dm_var</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                            <span class="n">metadata</span><span class="o">=</span><span class="n">distance_metadata</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Store the IMTs</span>
        <span class="c1">#</span>
        <span class="n">ascii_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idents</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;component&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># set the data grid</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">mean_metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="n">digits</span>
            <span class="p">}</span>
            <span class="c1"># set the uncertainty grid</span>
            <span class="n">std_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">)</span>
            <span class="n">std_metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="n">digits</span>
            <span class="p">}</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setIMTArrays</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                            <span class="n">ascii_ids</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">mean_metadata</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">std_metadata</span><span class="p">,</span>
                            <span class="n">component</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_storeAttenuationData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output arrays of rock and soil attenuation curves</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">dist_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;repi&#39;</span><span class="p">,</span> <span class="s1">&#39;rhypo&#39;</span><span class="p">,</span> <span class="s1">&#39;rrup&#39;</span><span class="p">,</span> <span class="s1">&#39;rjb&#39;</span><span class="p">]:</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;attenuation&#39;</span><span class="p">,</span> <span class="s1">&#39;distances&#39;</span><span class="p">],</span> <span class="n">dist_type</span><span class="p">,</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">,</span> <span class="n">dist_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">imtstrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imtstrs</span><span class="p">:</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;attenuation&#39;</span><span class="p">,</span> <span class="s1">&#39;rock&#39;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;attenuation&#39;</span><span class="p">,</span> <span class="s1">&#39;soil&#39;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;attenuation&#39;</span><span class="p">,</span> <span class="s1">&#39;rock&#39;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s1">&#39;attenuation&#39;</span><span class="p">,</span> <span class="s1">&#39;soil&#39;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="c1">#</span>
    <span class="c1"># Helper function to call get_mean_and_stddevs for the</span>
    <span class="c1"># appropriate object given the IMT and describe the</span>
    <span class="c1"># MultiGMPE structure.</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_gmas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gmpe</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">apply_gafs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a helper function to call get_mean_and_stddevs for the</span>
<span class="sd">        appropriate object given the IMT.</span>

<span class="sd">        Args:</span>
<span class="sd">            gmpe:</span>
<span class="sd">                A GMPE instance.</span>
<span class="sd">            sx:</span>
<span class="sd">                Sites context.</span>
<span class="sd">            dx:</span>
<span class="sd">                Distance context.</span>
<span class="sd">            oqimt:</span>
<span class="sd">                List of OpenQuake IMTs.</span>
<span class="sd">            apply_gafs (boolean):</span>
<span class="sd">                Whether or not to apply the generic</span>
<span class="sd">                amplification factors to the GMPE output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Tuple of two items:</span>

<span class="sd">                - Numpy array of means,</span>
<span class="sd">                - List of numpy array of standard deviations corresponding to</span>
<span class="sd">                  therequested stddev_types.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">in</span> <span class="n">oqimt</span><span class="p">:</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span>
            <span class="n">sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_stddev_types</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">gmpe</span>
            <span class="n">sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_stddev_types</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
                <span class="c1"># --------------------------------------------------------------------</span>
                <span class="c1"># Describe the MultiGMPE</span>
                <span class="c1"># --------------------------------------------------------------------</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_info&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;multigmpe&#39;</span><span class="p">:</span> <span class="p">{}</span>
                    <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="s1">&#39;multigmpe&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)]</span> <span class="o">=</span> <span class="n">gmpe</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">mean</span><span class="p">,</span> <span class="n">stddevs</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_mean_and_stddevs</span><span class="p">(</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="p">,</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="n">oqimt</span><span class="p">,</span>
            <span class="n">sd_types</span><span class="p">)</span>

        <span class="c1"># Include generic amp factors?</span>
        <span class="k">if</span> <span class="n">apply_gafs</span><span class="p">:</span>
            <span class="n">gafs</span> <span class="o">=</span> <span class="n">get_generic_amp_factors</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">gafs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">+=</span> <span class="n">gafs</span>

        <span class="c1"># Does directivity apply to this imt?</span>
        <span class="n">row_pers</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oqimt</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">PGA</span><span class="p">):</span>
            <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oqimt</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">PGV</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oqimt</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">MMI</span><span class="p">):</span>
            <span class="n">tper</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oqimt</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span><span class="p">):</span>
            <span class="n">tper</span> <span class="o">=</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">period</span>
            <span class="n">min_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">row_pers</span><span class="p">)</span>
            <span class="n">max_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">row_pers</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tper</span> <span class="o">&gt;=</span> <span class="n">min_per</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tper</span> <span class="o">&lt;=</span> <span class="n">max_per</span><span class="p">):</span>
                <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Did we calculate directivity?</span>
        <span class="n">calc_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span>

        <span class="k">if</span> <span class="n">calc_dir</span> <span class="ow">and</span> <span class="n">imt_ok</span><span class="p">:</span>
            <span class="c1"># Use distance context to figure out which directivity result</span>
            <span class="c1"># we need to use.</span>
            <span class="n">all_fd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">dirdf</span><span class="p">,</span> <span class="n">tmpdx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dx</span> <span class="o">==</span> <span class="n">tmpdx</span><span class="p">:</span>
                    <span class="n">all_fd</span> <span class="o">=</span> <span class="n">dirdf</span><span class="o">.</span><span class="n">getFd</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">all_fd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to detect dataframe for directivity calculation.&quot;</span><span class="p">)</span>

            <span class="c1"># Does oqimt match any of those periods?</span>
            <span class="k">if</span> <span class="n">tper</span> <span class="ow">in</span> <span class="n">row_pers</span><span class="p">:</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">all_fd</span><span class="p">[</span><span class="n">row_pers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tper</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Log(period) interpolation.</span>
                <span class="n">apers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row_pers</span><span class="p">)</span>
                <span class="n">per_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">apers</span><span class="p">[</span><span class="n">apers</span> <span class="o">&lt;</span> <span class="n">tper</span><span class="p">])</span>
                <span class="n">per_above</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">apers</span><span class="p">[</span><span class="n">apers</span> <span class="o">&gt;</span> <span class="n">tper</span><span class="p">])</span>
                <span class="n">fd_below</span> <span class="o">=</span> <span class="n">all_fd</span><span class="p">[</span><span class="n">row_pers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">per_below</span><span class="p">)]</span>
                <span class="n">fd_above</span> <span class="o">=</span> <span class="n">all_fd</span><span class="p">[</span><span class="n">row_pers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">per_above</span><span class="p">)]</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">per_below</span><span class="p">)</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">per_above</span><span class="p">)</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">fd_below</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tper</span><span class="p">)</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> \
                    <span class="p">(</span><span class="n">fd_above</span> <span class="o">-</span> <span class="n">fd_below</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="c1"># Reshape to match the mean</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="c1"># Store the interpolated grid</span>
            <span class="n">imtstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oqimt</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">MMI</span><span class="p">):</span>
                <span class="n">mean</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">+=</span> <span class="n">fd</span>

        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddevs</span>

    <span class="k">def</span> <span class="nf">_adjustResolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a helper function to adjust the resolution to be under</span>
<span class="sd">        the maximum value specified in the config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We want to only use resolutions that are multiples of 1 minute or</span>
        <span class="c1"># an integer division of 1 minute.</span>
        <span class="n">one_minute</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="n">multiples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
        <span class="n">divisions</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">multiples</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">divisions</span><span class="p">,</span> <span class="n">multiples</span><span class="p">))))</span>
        <span class="n">ok_res</span> <span class="o">=</span> <span class="n">one_minute</span> <span class="o">*</span> <span class="n">factors</span>
        <span class="n">latspan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>

        <span class="c1"># Deal with possible 180 longitude disontinuity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">:</span>
            <span class="n">lonspan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="mi">360</span>
            <span class="n">lonspan</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lonspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">latspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span>
        <span class="k">if</span> <span class="n">ngrid</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extent and resolution of shakemap results in &#39;</span>
                             <span class="s1">&#39;too many grid points. Adjusting resolution...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Longitude span: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lonspan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Latitude span: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">latspan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current dx: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current dy: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current number of grid points: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Max grid points allowed: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nmax</span><span class="p">)</span>
            <span class="n">target_res</span> <span class="o">=</span> \
                <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">latspan</span> <span class="o">+</span> <span class="n">lonspan</span><span class="p">)</span> <span class="o">-</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">latspan</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">lonspan</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                         <span class="mi">2</span> <span class="o">*</span> <span class="n">latspan</span> <span class="o">*</span> <span class="n">lonspan</span> <span class="o">*</span>
                         <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nmax</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok_res</span> <span class="o">&gt;</span> <span class="n">target_res</span><span class="p">):</span>
                <span class="n">sel_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ok_res</span><span class="p">[</span><span class="n">ok_res</span> <span class="o">&gt;</span> <span class="n">target_res</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sel_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ok_res</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span> <span class="o">=</span> <span class="n">sel_res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span> <span class="o">=</span> <span class="n">sel_res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updated dx: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updatd dy: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">)</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lonspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">latspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updated number of grid points: </span><span class="si">%i</span><span class="s1">&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_round_float</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">digits</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;--&#39;</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="s1">&#39;%.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_string_round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">digits</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;--&#39;</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">_round_float</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">digits</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_period_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return 1) a sorted array of the periods represented by the IMT list(s)</span>
<span class="sd">    in the input, and 2) a dictionary of the IMTs and their indices.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args (list): One or more lists of IMTs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        array, dict: Numpy array of the (sorted) periods represented by the</span>
<span class="sd">        IMTs in the input list(s), and a dictionary of the IMTs and their</span>
<span class="sd">        indices into the period array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imt_per</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">imt_per_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">imt_list</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">imt_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imt_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGA&#39;</span><span class="p">:</span>
                <span class="n">period</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="k">elif</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="s1">&#39;MMI&#39;</span><span class="p">):</span>
                <span class="n">period</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">period</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imtstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">imt_per</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
            <span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span>
    <span class="n">imt_per</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imt_per</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">imtstr</span><span class="p">,</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">imt_per_ix</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">imt_per</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imt_per</span><span class="p">),</span> <span class="n">imt_per_ix</span>


<span class="k">def</span> <span class="nf">_get_period_from_imt</span><span class="p">(</span><span class="n">imtstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a float representing the period of the SA IMT in the input.</span>

<span class="sd">    Args:</span>
<span class="sd">        imtstr (str): A string representing an SA IMT.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The period of the SA IMT as a float.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">imtstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_nearest_imts</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">imtset</span><span class="p">,</span> <span class="n">saset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the input IMT, or it&#39;s closest surrogarte (or bracket) found</span>
<span class="sd">    in imtset.</span>

<span class="sd">    Args:</span>
<span class="sd">        imtstr (str): An (OQ-style) IMT string.</span>
<span class="sd">        imtset (list): A list of IMTs to search for imtstr or its closest</span>
<span class="sd">            surrogate (or bracket).</span>
<span class="sd">        saset (list): The SA IMTs found in imtset.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The IMT, it&#39;s closest surrogate, or a bracket of SAs with</span>
<span class="sd">        periods on either side of the IMT&#39;s period, from the IMTs in intset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># If we&#39;re here, then we know that IMT isn&#39;t in the inputs. Try</span>
    <span class="c1"># some alternatives.</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGA&#39;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># Use the highest frequency in the inputs, otherwise use PGV</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">saset</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">saset</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_get_period_from_imt</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGV&#39;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># Use 1.0 sec SA (or its bracket) if it&#39;s there, otherwise</span>
        <span class="c1"># use PGA</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s1">&#39;SA(1.0)&#39;</span> <span class="ow">in</span> <span class="n">saset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;SA(1.0)&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">sa_tuple</span> <span class="o">=</span> <span class="n">_get_sa_bracket</span><span class="p">(</span><span class="s1">&#39;SA(1.0)&#39;</span><span class="p">,</span> <span class="n">saset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sa_tuple</span> <span class="o">!=</span> <span class="p">():</span>
            <span class="k">return</span> <span class="n">sa_tuple</span>
        <span class="k">if</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;PGA&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># Use PGV if it&#39;s there, otherwise use 1.0 sec SA (or its</span>
        <span class="c1"># bracket)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;SA(1.0)&#39;</span> <span class="ow">in</span> <span class="n">saset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;SA(1.0)&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">_get_sa_bracket</span><span class="p">(</span><span class="s1">&#39;SA(1.0)&#39;</span><span class="p">,</span> <span class="n">saset</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">imtstr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># We know the actual IMT isn&#39;t here, so get the bracket</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">_get_sa_bracket</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">saset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown IMT </span><span class="si">%s</span><span class="s1"> in get_imt_bracket&#39;</span> <span class="o">%</span> <span class="n">imtstr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_sa_bracket</span><span class="p">(</span><span class="n">myimt</span><span class="p">,</span> <span class="n">saset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given SA IMT, look through the input SAs and return a tuple of</span>
<span class="sd">    a) a pair of IMT strings representing the periods bracketing the given</span>
<span class="sd">    period; or c) the single IMT representing the first or last period in</span>
<span class="sd">    the input list if the given period is off the end of the list.</span>

<span class="sd">    Args:</span>
<span class="sd">        myper (float): The period to search for in the input lists.</span>
<span class="sd">        saset (list): A list of SA IMTs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: One or two strings representing the IMTs closest to or</span>
<span class="sd">        bracketing the input IMT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">saset</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="c1">#</span>
    <span class="c1"># Stick the target IMT into a copy of the list of SAs, then sort</span>
    <span class="c1"># the list by period.</span>
    <span class="c1">#</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">saset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myimt</span><span class="p">)</span>
    <span class="n">tmplist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_get_period_from_imt</span><span class="p">)</span>
    <span class="n">nimt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmplist</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Get the index of the target IMT in the sorted list</span>
    <span class="c1">#</span>
    <span class="n">myix</span> <span class="o">=</span> <span class="n">tmplist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">myimt</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># If the target IMT is off the end of the list, return the</span>
    <span class="c1"># appropriate endpoint; else return the pair of IMTs that</span>
    <span class="c1"># bracket the target.</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">myix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tmplist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">myix</span> <span class="o">==</span> <span class="n">nimt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tmplist</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tmplist</span><span class="p">[</span><span class="n">myix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tmplist</span><span class="p">[</span><span class="n">myix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_get_imt_lists</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a data frame, return a list of lists of valid IMTS for</span>
<span class="sd">    each station in the dataframe; also return a list of the valid</span>
<span class="sd">    SA IMTs for each station.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): A DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list, list: Two lists of lists: each list contains lists</span>
<span class="sd">        corresponding to the stations in the data frame: the first</span>
<span class="sd">        list contains all of the valid IMTs for that station, the</span>
<span class="sd">        second list contains just the valid SA IMTs for the station.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imtlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">salist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlist</span><span class="p">):</span>
        <span class="n">valid_imts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sa_imts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;flagged&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">df</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">][</span><span class="n">ix</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">this_imt</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">this_imt</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">][</span><span class="n">ix</span><span class="p">])</span> <span class="ow">and</span> \
                        <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">this_imt</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">][</span><span class="n">ix</span><span class="p">]:</span>
                    <span class="n">valid_imts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_imt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">this_imt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">):</span>
                        <span class="n">sa_imts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_imt</span><span class="p">)</span>
        <span class="n">imtlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_imts</span><span class="p">)</span>
        <span class="n">salist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sa_imts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imtlist</span><span class="p">,</span> <span class="n">salist</span>


<span class="k">def</span> <span class="nf">_get_map_grade</span><span class="p">(</span><span class="n">do_grid</span><span class="p">,</span> <span class="n">outsd</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">moutgrid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a &#39;grade&#39; for the map. Essentially looks at the ratio of</span>
<span class="sd">    the computed PGA uncertainty to the predicted PGA uncertainty for</span>
<span class="sd">    the area inside the MMI 6 contour. If the maximum MMI is less than</span>
<span class="sd">    6, or the map is not a grid, the grade and mean ratio are set to &#39;--&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        do_grid (bool): Is the map a grid (True) or a list of points</span>
<span class="sd">            (False)?</span>

<span class="sd">        outsd (dict): A dictionary of computed uncertainty arrays.</span>

<span class="sd">        psd (dict): A dictionary of predicted uncertainty arrays.</span>

<span class="sd">        moutgrid (dict): A dictionary of landmasked output ground</span>
<span class="sd">            motion arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The mean uncertainty ratio and the letter grade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_rat</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
    <span class="n">mygrade</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_grid</span> <span class="ow">or</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outsd</span> <span class="ow">or</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psd</span> \
            <span class="ow">or</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">moutgrid</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span>
    <span class="n">sd_rat</span> <span class="o">=</span> <span class="n">outsd</span><span class="p">[</span><span class="s1">&#39;PGA&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;PGA&#39;</span><span class="p">]</span>
    <span class="n">mmimasked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="mf">6.0</span><span class="p">)</span>
    <span class="n">mpgasd_rat</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">sd_rat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mmimasked</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mpgasd_rat</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">gvals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">]</span>
        <span class="n">grades</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]</span>
        <span class="n">mean_rat</span> <span class="o">=</span> <span class="n">mpgasd_rat</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gvals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mean_rat</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">mygrade</span> <span class="o">=</span> <span class="n">grades</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">mygrade</span> <span class="o">==</span> <span class="s1">&#39;--&#39;</span><span class="p">:</span>
            <span class="n">mygrade</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>
    <span class="k">return</span> <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span>


<span class="c1"># we need a way to get units information about intensity measure types</span>
<span class="c1"># and translate between openquake naming convention and ShakeMap grid naming</span>
<span class="c1"># convention.</span>
<span class="k">def</span> <span class="nf">_get_layer_info</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We need a way to get units information about intensity measure types</span>
<span class="sd">    and translate between OpenQuake naming convention and ShakeMap grid naming</span>
<span class="sd">    convention.</span>

<span class="sd">    Args:</span>
<span class="sd">        layer (str): ShakeMap grid name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple including:</span>

<span class="sd">            - OpenQuake naming convention,</span>
<span class="sd">            - units,</span>
<span class="sd">            - significant digits.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer_out</span> <span class="o">=</span> <span class="n">layer</span>
    <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">layer_digits</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of significant digits</span>

    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_sd&#39;</span><span class="p">):</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">oq_to_file</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_sd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">layer_out</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">oq_to_file</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;ln(g)&#39;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PGA&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;ln(g)&#39;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;ln(cm/s)&#39;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
        <span class="n">layer_digits</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;vs30&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;m/s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown layer type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layer</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">layer_out</span><span class="p">,</span> <span class="n">layer_units</span><span class="p">,</span> <span class="n">layer_digits</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/northridge_thumbnail_light_16x9.png" alt="Logo"/>
    
    <h1 class="logo logo-name">ShakeMap Documentation</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual4_0/index.html">ShakeMap 4.0 Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../programs/programs.html">ShakeMap 4.0 Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/shakemap.html">ShakeMap 4.0 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manual3_5/index.html">ShakeMap 3.5 Manual (Deprecated)</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>