
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>shakemap.coremods.model &#8212; ShakeMap Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/northridge_points.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for shakemap.coremods.model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Process a ShakeMap, based on the configuration and data found in</span>
<span class="sd">shake_data.hdf, and produce output in shake_result.hdf.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">gmtime</span><span class="p">,</span> <span class="n">strftime</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib</span> <span class="kn">import</span> <span class="n">imt</span>
<span class="kn">import</span> <span class="nn">openquake.hazardlib.const</span> <span class="k">as</span> <span class="nn">oqconst</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">cartopy.io.shapereader</span> <span class="k">as</span> <span class="nn">shpreader</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">shape</span>

<span class="kn">import</span> <span class="nn">concurrent.futures</span> <span class="k">as</span> <span class="nn">cf</span>
<span class="kn">from</span> <span class="nn">impactutils.rupture.point_rupture</span> <span class="kn">import</span> <span class="n">PointRupture</span>
<span class="kn">from</span> <span class="nn">impactutils.rupture.distance</span> <span class="kn">import</span> <span class="n">Distance</span><span class="p">,</span> <span class="n">get_distance</span><span class="p">,</span> <span class="n">get_distance_measures</span>
<span class="kn">from</span> <span class="nn">impactutils.io.smcontainers</span> <span class="kn">import</span> <span class="n">ShakeMapOutputContainer</span>
<span class="kn">from</span> <span class="nn">impactutils.rupture</span> <span class="kn">import</span> <span class="n">constants</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">mapio.geodict</span> <span class="kn">import</span> <span class="n">GeoDict</span>
<span class="kn">from</span> <span class="nn">mapio.grid2d</span> <span class="kn">import</span> <span class="n">Grid2D</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">CoreModule</span><span class="p">,</span> <span class="n">Contents</span>
<span class="kn">from</span> <span class="nn">shakelib.sites</span> <span class="kn">import</span> <span class="n">Sites</span>
<span class="kn">from</span> <span class="nn">shakelib.multigmpe</span> <span class="kn">import</span> <span class="n">MultiGMPE</span>
<span class="kn">from</span> <span class="nn">shakelib.virtualipe</span> <span class="kn">import</span> <span class="n">VirtualIPE</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.utils</span> <span class="kn">import</span> <span class="n">get_extent</span><span class="p">,</span> <span class="n">thirty_sec_min</span><span class="p">,</span> <span class="n">thirty_sec_max</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.imt_string</span> <span class="kn">import</span> <span class="n">oq_to_file</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.containers</span> <span class="kn">import</span> <span class="n">ShakeMapInputContainer</span>
<span class="kn">from</span> <span class="nn">shakemap.utils.config</span> <span class="kn">import</span> <span class="n">get_config_paths</span>
<span class="kn">from</span> <span class="nn">shakemap.utils.utils</span> <span class="kn">import</span> <span class="n">get_object_from_config</span>
<span class="kn">from</span> <span class="nn">shakemap._version</span> <span class="kn">import</span> <span class="n">get_versions</span>
<span class="kn">from</span> <span class="nn">shakemap.utils.generic_amp</span> <span class="kn">import</span> <span class="n">get_generic_amp_factors</span>
<span class="kn">from</span> <span class="nn">shakemap.c.clib</span> <span class="kn">import</span> <span class="n">make_sigma_matrix</span><span class="p">,</span> <span class="n">geodetic_distance_fast</span><span class="p">,</span> <span class="n">make_sd_array</span>

<span class="c1"># from shakemap.utils.exception import TerminateShakeMap</span>

<span class="kn">from</span> <span class="nn">shakelib.directivity.rowshandel2013</span> <span class="kn">import</span> <span class="n">Rowshandel2013</span>

<span class="c1">#</span>
<span class="c1"># default_stddev_inter: This is a stand-in for tau when the gmpe set</span>
<span class="c1">#                       doesn&#39;t provide it. It is an educated guess based</span>
<span class="c1">#                       on the NGA-west, Akkar et al, and BC Hydro gmpes.</span>
<span class="c1">#                       It&#39;s not perfect, but probably isn&#39;t too far off.</span>
<span class="c1">#                       It is only used when the GMPE(s) don&#39;t provide a</span>
<span class="c1">#                       breakdown of the uncertainty terms. When used,</span>
<span class="c1">#                       this value is multiplied by the total standard</span>
<span class="c1">#                       deviation to get tau. The square of tau is then</span>
<span class="c1">#                       subtracted from the squared total stddev and the</span>
<span class="c1">#                       square root of the result is then used as the</span>
<span class="c1">#                       within-event stddev (phi).</span>
<span class="c1">#</span>
<span class="n">SM_CONSTS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default_stddev_inter&quot;</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="s2">&quot;default_stddev_inter_mmi&quot;</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">}</span>


<div class="viewcode-block" id="DataFrame"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.DataFrame">[docs]</a><span class="k">class</span> <span class="nc">DataFrame</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span>
        <span class="n">imts</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa</span></div>


<div class="viewcode-block" id="ModelModule"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule">[docs]</a><span class="k">class</span> <span class="nc">ModelModule</span><span class="p">(</span><span class="n">CoreModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    model -- Interpolate ground motions to a grid or list of locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">command_name</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;products/shake_result\.hdf&quot;</span><span class="p">]</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;shake_data.hdf&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>

    <span class="n">no_seismic</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">no_macroseismic</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">no_rupture</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_simulations</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">rock_vs30</span> <span class="o">=</span> <span class="mf">760.0</span>
    <span class="n">soil_vs30</span> <span class="o">=</span> <span class="mf">180.0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventid</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">eventid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">eventid</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Set up a bunch of dictionaries that will be keyed to IMTs</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># holds an average bias for each IMT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># raw phi (intra-event stddev) of the output points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psd</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># phi (intra-event stddev) of the output points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># tau (inter-event stddev) of the output points</span>
        <span class="c1">#</span>
        <span class="c1"># These are arrays (keyed by IMT) of the station data that will be</span>
        <span class="c1"># used to compute the bias and do the interpolation, they are filled</span>
        <span class="c1"># in the _fillDataArrays method</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_per_ix</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_tau</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_rrups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#</span>
        <span class="c1"># These are useful matrices that we compute in the bias function</span>
        <span class="c1"># that we can reuse in the MVN function</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_D</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_WD_WD_inv</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_HH_yD</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#</span>
        <span class="c1"># Some variables and arrays used in both the bias and MVN functions</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_native_flag</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imt_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imt_Y_ind</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#</span>
        <span class="c1"># These hold the main outputs of the MVN</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Holds the interpolated output arrays keyed by IMT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Holds the standard deviation arrays keyed by IMT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outphi</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Holds the intra-event standard deviation arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outtau</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Holds the inter-event standard deviation arrays</span>
        <span class="c1">#</span>
        <span class="c1"># Places to put the results for the attenuation plots</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_mean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_sd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_sd</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="ModelModule.parseArgs"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule.parseArgs">[docs]</a>    <span class="k">def</span> <span class="nf">parseArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arglist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the object to accept the --no_seismic, --no_macroseismic,</span>
<span class="sd">        and --no_rupture flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">prog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">command_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--no_seismic&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Exclude instrumental seismic data from &quot;</span>
            <span class="s2">&quot;the processing, ignoring any that may exist in &quot;</span>
            <span class="s2">&quot;the input directory.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--no_macroseismic&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Exclude macroseismic data from the &quot;</span>
            <span class="s2">&quot;processing, ignoring any that may exist in the &quot;</span>
            <span class="s2">&quot;input directory.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-r&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--no_rupture&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Exclude a rupture model from the &quot;</span>
            <span class="s2">&quot;processing, ignoring any that may exist in the &quot;</span>
            <span class="s2">&quot;input directory.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># This line should be in any modules that overrides this</span>
        <span class="c1"># one. It will collect up everything after the current</span>
        <span class="c1"># modules options in args.rem, which should be returned</span>
        <span class="c1"># by this function. Note: doing parser.parse_known_args()</span>
        <span class="c1"># will not work as it will suck up any later modules&#39;</span>
        <span class="c1"># options that are the same as this one&#39;s.</span>
        <span class="c1">#</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;rem&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">arglist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_seismic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_seismic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_macroseismic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_macroseismic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_rupture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_rupture</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">rem</span></div>

<div class="viewcode-block" id="ModelModule.execute"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate ground motions to a grid or list of locations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotADirectoryError: When the event data directory does not exist.</span>
<span class="sd">            FileNotFoundError: When the the shake_data HDF file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting model...&quot;</span><span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Make the input container and extract the config</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setInputContainer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getConfig</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getArrays</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;simulations&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_simulations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Clear away results from previous runs</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clearProducts</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Retrieve a bunch of config options and set them as attributes</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setConfigOptions</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Instantiate the gmpe, gmice, and ipe</span>
        <span class="c1"># Here we make a placeholder gmpe so that we can make the</span>
        <span class="c1"># rupture and distance contexts; later we&#39;ll make the</span>
        <span class="c1"># IMT-specific gmpes</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">__from_config__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s2">&quot;gmice&quot;</span><span class="p">,</span> <span class="s2">&quot;modeling&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ipe_modules&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;ipe&quot;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">==</span> <span class="s2">&quot;VirtualIPE&quot;</span>
        <span class="p">):</span>
            <span class="n">pgv_imt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;PGV&quot;</span><span class="p">)</span>
            <span class="n">ipe_gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">__from_config__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">pgv_imt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span> <span class="o">=</span> <span class="n">VirtualIPE</span><span class="o">.</span><span class="n">__fromFuncs__</span><span class="p">(</span><span class="n">ipe_gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ipe</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s2">&quot;ipe&quot;</span><span class="p">,</span> <span class="s2">&quot;modeling&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;vs30&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ipe</span><span class="o">.</span><span class="n">REQUIRES_SITES_PARAMETERS</span><span class="p">:</span>
                <span class="c1"># REQUIRES_SITES_PARAMETERS is now a frozen set so we have to</span>
                <span class="c1"># work around it</span>
                <span class="n">tmpset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ipe</span><span class="o">.</span><span class="n">REQUIRES_SITES_PARAMETERS</span><span class="p">)</span>
                <span class="n">tmpset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;vs30&quot;</span><span class="p">)</span>
                <span class="n">ipe</span><span class="o">.</span><span class="n">REQUIRES_SITES_PARAMETERS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">tmpset</span><span class="p">)</span>
            <span class="n">ipe</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_COMPONENT</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">oqconst</span><span class="o">.</span><span class="n">IMC</span><span class="o">.</span><span class="n">GREATER_OF_TWO_HORIZONTAL</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">__from_list__</span><span class="p">([</span><span class="n">ipe</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>

        <span class="n">ipe_sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span><span class="o">.</span><span class="n">DEFINED_FOR_STANDARD_DEVIATION_TYPES</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipe_sd_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipe_stddev_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">,</span>
                <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTER_EVENT</span><span class="p">,</span>
                <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTRA_EVENT</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Get the rupture object and rupture context</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getRuptureObject</span><span class="p">()</span>
        <span class="c1"># If the --no_rupture flag is used, switch to a PointRupture</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_rupture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span> <span class="o">=</span> <span class="n">PointRupture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;mechanism&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">setMechanism</span><span class="p">(</span>
                <span class="n">mech</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;mechanism&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">getRuptureContext</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">])</span>
        <span class="c1"># TODO: figure out how to not have to do this</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">rake</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">rake</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#</span>
        <span class="c1"># Set up the coordinates for the attenuation curves</span>
        <span class="c1">#</span>
        <span class="n">repi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">getHypo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;lons&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">repi</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;lats&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">111.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">repi</span><span class="p">]),</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_source</span> <span class="o">=</span> <span class="n">PointRupture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># The output locations: either a grid or a list of points</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting output params...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setOutputParams</span><span class="p">()</span>

        <span class="n">landmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLandMask</span><span class="p">()</span>
        <span class="c1"># We used to do this, but we&#39;ve decided not to. Leaving the code</span>
        <span class="c1"># in place in case we change our minds.</span>
        <span class="c1"># if landmask is not None and np.all(landmask):</span>
        <span class="c1">#     raise TerminateShakeMap(&quot;Mapped area is entirely water&quot;)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># If the gmpe doesn&#39;t break down its stardard deviation into</span>
        <span class="c1"># within- and between-event terms, we need to handle things</span>
        <span class="c1"># somewhat differently.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">gmpe_sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="o">.</span><span class="n">DEFINED_FOR_STANDARD_DEVIATION_TYPES</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmpe_sd_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_stddev_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">,</span>
                <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTER_EVENT</span><span class="p">,</span>
                <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTRA_EVENT</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Are we going to include directivity?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Config option?</span>
        <span class="n">dir_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;directivity&quot;</span><span class="p">]</span>

        <span class="c1"># Is the rupture not a point source?</span>
        <span class="n">rup_check</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dir_conf</span> <span class="ow">and</span> <span class="n">rup_check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># The following attribute will be used to store a list of tuples,</span>
            <span class="c1"># where each tuple will contain the 1) result of the directivity</span>
            <span class="c1"># model (for the periods defined by Rowshandel2013) and 2) the</span>
            <span class="c1"># associated distance context. The distance context is needed</span>
            <span class="c1"># within the _gmas function for figuring out which of the results</span>
            <span class="c1"># should be used when combining it with the GMPE result. We store</span>
            <span class="c1"># the pre-defined period first and interpolate later because there</span>
            <span class="c1"># is some optimization to doing it this way (some of the</span>
            <span class="c1"># calculation is period independent).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># But if we want to save the results that were actually used for</span>
            <span class="c1"># each IMT, so we use a dictionary. This uses keys that are</span>
            <span class="c1"># the same as self.outgrid.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Station data: Create DataFrame(s) with the input data:</span>
        <span class="c1"># df1 for instrumented data</span>
        <span class="c1"># df2 for non-instrumented data</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting data frames...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDataFrames</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the predictions, etc. to the data frames</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Populating data frames...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populateDataFrames</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Try to make all the derived IMTs possible from MMI (if we have MMI)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deriveIMTsFromMMI</span><span class="p">()</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Now make MMI from the station data where possible</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deriveMMIFromIMTs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting combined IMTs&quot;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Get the combined set of input and output IMTs, their periods,</span>
        <span class="c1"># and an index dictionary, then make the cross-correlation function</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Ignore what is in the configuration and make maps only for the</span>
            <span class="c1"># IMTs that are in the set of simulations (and MMI).</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span><span class="p">:</span>
                <span class="n">dset</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getArray</span><span class="p">([</span><span class="s2">&quot;simulations&quot;</span><span class="p">],</span> <span class="n">imtstr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;MMI&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span> <span class="o">|=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">imts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imt_per</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span> <span class="o">=</span> <span class="n">_get_period_arrays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combined_imt_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s2">&quot;ccf&quot;</span><span class="p">,</span> <span class="s2">&quot;modeling&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Doing bias&quot;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Do the bias for all of the input and output IMTs. Hold on</span>
        <span class="c1"># to some of the products that will be used for the interpolation.</span>
        <span class="c1"># The &quot;raw&quot; values are the stddevs that have not been inflated by</span>
        <span class="c1"># the additional sigma (if any) of the point-source to finite</span>
        <span class="c1"># rupture approximation.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Do some prep, the bias, and the directivity prep</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fillDataArrays</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_computeBias</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_computeDirectivityPredictionLocations</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Now do the MVN with the intra-event residuals</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Doing MVN...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_computeMVN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">)</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>  <span class="c1"># Check threads for possible exceptions, etc.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">imt_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_computeMVN</span><span class="p">(</span><span class="n">imt_str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_applyCustomMask</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Output the data and metadata</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">product_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;products&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">product_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">product_path</span><span class="p">)</span>
        <span class="n">oc</span> <span class="o">=</span> <span class="n">ShakeMapOutputContainer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">product_path</span><span class="p">,</span> <span class="s2">&quot;shake_result.hdf&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Might as well stick the whole config in the result</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># We&#39;re going to need masked arrays of the output grids later, so</span>
        <span class="c1"># make them now.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">moutgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMaskedGrids</span><span class="p">(</span><span class="n">landmask</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Get the info dictionary that will become info.json, and</span>
        <span class="c1"># store it in the output container</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInfo</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">)</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the rupture JSON as a text string</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setRuptureDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_geojson</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Fill the station dictionary for stationlist.json and add it to</span>
        <span class="c1"># the output container</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">sjdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillStationJSON</span><span class="p">()</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setStationDict</span><span class="p">(</span><span class="n">sjdict</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the output grids or points to the output; include some</span>
        <span class="c1"># metadata.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storeGriddedData</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storePointData</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_storeAttenuationData</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>

        <span class="n">oc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">addFile</span><span class="p">(</span>
            <span class="s2">&quot;shakemapHDF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Comprehensive ShakeMap HDF Data File&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HDF file containing all ShakeMap results.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shake_result.hdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;application/x-bag&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># End execute()</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_setInputContainer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the input container and set</span>
<span class="sd">        the event&#39;s current data directory.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotADirectoryError: When the event data directory does not exist.</span>
<span class="sd">            FileNotFoundError: When the the shake_data HDF file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Find the shake_data.hdf file</span>
        <span class="c1">#</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">data_path</span> <span class="o">=</span> <span class="n">get_config_paths</span><span class="p">()</span>
        <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datadir</span><span class="si">}</span><span class="s2"> is not a valid directory.&quot;</span><span class="p">)</span>

        <span class="n">datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;shake_data.hdf&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datafile</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ic</span> <span class="o">=</span> <span class="n">ShakeMapInputContainer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clearProducts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to delete an event&#39;s products directory if it exists.</span>

<span class="sd">        Returns:</span>
<span class="sd">            nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">products_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;products&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">products_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">products_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pdl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;pdl&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pdl_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">pdl_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setConfigOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull various useful configuration options out of the config</span>
<span class="sd">        dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Processing parameters</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;max_workers&quot;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Do we apply the generic amplification factors?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;apply_generic_amp_factors&quot;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Bias parameters</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">][</span><span class="s2">&quot;do_bias&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">][</span><span class="s2">&quot;max_range&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">][</span><span class="s2">&quot;max_mag&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_dsigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">][</span><span class="s2">&quot;max_delta_sigma&quot;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Outlier parameters</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_outliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;outlier&quot;</span><span class="p">][</span><span class="s2">&quot;do_outliers&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_deviation_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;outlier&quot;</span><span class="p">][</span><span class="s2">&quot;max_deviation&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_max_mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;outlier&quot;</span><span class="p">][</span><span class="s2">&quot;max_mag&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_valid_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;outlier&quot;</span><span class="p">][</span><span class="s2">&quot;valid_stations&quot;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># These are the IMTs we want to make</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;imt_list&quot;</span><span class="p">])</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># The x and y resolution of the output grid</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;prediction_location&quot;</span><span class="p">][</span><span class="s2">&quot;xres&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;prediction_location&quot;</span><span class="p">][</span><span class="s2">&quot;yres&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;prediction_location&quot;</span><span class="p">][</span><span class="s2">&quot;nmax&quot;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Get the Vs30 file name</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;vs30default&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;vs30file&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;maskfile&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_setOutputParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set variables dealing with the output grid or points</span>

<span class="sd">        Returns:</span>
<span class="sd">            nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">imt_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_imt_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">imt_grp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">myimt</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">geodict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getArray</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">myimt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span> <span class="o">=</span> <span class="n">geodict</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span>
                <span class="n">defaultVs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">,</span>
                <span class="n">vs30File</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getNxNy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">()</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="o">.</span><span class="n">fromSites</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;prediction_location&quot;</span><span class="p">][</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;prediction_location&quot;</span><span class="p">][</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span>
        <span class="p">):</span>
            <span class="c1">#</span>
            <span class="c1"># FILE: Open the file and get the output points</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">in_sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;prediction_location&quot;</span><span class="p">][</span><span class="s2">&quot;file&quot;</span><span class="p">],</span>
                <span class="n">autostrip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="s2">&quot;&lt;U80&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">in_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Points file is empty; nothing to do&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">in_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="n">idents</span> <span class="o">=</span> <span class="n">in_sites</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idents</span> <span class="o">=</span> <span class="p">[</span><span class="n">idents</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">in_sites</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_sites</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vs30</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">thirty_sec_min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">thirty_sec_max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">thirty_sec_min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">thirty_sec_max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smny</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span>
                <span class="n">defaultVs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">,</span>
                <span class="n">vs30File</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;lats&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="s2">&quot;lons&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># Replace the Vs30 from the grid (or default) with the Vs30</span>
            <span class="c1"># provided with the site list.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs30</span>
                <span class="n">Sites</span><span class="o">.</span><span class="n">_addDepthParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># GRID: Figure out the grid parameters and get output points</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;prediction_location&quot;</span><span class="p">][</span><span class="s2">&quot;extent&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;prediction_location&quot;</span>
                <span class="p">][</span><span class="s2">&quot;extent&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">get_extent</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">ipe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ipe</span><span class="p">,</span> <span class="n">rupture</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
                <span class="p">)</span>

            <span class="c1"># Adjust resolution to be under nmax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_adjustResolution</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span>
                <span class="n">defaultVs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">,</span>
                <span class="n">vs30File</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30_file</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getNxNy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">()</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="o">.</span><span class="n">fromSites</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
            <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># TODO: This will break if the IPE needs distance measures</span>
        <span class="c1"># that the GMPE doesn&#39;t; should make this a union of the</span>
        <span class="c1"># requirements of both</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span> <span class="o">=</span> <span class="n">dist_obj_out</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Set up the sites and distance contexts for the attenuation curves</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">,</span> <span class="n">rock_vs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rock_vs30</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">,</span> <span class="n">rock_vs30</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">soil_vs30</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s2">&quot;lons&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s2">&quot;lats&quot;</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s2">&quot;lons&quot;</span><span class="p">]),</span>
            <span class="n">rupture</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">point_source</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lats_out_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">def</span> <span class="nf">_setDataFrames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the StationList object from the input container and</span>
<span class="sd">        fill the DataFrame class and keep a list of dataframes.</span>

<span class="sd">            - df1 holds the instrumented data (PGA, PGV, SA)</span>
<span class="sd">            - df2 holds the non-instrumented data (MMI)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getStationList</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">dfid</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;df1&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;df2&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">dfid</span> <span class="o">==</span> <span class="s2">&quot;df1&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_seismic</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">dfid</span> <span class="o">==</span> <span class="s2">&quot;df2&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_macroseismic</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sdf</span><span class="p">,</span> <span class="n">imts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">getStationDictionary</span><span class="p">(</span>
                <span class="n">instrumented</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">min_nresp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;min_nresp&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
                <span class="n">df</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">sdf</span>
                <span class="n">df</span><span class="o">.</span><span class="n">imts</span> <span class="o">=</span> <span class="n">imts</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfid</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfid</span><span class="p">)</span>

        <span class="c1"># Flag the stations in the bad stations list from the config</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;df1&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">evdt</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">nostart</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;bad_stations&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">dates</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;bad_stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ondate</span><span class="p">,</span> <span class="n">offdate</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ondate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
            <span class="n">ondt</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offdate</span><span class="p">:</span>
                <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">offdate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                <span class="n">offdt</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offdt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ondt</span> <span class="o">==</span> <span class="n">nostart</span> <span class="ow">or</span> <span class="n">ondt</span> <span class="o">&lt;=</span> <span class="n">evdt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">offdt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">offdt</span> <span class="o">&gt;=</span> <span class="n">evdt</span><span class="p">):</span>
                <span class="n">bad</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">]</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sid</span>

    <span class="k">def</span> <span class="nf">_populateDataFrames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the sites and distance contexts for each dataframe then</span>
<span class="sd">        compute the predictions for the IMTs in that dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dfid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">dfn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfid</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dfn</span><span class="o">.</span><span class="n">df</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Get the sites and distance contexts</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>
            <span class="n">lldict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lons&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="s2">&quot;lats&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]}</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span><span class="n">lldict</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_rock</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_rock</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="o">.</span><span class="n">vs30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rock_vs30</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_soil</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">sx_soil</span><span class="o">.</span><span class="n">vs30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="o">.</span><span class="n">vs30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil_vs30</span><span class="p">)</span>
            <span class="n">dist_obj</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
            <span class="p">)</span>
            <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">dist_obj</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>

            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Are we doing directivity?</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directivity for </span><span class="si">{</span><span class="n">dfid</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">dir_df</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">T</span><span class="o">=</span><span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">(),</span>
                    <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dir_df</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">))</span>
                <span class="n">directivity_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Directivity </span><span class="si">{</span><span class="n">dfid</span><span class="si">}</span><span class="s2"> evaluation time: </span><span class="si">{</span><span class="n">directivity_time</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> sec&quot;</span>
                <span class="p">)</span>

            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Do the predictions and other bookkeeping for each IMT</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">imt_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">dfn</span><span class="o">.</span><span class="n">imts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imt_set</span><span class="p">:</span>
                <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
                <span class="n">gmpe</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">__from_config__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Input IMT </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> not supported by GMPE: ignoring&quot;</span>
                        <span class="p">)</span>
                        <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">not_supported</span><span class="p">:</span>
                    <span class="n">pmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pmean_rock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pmean_soil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span>
                    <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span>
                    <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
                        <span class="n">gmpe</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
                    <span class="p">)</span>
                    <span class="n">pmean_rock</span><span class="p">,</span> <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
                        <span class="n">gmpe</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">sx_rock</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
                    <span class="p">)</span>
                    <span class="n">pmean_soil</span><span class="p">,</span> <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
                        <span class="n">gmpe</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">sx_soil</span><span class="p">,</span> <span class="n">dfn</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
                    <span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_rock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_rock</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma_rock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_soil&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_soil</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma_soil&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s2">&quot;default_stddev_inter&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s2">&quot;default_stddev_inter_mmi&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">total_only</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># If we&#39;re just computing the predictions of an output</span>
                <span class="c1"># IMT, then we can skip the residual and outlier stuff</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="n">imtstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1">#</span>
                <span class="c1"># Compute the total residual</span>
                <span class="c1">#</span>
                <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred&quot;</span><span class="p">]</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># Do the outlier flagging if we have a fault, or we don&#39;t</span>
                <span class="c1"># have a fault but the event magnitude is under the limit</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_outliers</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlier_max_mag</span>
                <span class="p">):</span>
                    <span class="c1">#</span>
                    <span class="c1"># Make a boolean array of stations that have been</span>
                    <span class="c1"># manually rehabilitated by the operator</span>
                    <span class="c1">#</span>
                    <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">valid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlier_valid_stations</span><span class="p">:</span>
                        <span class="n">is_valid</span> <span class="o">|=</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="c1"># turn off nan warnings for this statement</span>
                    <span class="c1">#</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                    <span class="n">flagged</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">])</span>
                        <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlier_deviation_level</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma&quot;</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">is_valid</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="c1"># Add NaN values to the list of outliers</span>
                    <span class="c1">#</span>
                    <span class="n">flagged</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;IMT: </span><span class="si">%s</span><span class="s2">, flagged: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flagged</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagged</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="c1"># Not doing outliers, but should still flag NaNs</span>
                    <span class="c1">#</span>
                    <span class="n">flagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">])</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagged</span>
                <span class="c1">#</span>
                <span class="c1"># If uncertainty hasn&#39;t been set for MMI, give it</span>
                <span class="c1"># the default value</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;default_mmi_stddev&quot;</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1"># Get the lons/lats in radians while we&#39;re at it</span>
            <span class="c1">#</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon_rad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lat_rad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon_rad&quot;</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon_rad&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="c1">#</span>
            <span class="c1"># It will be handy later on to have the rupture distance</span>
            <span class="c1"># in the dataframes</span>
            <span class="c1">#</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="s2">&quot;rrup_var&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rrup_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s2">&quot;rrup_var&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rrup_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_deriveIMTsFromMMI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute all the IMTs possible from MMI</span>
<span class="sd">        TODO: This logic needs to be revisited. We should probably make what</span>
<span class="sd">        we have to to do the CMS to make the needed output IMTs, but</span>
<span class="sd">        for now, we&#39;re just going to use what we have and the ccf.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;df2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span>
        <span class="k">for</span> <span class="n">gmice_imt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span> <span class="o">==</span> <span class="n">gmice_imt</span><span class="p">:</span>
                <span class="n">iterlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterlist</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">iterlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">period</span><span class="p">:</span>
                    <span class="n">oqimt</span> <span class="o">=</span> <span class="n">gmice_imt</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oqimt</span> <span class="o">=</span> <span class="n">gmice_imt</span><span class="p">()</span>
                <span class="n">imtstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)</span>

                <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getGMfromMI</span><span class="p">(</span>
                    <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">dists</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">],</span> <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span>
                <span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span>
                    <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;min_mmi_convert&quot;</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                    <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getMI2GMsd</span><span class="p">()[</span><span class="n">oqimt</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">imts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Get the predictions and stddevs</span>
                <span class="c1">#</span>
                <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">__from_config__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Input IMT </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> not supported by GMPE: ignoring&quot;</span>
                    <span class="p">)</span>
                    <span class="n">not_supported</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">not_supported</span><span class="p">:</span>
                    <span class="n">pmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
                        <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
                    <span class="p">)</span>
                    <span class="n">pmean_rock</span><span class="p">,</span> <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
                        <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">sx_rock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
                    <span class="p">)</span>
                    <span class="n">pmean_soil</span><span class="p">,</span> <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
                        <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">sx_soil</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
                    <span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_rock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_rock</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma_rock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_soil&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_soil</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma_soil&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s2">&quot;default_stddev_inter&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s2">&quot;default_stddev_inter_mmi&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">total_only</span><span class="p">:</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_pred_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmean</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">])</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">]</span> <span class="o">|=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;MMI_outliers&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_deriveMMIFromIMTs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make derived MMI from each of the IMTs in the input (for</span>
<span class="sd">        which the GMICE is defined; then select the best MMI for</span>
<span class="sd">        each station based on a list of &quot;preferred&quot; IMTs; also</span>
<span class="sd">        calculate the predicted MMI and the residual.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;df1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span>
        <span class="n">gmice_imts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">imt</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">imt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span>
        <span class="p">]</span>
        <span class="n">gmice_pers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getPreferredMI</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">dists</span><span class="o">=</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">],</span> <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getPreferredSD</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
            <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">oqimt</span><span class="o">.</span><span class="n">string</span> <span class="ow">in</span> <span class="n">gmice_imts</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">oqimt</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SA&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;SA&quot;</span> <span class="ow">in</span> <span class="n">gmice_imts</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;SA&quot;</span> <span class="ow">in</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">string</span> <span class="ow">and</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">period</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gmice_pers</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;derived_MMI_from_&quot;</span> <span class="o">+</span> <span class="n">imtstr</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getMIfromGM</span><span class="p">(</span>
                <span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">dists</span><span class="o">=</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">],</span> <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span>
            <span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;derived_MMI_from_&quot;</span> <span class="o">+</span> <span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                <span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getGM2MIsd</span><span class="p">()[</span><span class="n">oqimt</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">preferred_imts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PGV&quot;</span><span class="p">,</span> <span class="s2">&quot;PGA&quot;</span><span class="p">,</span> <span class="s2">&quot;SA(1.0)&quot;</span><span class="p">,</span> <span class="s2">&quot;SA(0.3)&quot;</span><span class="p">,</span> <span class="s2">&quot;SA(3.0)&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_outliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">preferred_imts</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;derived_MMI_from_&quot;</span> <span class="o">+</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">df1</span><span class="p">:</span>
                <span class="n">ixx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_outliers&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;derived_MMI_from_&quot;</span> <span class="o">+</span> <span class="n">imtstr</span><span class="p">])</span>
                    <span class="o">|</span> <span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;derived_MMI_from_&quot;</span> <span class="o">+</span> <span class="n">imtstr</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span>
                <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;derived_MMI_from_&quot;</span> <span class="o">+</span> <span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span>
                <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI_outliers&quot;</span><span class="p">][</span><span class="n">ixx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">imts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;MMI&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Get the prediction and stddevs</span>
        <span class="c1">#</span>
        <span class="n">gmpe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;MMI&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
        <span class="p">)</span>
        <span class="n">pmean_rock</span><span class="p">,</span> <span class="n">pstddev_rock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">sx_rock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;MMI&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
        <span class="p">)</span>
        <span class="n">pmean_soil</span><span class="p">,</span> <span class="n">pstddev_soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">sx_soil</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;MMI&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
        <span class="p">)</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_rock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_rock</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma_rock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_rock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_soil&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean_soil</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_sigma_soil&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev_soil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span><span class="p">:</span>
            <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s2">&quot;default_stddev_inter_mmi&quot;</span><span class="p">]</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_pred_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmean</span>
        <span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">]</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_fillDataArrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each IMT get lists of the amplitudes that can contribute</span>
<span class="sd">        to the bias and the interpolation. Keep lists of IMT, period</span>
<span class="sd">        index, lons, lats, residuals, tau, phi, additional uncertainty,</span>
<span class="sd">        and rupture distance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imtsets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;df1&quot;</span><span class="p">,</span> <span class="s2">&quot;df2&quot;</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">imtsets</span><span class="p">[</span><span class="n">ndf</span><span class="p">],</span> <span class="n">sasets</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_imt_lists</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Fill the station arrays; here we use lists and append to</span>
            <span class="c1"># them because it is much faster than appending to a numpy</span>
            <span class="c1"># array; after the loop, the lists are converted to numpy</span>
            <span class="c1"># arrays:</span>
            <span class="c1">#</span>
            <span class="n">lons_rad</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># longitude (in radians) of the input station</span>
            <span class="n">lats_rad</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># latitude (in radians) of the input station</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># The residual of the input IMT</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># The between-event stddev of the input IMT</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># The within-event stddev of the input IMT</span>
            <span class="n">sig_extra</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Additional stddev of the input IMT</span>
            <span class="n">rrups</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># The rupture distance of the input station</span>
            <span class="n">per_ix</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;df1&quot;</span><span class="p">,</span> <span class="s2">&quot;df2&quot;</span><span class="p">):</span>
                <span class="n">tdf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">sdf</span> <span class="o">=</span> <span class="n">tdf</span><span class="o">.</span><span class="n">df</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])):</span>
                    <span class="c1">#</span>
                    <span class="c1"># Each station can provide 0, 1, or 2 IMTs:</span>
                    <span class="c1">#</span>
                    <span class="k">for</span> <span class="n">imtin</span> <span class="ow">in</span> <span class="n">_get_nearest_imts</span><span class="p">(</span>
                        <span class="n">imtstr</span><span class="p">,</span> <span class="n">imtsets</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">sasets</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">per_ix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtin</span><span class="p">])</span>
                        <span class="n">lons_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;lon_rad&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">lats_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;lat_rad&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">resids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">tau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">phi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s2">&quot;_pred_phi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">sig_extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">rrups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sta_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">per_ix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons_rad</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip_lons</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig_extra</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_rrups</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rrups</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_computeBias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a bias for all of the IMTs in the outputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
            <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># Get the index of the (pseudo-) period of the output IMT</span>
            <span class="c1">#</span>
            <span class="n">outperiod_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1"># Get the data and distance-limited residuals for computing</span>
            <span class="c1"># the bias</span>
            <span class="c1">#</span>
            <span class="n">sta_per_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="n">sta_lons_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="n">sta_lats_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="n">sta_tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="n">sta_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="n">sta_sig_extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>

            <span class="n">dix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_rrups</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_range</span>
            <span class="n">sta_resids_dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sta_resids_dl</span><span class="p">[</span><span class="n">dix</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1">#</span>
            <span class="c1"># If there are no stations, bail out</span>
            <span class="c1">#</span>
            <span class="n">nsta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nsta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_HH_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">nom_variance</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">bias_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
                <span class="c1">#</span>
                <span class="c1"># Write the nominal values of the bias and its stddev to log</span>
                <span class="c1">#</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: nom bias </span><span class="si">%f</span><span class="s2"> nom stddev </span><span class="si">%f</span><span class="s2">; </span><span class="si">%d</span><span class="s2"> stations (time=</span><span class="si">%f</span><span class="s2"> sec)&quot;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="n">imtstr</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nom_variance</span><span class="p">),</span>
                        <span class="n">nsta</span><span class="p">,</span>
                        <span class="n">bias_time</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1">#</span>
            <span class="c1"># Set up the IMT indices</span>
            <span class="c1">#</span>
            <span class="n">imt_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sta_per_ix</span><span class="p">))</span>
            <span class="n">len_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imt_types</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imt_types</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">imt_types</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">len_types</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_types</span>
            <span class="n">sa_inds</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_types</span><span class="p">):</span>
                <span class="n">sa_inds</span><span class="p">[</span><span class="n">imt_types</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sta_per_ix</span> <span class="o">==</span> <span class="n">imt_types</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">outperiod_ix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">imt_types</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_native_flag</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">imt_types_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">imt_types</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">outperiod_ix</span><span class="p">])])</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imt_Y_ind</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outperiod_ix</span> <span class="o">==</span> <span class="n">imt_types_alt</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_native_flag</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">#</span>
            <span class="c1"># Build T_D and corr_HH_D</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_native_flag</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">T_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="n">len_types</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_types</span><span class="p">):</span>
                    <span class="n">T_D</span><span class="p">[</span><span class="n">sa_inds</span><span class="p">[</span><span class="n">imt_types</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_tau</span><span class="p">[</span><span class="n">sa_inds</span><span class="p">[</span><span class="n">imt_types</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">corr_HH_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">len_types</span><span class="p">,</span> <span class="n">len_types</span><span class="p">))</span>
                <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_types</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">imt_types</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ones</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">imt_types</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ones</span><span class="o">.</span><span class="n">T</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">corr_HH_D</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">T_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="n">len_types</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_types</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_Y_ind</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_Y_ind</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]:</span>
                        <span class="n">T_D</span><span class="p">[</span><span class="n">sa_inds</span><span class="p">[</span><span class="n">imt_types</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_tau</span><span class="p">[</span>
                            <span class="n">sa_inds</span><span class="p">[</span><span class="n">imt_types</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="mi">0</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">T_D</span><span class="p">[</span><span class="n">sa_inds</span><span class="p">[</span><span class="n">imt_types</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_tau</span><span class="p">[</span>
                            <span class="n">sa_inds</span><span class="p">[</span><span class="n">imt_types</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]],</span> <span class="mi">0</span>
                        <span class="p">]</span>
                <span class="n">corr_HH_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">len_types</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len_types</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_types</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">imt_types_alt</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ones</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">imt_types_alt</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ones</span><span class="o">.</span><span class="n">T</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">corr_HH_D</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Make cov_WD_WD_inv (Sigma_22_inv)</span>
            <span class="c1">#</span>
            <span class="n">matrix22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="n">nsta</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="n">geodetic_distance_fast</span><span class="p">(</span>
                <span class="n">sta_lons_rad</span><span class="p">,</span> <span class="n">sta_lats_rad</span><span class="p">,</span> <span class="n">sta_lons_rad</span><span class="p">,</span> <span class="n">sta_lats_rad</span><span class="p">,</span> <span class="n">matrix22</span>
            <span class="p">)</span>
            <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">t1_22</span> <span class="o">=</span> <span class="n">sta_per_ix</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ones</span>
            <span class="n">t2_22</span> <span class="o">=</span> <span class="n">sta_per_ix</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ones</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_22</span><span class="p">,</span> <span class="n">t2_22</span><span class="p">,</span> <span class="n">matrix22</span><span class="p">)</span>
            <span class="n">sta_phi_flat</span> <span class="o">=</span> <span class="n">sta_phi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">make_sigma_matrix</span><span class="p">(</span><span class="n">matrix22</span><span class="p">,</span> <span class="n">sta_phi_flat</span><span class="p">,</span> <span class="n">sta_phi_flat</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">matrix22</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">matrix22</span><span class="p">)</span> <span class="o">+</span> <span class="n">sta_sig_extra</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cov_WD_WD_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">matrix22</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Hold on to some things we&#39;ll need later</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_D</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_D</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_WD_WD_inv</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov_WD_WD_inv</span>
            <span class="c1">#</span>
            <span class="c1"># Compute the bias mu_H_yD and cov_HH_yD pieces</span>
            <span class="c1">#</span>
            <span class="n">cov_HH_yD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T_D</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cov_WD_WD_inv</span><span class="p">,</span> <span class="n">T_D</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">corr_HH_D</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">mu_H_yD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">cov_HH_yD</span><span class="p">,</span> <span class="n">T_D</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cov_WD_WD_inv</span><span class="p">,</span> <span class="n">sta_resids_dl</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_bias</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_max_mag</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_H_yD</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu_H_yD</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_HH_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov_HH_yD</span>
            <span class="c1">#</span>
            <span class="c1"># Get the nominal bias and variance</span>
            <span class="c1">#</span>
            <span class="n">delta_B_yD</span> <span class="o">=</span> <span class="n">T_D</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu_H_yD</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">delta_B_yD</span><span class="p">)</span>
            <span class="n">sig_B_yD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T_D</span><span class="p">,</span> <span class="n">cov_HH_yD</span><span class="p">,</span> <span class="n">T_D</span><span class="o">.</span><span class="n">T</span><span class="p">])))</span>
            <span class="n">nom_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sig_B_yD</span><span class="p">)</span>

            <span class="n">bias_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
            <span class="c1">#</span>
            <span class="c1"># Write the nominal values of the bias and its stddev to log</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: nom bias </span><span class="si">%f</span><span class="s2"> nom stddev </span><span class="si">%f</span><span class="s2">; </span><span class="si">%d</span><span class="s2"> stations (time=</span><span class="si">%f</span><span class="s2"> sec)&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">imtstr</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nom_variance</span><span class="p">),</span>
                    <span class="n">nsta</span><span class="p">,</span>
                    <span class="n">bias_time</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_computeDirectivityPredictionLocations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figure out if we need the directivity factors, and if so, pre-calculate</span>
<span class="sd">        them. These will be used later in _computeMVN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Directivity for prediction locations...&quot;</span><span class="p">)</span>
            <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Precompute directivity at all periods</span>
            <span class="n">dir_out</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">),</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">T</span><span class="o">=</span><span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">(),</span>
                <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dir_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">))</span>
            <span class="c1"># Precompute directivity for the attenuation curves</span>
            <span class="n">dir_out</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s2">&quot;lats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s2">&quot;lons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atten_coords</span><span class="p">[</span><span class="s2">&quot;lats&quot;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">T</span><span class="o">=</span><span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">(),</span>
                <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dir_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">))</span>
            <span class="n">directivity_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Directivity prediction evaluation time: </span><span class="si">{</span><span class="n">directivity_time</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> sec&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directivity</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_computeMVN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do the MVN computations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;computeMVN: doing IMT </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Get the index of the (pesudo-) period of the output IMT</span>
        <span class="c1">#</span>
        <span class="n">outperiod_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># Get the predictions at the output points</span>
        <span class="c1">#</span>
        <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
            <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">__from_config__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gmpe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span>

        <span class="n">pout_mean</span><span class="p">,</span> <span class="n">pout_sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                <span class="n">pout_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmice</span><span class="o">.</span><span class="n">getPreferredMI</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span><span class="p">,</span> <span class="n">dists</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="o">.</span><span class="n">rrup</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pout_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># While we have the gmpe for this IMT, we should make</span>
        <span class="c1"># the attenuation curves</span>
        <span class="c1">#</span>
        <span class="n">x_mean</span><span class="p">,</span> <span class="n">x_sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_rock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_mean</span><span class="p">,</span> <span class="n">x_sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmas</span><span class="p">(</span>
            <span class="n">gmpe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_sx_soil</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_gafs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># Get an array of the within-event standard deviations for the</span>
        <span class="c1"># output IMT at the output points</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
            <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span>
            <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s2">&quot;default_stddev_inter&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_total_sd_only</span>
            <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s2">&quot;default_stddev_inter_mmi&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">total_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_guess</span> <span class="o">*</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pout_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># If there are no data, just use the unbiased prediction</span>
        <span class="c1"># and the stddev</span>
        <span class="c1">#</span>
        <span class="n">nsta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">nsta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_mean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outphi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outtau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="c1"># Special stuff for the MMI priors. When we make this apply to other</span>
            <span class="c1"># IMTs we&#39;ll need to mess around with this block</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">MMI_add_uncertainty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">MMI_Sigma_HH_YD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">MMI_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">MMI_sta_per_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">return</span>

        <span class="n">pout_sd2_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">sta_per_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="n">sta_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="n">sta_lons_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="n">sta_lats_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>

        <span class="n">len_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_native_flag</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">T_Y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">len_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_types</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]))</span>
            <span class="n">T_Y0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outperiod_ix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_types</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span>
                <span class="n">imtstr</span>
            <span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T_Y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">len_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_types</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">T_Y0</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_Y_ind</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">T_D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_D</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="n">cov_WD_WD_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_WD_WD_inv</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># Now do the MVN itself...</span>
        <span class="c1">#</span>
        <span class="n">dtime</span> <span class="o">=</span> <span class="n">mtime</span> <span class="o">=</span> <span class="n">ddtime</span> <span class="o">=</span> <span class="n">ctime</span> <span class="o">=</span> <span class="n">stime</span> <span class="o">=</span> <span class="n">atime</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">T_Y0</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">C_tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">C_tmp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">s_tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">s_tmp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">s_tmp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">ampgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">)</span>
        <span class="n">cov_WY_WY_WD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">)</span>
        <span class="n">sdgrid_tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">)</span>
        <span class="c1"># Stuff that doesn&#39;t change within the loop:</span>
        <span class="n">lons_out_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons_out_rad</span>
        <span class="n">lats_out_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats_out_rad</span>
        <span class="n">d12_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">d12_cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">t1_12</span> <span class="o">=</span> <span class="n">sta_per_ix</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ones</span>
        <span class="n">t2_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">d12_cols</span><span class="p">,</span> <span class="n">nsta</span><span class="p">),</span> <span class="n">outperiod_ix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="c1"># sdsta is the standard deviation of the stations</span>
        <span class="n">sdsta_phi</span> <span class="o">=</span> <span class="n">sta_phi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">matrix12_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">t2_12</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">rcmatrix_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">t2_12</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="c1"># Allocate the full C matrix only for the desired IMT (MMI). This</span>
        <span class="c1"># is for generating realizations. Someday we will want to make this</span>
        <span class="c1"># apply to other IMTs and become an optional flag for this module</span>
        <span class="c1"># where we save the priors optionally</span>
        <span class="c1"># Note: We would have to set up C_complete = {} at the top of the</span>
        <span class="c1"># module, and then here, it would be C_complete[imtstr] = ...</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
            <span class="n">C_complete</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">T_Y0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smny</span><span class="p">):</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
            <span class="n">se</span> <span class="o">=</span> <span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">geodetic_distance_fast</span><span class="p">(</span>
                <span class="n">sta_lons_rad</span><span class="p">,</span>
                <span class="n">sta_lats_rad</span><span class="p">,</span>
                <span class="n">lons_out_rad</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">],</span>
                <span class="n">lats_out_rad</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">],</span>
                <span class="n">matrix12_phi</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ddtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_12</span><span class="p">,</span> <span class="n">t2_12</span><span class="p">,</span> <span class="n">matrix12_phi</span><span class="p">)</span>
            <span class="n">ctime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># sdarr_phi is the standard deviation of the within-event</span>
            <span class="c1"># residuals at the output sites</span>
            <span class="n">sdarr_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">make_sigma_matrix</span><span class="p">(</span><span class="n">matrix12_phi</span><span class="p">,</span> <span class="n">sdsta_phi</span><span class="p">,</span> <span class="n">sdarr_phi</span><span class="p">)</span>
            <span class="n">stime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># Sigma12 * Sigma22^-1 is known as the &#39;regression</span>
            <span class="c1"># coefficient&#39; matrix (rcmatrix)</span>
            <span class="c1">#</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix12_phi</span><span class="p">,</span> <span class="n">cov_WD_WD_inv</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">rcmatrix_phi</span><span class="p">)</span>
            <span class="n">dtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># We only want the diagonal elements of the conditional</span>
            <span class="c1"># covariance matrix, so there is no point in doing the</span>
            <span class="c1"># full solution with the dot product, e.g.:</span>
            <span class="c1"># sdgrid[ss:se] = pout_sd2[ss:se] -</span>
            <span class="c1">#       np.diag(rcmatrix.dot(sigma21))</span>
            <span class="c1">#</span>
            <span class="c1"># make_sd_array is a Cython function that is optimized to find</span>
            <span class="c1"># the diagonal of the covariance matrix.</span>
            <span class="c1">#</span>
            <span class="n">make_sd_array</span><span class="p">(</span><span class="n">cov_WY_WY_WD</span><span class="p">,</span> <span class="n">pout_sd2_phi</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">rcmatrix_phi</span><span class="p">,</span> <span class="n">matrix12_phi</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Equation B32 of Engler et al. (2021)</span>
            <span class="c1">#</span>
            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">T_Y0</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rcmatrix_phi</span><span class="p">,</span> <span class="n">T_D</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">C_tmp1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">C</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># This is the MVN solution for the conditional mean</span>
            <span class="c1"># It is an implementation of the equation just below</span>
            <span class="c1"># equation B25 in Engler et al. (2021):</span>
            <span class="c1">#</span>
            <span class="c1"># mu_Y_yD = mu_Y + C mu_H_yD + cov_WY_WD cov_WD_WD^-1 zeta</span>
            <span class="c1">#</span>
            <span class="c1"># but we break it up for efficiency.</span>
            <span class="c1">#</span>
            <span class="n">s_tmp1r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">s_tmp1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
            <span class="n">s_tmp2r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rcmatrix_phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">s_tmp2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="n">ampgrid</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:],</span> <span class="n">s_tmp1r</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">s_tmp1r</span><span class="p">),</span> <span class="n">s_tmp2r</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">s_tmp2r</span>
            <span class="p">)</span>
            <span class="n">atime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
            <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># We&#39;re doing this:</span>
            <span class="c1">#</span>
            <span class="c1"># sdgrid_tau[iy, :] = np.diag(</span>
            <span class="c1">#     C.dot(self.cov_HH_yD[imtstr].dot(C.T)))</span>
            <span class="c1">#</span>
            <span class="c1"># to find the between-event part of the diagonal of the conditional</span>
            <span class="c1"># covariance.  This is the second term of equation B27 of Engler</span>
            <span class="c1"># et al. (2021). The code below is faster and uses less memory than</span>
            <span class="c1"># actually implementing the above equation.</span>
            <span class="c1">#</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_HH_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">C_tmp1</span><span class="p">)</span>
            <span class="n">sdgrid_tau</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">C_tmp1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">C_tmp2</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">s_tmp3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># This is where we would have a flag if we were saving the priors</span>
            <span class="c1"># as an option</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                <span class="c1"># Save C to complete full size C</span>
                <span class="n">C_complete</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">C</span>

            <span class="n">mtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
        <span class="c1">#</span>
        <span class="c1"># This processing can result in MMI values that go beyond</span>
        <span class="c1"># the 1 to 10 bounds of MMI, so we apply that constraint again</span>
        <span class="c1"># here</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
            <span class="n">ampgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ampgrid</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># The conditional mean</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampgrid</span>
        <span class="c1">#</span>
        <span class="c1"># The outputs are the conditional total stddev, the conditional</span>
        <span class="c1"># between-event stddev (tau), and the prior within-event stddev (phi)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cov_WY_WY_WD</span><span class="p">,</span> <span class="n">sdgrid_tau</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">cov_WY_WY_WD</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">cov_WY_WY_WD</span>
        <span class="p">)</span>
        <span class="c1"># self.outphi[imtstr] = np.sqrt(cov_WY_WY_WD)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outphi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outtau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sdgrid_tau</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">sdgrid_tau</span><span class="p">)</span>

        <span class="c1"># Special stuff for the MMI priors. When we make this apply to other</span>
        <span class="c1"># IMTs we&#39;ll need to mess around with this block</span>
        <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MMI_add_uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MMI_Sigma_HH_YD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_HH_yD</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MMI_C</span> <span class="o">=</span> <span class="n">C_complete</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MMI_sta_per_ix</span> <span class="o">=</span> <span class="n">sta_per_ix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">time for </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> distance=</span><span class="si">{</span><span class="n">ddtime</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">time for </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> correlation=</span><span class="si">{</span><span class="n">ctime</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">time for </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> sigma=</span><span class="si">{</span><span class="n">stime</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">time for </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> rcmatrix=</span><span class="si">{</span><span class="n">dtime</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">time for </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> amp calc=</span><span class="si">{</span><span class="n">atime</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">time for </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> sd calc=</span><span class="si">{</span><span class="n">mtime</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total time for </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_applyCustomMask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply custom masks to IMT grid outputs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">grid</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span> <span class="nf">_getLandMask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the landmask for this map. Land will be False, water will</span>
<span class="sd">        be True (because of the way masked arrays work).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;CALLED_FROM_PYTEST&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">oceans</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oceans</span> <span class="o">=</span> <span class="n">shpreader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span>
                <span class="n">category</span><span class="o">=</span><span class="s2">&quot;physical&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ocean&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s2">&quot;10m&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMask</span><span class="p">(</span><span class="n">oceans</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a masked array for this map corresponding to the given vector</span>
<span class="sd">        feature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">gd</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="o">.</span><span class="n">createDictFromBox</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span>
        <span class="p">)</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">gd</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gd</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">tshapes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">))</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tshp</span> <span class="ow">in</span> <span class="n">tshapes</span><span class="p">:</span>
                <span class="n">shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">tshp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">):</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="o">.</span><span class="n">rasterizeFromGeometry</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">gd</span><span class="p">,</span> <span class="n">fillValue</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">grid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gd</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">gd</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMaskedGrids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bmask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each grid in the output, generate a grid with the water areas</span>
<span class="sd">        masked out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">moutgrid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">imtout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
                <span class="n">moutgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">moutgrid</span>
        <span class="k">for</span> <span class="n">imtout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
            <span class="n">moutgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">bmask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">moutgrid</span>

    <span class="k">def</span> <span class="nf">_getInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moutgrid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an info dictionary that can be made into the info.json file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Get the map grade</span>
        <span class="c1">#</span>
        <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span> <span class="o">=</span> <span class="n">_get_map_grade</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_raw</span><span class="p">,</span> <span class="n">moutgrid</span>
        <span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># This is the metadata for creating info.json</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">st</span> <span class="o">=</span> <span class="s2">&quot;strec&quot;</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;input&quot;</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="s2">&quot;event_information&quot;</span>
        <span class="n">op</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="s2">&quot;ground_motions&quot;</span>
        <span class="n">mi</span> <span class="o">=</span> <span class="s2">&quot;map_information&quot;</span>
        <span class="n">un</span> <span class="o">=</span> <span class="s2">&quot;uncertainty&quot;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="s2">&quot;processing&quot;</span>
        <span class="n">gmm</span> <span class="o">=</span> <span class="s2">&quot;ground_motion_modules&quot;</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="s2">&quot;miscellaneous&quot;</span>
        <span class="n">sv</span> <span class="o">=</span> <span class="s2">&quot;shakemap_versions&quot;</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="s2">&quot;site_response&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_depth</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;event_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span>

        <span class="c1"># look for the presence of a strec_results file and read it in</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">data_path</span> <span class="o">=</span> <span class="n">get_config_paths</span><span class="p">()</span>
        <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">)</span>
        <span class="n">strecfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;strec_results.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">strecfile</span><span class="p">):</span>
            <span class="n">strec_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">strecfile</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">))</span>
            <span class="n">info</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">strec_results</span>

        <span class="c1"># the following items are primarily useful for PDL</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;eventsource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">netid</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;netid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">netid</span>
        <span class="c1"># The netid could be a valid part of the eventsourcecode, so we have</span>
        <span class="c1"># to check here if it ***starts with*** the netid</span>
        <span class="k">if</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">netid</span><span class="p">):</span>
            <span class="n">eventsourcecode</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">netid</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eventsourcecode</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;eventsourcecode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventsourcecode</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;productcode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">productcode</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;productsource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;source_network&quot;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;producttype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;product_type&quot;</span><span class="p">]</span>

        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;event_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;reference&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;fault_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rupture_obj</span><span class="o">.</span><span class="n">getReference</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;df2&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;intensity_observations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;intensity_observations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lat</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lon</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">locstring</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TIMEFMT</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;df1&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;seismic_stations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;seismic_stations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;src_mech&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">mech</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;source_description&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;event_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span>
                <span class="s2">&quot;source_description&quot;</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;event_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">locstring</span>
        <span class="c1"># This AND src_mech?</span>
        <span class="c1"># look at the origin information for indications that this</span>
        <span class="c1"># event is a scenario</span>
        <span class="n">condition1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;event_type&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">origin</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;scenario&quot;</span>
        <span class="p">)</span>
        <span class="n">condition2</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_se&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">condition1</span> <span class="ow">or</span> <span class="n">condition2</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;event_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCENARIO&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s2">&quot;event_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ACTUAL&quot;</span>

        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;intensity&quot;</span>
            <span class="k">elif</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s2">&quot;PGV&quot;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;cms&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;g&quot;</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="k">if</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">myimt</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s2">&quot;max_grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">]),</span> <span class="mi">3</span>
                <span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s2">&quot;max_grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">])),</span> <span class="mi">3</span>
                <span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">])),</span> <span class="mi">3</span>
                <span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_points&quot;</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smnx</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_points&quot;</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smny</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_points&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_spacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_spacing&quot;</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_spacing&quot;</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_spacing&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;degrees&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_span&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_span&quot;</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="mf">360.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="mi">3</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_span&quot;</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_span&quot;</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;grid_span&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;degrees&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">min_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="n">max_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the negative side</span>
                <span class="n">min_long</span> <span class="o">=</span> <span class="n">min_long</span> <span class="o">-</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_long</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the positive side</span>
                <span class="n">max_long</span> <span class="o">=</span> <span class="n">max_long</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="n">min_long</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="n">max_long</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;degrees&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;degrees&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mygrade</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s2">&quot;mean_uncertainty_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_round</span><span class="p">(</span><span class="n">mean_rat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;df2&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s2">&quot;total_flagged_mi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMI_outliers&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">]))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s2">&quot;total_flagged_mi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;df1&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">all_flagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;MMI&quot;</span> <span class="ow">in</span> <span class="n">imtstr</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">all_flagged</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">all_flagged</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">]</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s2">&quot;total_flagged_pgm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_flagged</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s2">&quot;total_flagged_pgm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;gmpe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;gmpe&quot;</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;gmpe&quot;</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;gmpe&quot;</span><span class="p">][</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;ipe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;ipe&quot;</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ipe_modules&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;ipe&quot;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;ipe&quot;</span><span class="p">][</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;gmice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;gmice&quot;</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gmice_modules&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;gmice&quot;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;gmice&quot;</span><span class="p">][</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;ccf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;ccf&quot;</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ccf_modules&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;ccf&quot;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;ccf&quot;</span><span class="p">][</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;basin_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;basin_correction&quot;</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;basin_correction&quot;</span><span class="p">][</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;directivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;directivity&quot;</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s2">&quot;directivity&quot;</span><span class="p">][</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s2">&quot;bias_max_dsigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_max_dsigma</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s2">&quot;bias_max_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_max_mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s2">&quot;bias_max_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_max_range</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s2">&quot;median_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s2">&quot;do_outliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_outliers</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s2">&quot;outlier_deviation_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outlier_deviation_level</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s2">&quot;outlier_max_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outlier_max_mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s2">&quot;shakemap_revision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_versions</span><span class="p">()[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s2">&quot;shakemap_revision_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_versions</span><span class="p">()[</span><span class="s2">&quot;full-revisionid&quot;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s2">&quot;process_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ALT_TIMEFMT</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">())</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s2">&quot;map_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s2">&quot;history&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s2">&quot;map_comment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s2">&quot;history&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s2">&quot;map_data_history&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s2">&quot;history&quot;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s2">&quot;map_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;map_status&quot;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">][</span><span class="s2">&quot;vs30default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30default</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">][</span><span class="s2">&quot;site_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GMPE native&quot;</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">_fillStationJSON</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the station JSON dictionary and then add a bunch of stuff to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;stations&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;eventid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">sjdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Compute a bias for all the output IMTs in the data frames</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
            <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span><span class="p">[</span><span class="n">myimt</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="n">mybias</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span><span class="p">[</span><span class="n">myimt</span><span class="p">]</span>
                    <span class="n">mybias_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_HH_yD</span><span class="p">[</span><span class="n">myimt</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mybias</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_H_yD</span><span class="p">[</span><span class="n">myimt</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mybias_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_pred_tau&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_HH_yD</span><span class="p">[</span><span class="n">myimt</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_bias&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mybias</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_bias_sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mybias_sig</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Add the station data. The stationlist object has the original</span>
        <span class="c1"># data and produces a GeoJSON object (a dictionary, really), but</span>
        <span class="c1"># we need to add peak values and flagging that has been done here.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1">#</span>
        <span class="c1"># First make a dictionary of distances</span>
        <span class="c1">#</span>
        <span class="n">dist_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;df1&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;df2&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">dx</span>
            <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
                <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">dm</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm_arr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rrup&quot;</span><span class="p">,</span> <span class="s2">&quot;rjb&quot;</span><span class="p">):</span>
                    <span class="n">dm_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dm</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dm_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">dm</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm_var</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">dm</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Get the index for each station ID</span>
        <span class="c1">#</span>
        <span class="n">sjdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">getGeoJson</span><span class="p">()</span>
        <span class="n">sta_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;df1&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;df2&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">ndf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
            <span class="n">sta_ix</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))))</span>
        <span class="c1">#</span>
        <span class="c1"># Now go through the GeoJSON and add various properties and</span>
        <span class="c1"># amps from the df_dict dictionaries</span>
        <span class="c1">#</span>
        <span class="n">sjdict_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sjdict</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">sjdict_copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">station</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s2">&quot;df1&quot;</span><span class="p">]:</span>
                <span class="n">ndf</span> <span class="o">=</span> <span class="s2">&quot;df1&quot;</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;station_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;seismic&quot;</span>
            <span class="k">elif</span> <span class="n">station</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s2">&quot;df2&quot;</span><span class="p">]:</span>
                <span class="n">ndf</span> <span class="o">=</span> <span class="s2">&quot;df2&quot;</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;station_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;macroseismic&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We&#39;re probably using --no_seismic or --no_macroseismic</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_seismic</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_macroseismic</span><span class="p">:</span>
                    <span class="n">sjdict</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown station </span><span class="si">{</span><span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> in stationlist&quot;</span><span class="p">)</span>
            <span class="n">dfx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="n">dfx</span><span class="o">.</span><span class="n">df</span>
            <span class="n">six</span> <span class="o">=</span> <span class="n">sta_ix</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">station</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span>
            <span class="c1">#</span>
            <span class="c1"># Set the &#39;intensity&#39;, &#39;pga&#39;, and &#39;pga&#39; peak properties</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;MMI&quot;</span> <span class="ow">in</span> <span class="n">sdf</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;MMI_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;intensity_stddev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;MMI_sd&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;MMI_nresp&quot;</span> <span class="ow">in</span> <span class="n">sdf</span><span class="p">:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nresp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;MMI_nresp&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nresp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;intensity_stddev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nresp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;PGA&quot;</span> <span class="ow">in</span> <span class="n">sdf</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;PGA_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;PGA&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">ndf</span> <span class="o">!=</span> <span class="s2">&quot;df1&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;pga&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_float</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;PGA&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;pga&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;PGV&quot;</span> <span class="ow">in</span> <span class="n">sdf</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;PGV_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;PGV&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">ndf</span> <span class="o">!=</span> <span class="s2">&quot;df1&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;pgv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;PGV&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;pgv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Add vs30</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;vs30&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">dfx</span><span class="o">.</span><span class="n">sx</span><span class="o">.</span><span class="n">vs30</span><span class="p">[</span><span class="n">six</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Add the predictions so we can plot residuals</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;predictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sdf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_pred&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">myamp</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">myamp_rock</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_rock&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">myamp_soil</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_soil&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">tau_str</span> <span class="o">=</span> <span class="s2">&quot;ln_tau&quot;</span>
                <span class="n">phi_str</span> <span class="o">=</span> <span class="s2">&quot;ln_phi&quot;</span>
                <span class="n">sigma_str</span> <span class="o">=</span> <span class="s2">&quot;ln_sigma&quot;</span>
                <span class="n">sigma_str_rock</span> <span class="o">=</span> <span class="s2">&quot;ln_sigma_rock&quot;</span>
                <span class="n">sigma_str_soil</span> <span class="o">=</span> <span class="s2">&quot;ln_sigma_soil&quot;</span>
                <span class="n">bias_str</span> <span class="o">=</span> <span class="s2">&quot;ln_bias&quot;</span>
                <span class="n">bias_sigma_str</span> <span class="o">=</span> <span class="s2">&quot;ln_bias_sigma&quot;</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;PGV&quot;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span>
                    <span class="n">value_rock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_rock</span><span class="p">)</span>
                    <span class="n">value_soil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_soil</span><span class="p">)</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;cm/s&quot;</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;MMI&quot;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">myamp</span>
                    <span class="n">value_rock</span> <span class="o">=</span> <span class="n">myamp_rock</span>
                    <span class="n">value_soil</span> <span class="o">=</span> <span class="n">myamp_soil</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;intensity&quot;</span>
                    <span class="n">tau_str</span> <span class="o">=</span> <span class="s2">&quot;tau&quot;</span>
                    <span class="n">phi_str</span> <span class="o">=</span> <span class="s2">&quot;phi&quot;</span>
                    <span class="n">sigma_str</span> <span class="o">=</span> <span class="s2">&quot;sigma&quot;</span>
                    <span class="n">sigma_str_rock</span> <span class="o">=</span> <span class="s2">&quot;sigma_rock&quot;</span>
                    <span class="n">sigma_str_soil</span> <span class="o">=</span> <span class="s2">&quot;sigma_soil&quot;</span>
                    <span class="n">bias_str</span> <span class="o">=</span> <span class="s2">&quot;bias&quot;</span>
                    <span class="n">bias_sigma_str</span> <span class="o">=</span> <span class="s2">&quot;bias_sigma&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">value_rock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_rock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">value_soil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp_soil</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_total_sd_only</span><span class="p">:</span>
                    <span class="n">mytau</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mytau</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_tau&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">myphi</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_phi&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">mysigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mytau</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">myphi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">mysigma_rock</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_sigma_rock&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">mysigma_soil</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_sigma_soil&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="n">imt_name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_pred&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">imt_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imt_out_set</span><span class="p">:</span>
                    <span class="n">mybias</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">imt_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_bias&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">mybias_sigma</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">imt_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_bias_sigma&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mybias</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                    <span class="n">mybias_sigma</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;predictions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">imt_name</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="s2">&quot;value_rock&quot;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value_rock</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="s2">&quot;value_soil&quot;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value_soil</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                        <span class="n">tau_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mytau</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">phi_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">myphi</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">sigma_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysigma</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">sigma_str_rock</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysigma_rock</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">sigma_str_soil</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysigma_soil</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">bias_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mybias</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">bias_sigma_str</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mybias_sigma</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># For df1 stations, add the MMIs comverted from PGM</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">ndf</span> <span class="o">==</span> <span class="s2">&quot;df1&quot;</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;mmi_from_pgm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">dimtstr</span> <span class="o">=</span> <span class="s2">&quot;derived_MMI_from_&quot;</span> <span class="o">+</span> <span class="n">myimt</span>
                    <span class="k">if</span> <span class="n">dimtstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sdf</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">imt_name</span> <span class="o">=</span> <span class="n">myimt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">myamp</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">dimtstr</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">mysd</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">dimtstr</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">myamp</span><span class="p">):</span>
                        <span class="n">myamp</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                        <span class="n">mysd</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;Outlier&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                    <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;mmi_from_pgm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">imt_name</span><span class="p">,</span>
                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">myamp</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysd</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="n">flag</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># For df2 stations, add the PGMs converted from MMI</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">ndf</span> <span class="o">==</span> <span class="s2">&quot;df2&quot;</span><span class="p">:</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;pgm_from_mmi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndf</span><span class="p">)</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">imt_name</span> <span class="o">=</span> <span class="n">myimt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">myamp</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">mysd</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s2">&quot;PGV&quot;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;cm/s&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                        <span class="n">mysd</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sdf</span><span class="p">[</span><span class="n">myimt</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;Outlier&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                    <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;pgm_from_mmi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">imt_name</span><span class="p">,</span>
                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                            <span class="s2">&quot;ln_sigma&quot;</span><span class="p">:</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">mysd</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                            <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="n">flag</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Set the generic distance property (this is rrup)</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;rrup&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;distance_stddev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;rrup_var&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]),</span> <span class="mi">3</span>
            <span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Set the specific distances properties</span>
            <span class="c1">#</span>
            <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span> <span class="ow">in</span> <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;distances&quot;</span><span class="p">][</span><span class="n">dm</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">[</span><span class="n">six</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Set the outlier flags</span>
            <span class="c1">#</span>
            <span class="n">mflag</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
            <span class="k">if</span> <span class="n">ndf</span> <span class="o">==</span> <span class="s2">&quot;df1&quot;</span> <span class="ow">and</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                <span class="n">mflag</span> <span class="o">=</span> <span class="s2">&quot;ManuallyFlagged&quot;</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">station</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;channels&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">amp</span> <span class="ow">in</span> <span class="n">channel</span><span class="p">[</span><span class="s2">&quot;amplitudes&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">amp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                        <span class="n">amp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">mflag</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">amp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mflag</span>
                    <span class="n">Name</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">sdf</span><span class="p">[</span><span class="n">Name</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">amp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                            <span class="n">amp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Outlier&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">amp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,Outlier&quot;</span>
        <span class="n">sjdict</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;eventid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">sjdict</span>

    <span class="k">def</span> <span class="nf">_storeGriddedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store gridded data in the output container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">min_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="n">max_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the negative side</span>
                <span class="n">min_long</span> <span class="o">=</span> <span class="n">min_long</span> <span class="o">-</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_long</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Crossing the 180 from the positive side</span>
                <span class="n">max_long</span> <span class="o">=</span> <span class="n">max_long</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_long</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_long</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smnx</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smny</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span>
        <span class="c1">#</span>
        <span class="c1"># Put the Vs30 grid in the output container</span>
        <span class="c1">#</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="s2">&quot;vs30&quot;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;digits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([],</span> <span class="s2">&quot;vs30&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">vs30</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Now do the distance grids</span>
        <span class="c1">#</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;km&quot;</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;digits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
            <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s2">&quot;distances&quot;</span><span class="p">],</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rrup&quot;</span><span class="p">,</span> <span class="s2">&quot;rjb&quot;</span><span class="p">):</span>
                <span class="n">dm_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dm_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">)</span>
                <span class="n">dm_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dm_var</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s2">&quot;distances&quot;</span><span class="p">],</span> <span class="n">dm</span> <span class="o">+</span> <span class="s2">&quot;_std&quot;</span><span class="p">,</span> <span class="n">dm_std</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Output the data and uncertainty grids</span>
        <span class="c1">#</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>
        <span class="n">std_metadata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># set the data grid</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;digits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span>

            <span class="c1"># set the mean and uncertainty grids</span>
            <span class="n">std_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">)</span>
            <span class="n">std_metadata</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="n">std_metadata</span><span class="p">[</span><span class="s2">&quot;digits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setIMTGrids</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">component</span><span class="p">,</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="n">metadata</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="n">std_metadata</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outphi</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outtau</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                <span class="n">sub_groups</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;imts&quot;</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="n">sub_groups</span><span class="p">,</span> <span class="s2">&quot;add_uncertainty&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMI_add_uncertainty</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="n">sub_groups</span><span class="p">,</span> <span class="s2">&quot;Sigma_HH_YD&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMI_Sigma_HH_YD</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="n">sub_groups</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMI_C</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="n">sub_groups</span><span class="p">,</span> <span class="s2">&quot;sta_per_ix&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMI_sta_per_ix</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="n">sub_groups</span><span class="p">,</span> <span class="s2">&quot;sta_phi&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_phi</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">])</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="n">sub_groups</span><span class="p">,</span> <span class="s2">&quot;sta_lons_rad&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">])</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="n">sub_groups</span><span class="p">,</span> <span class="s2">&quot;sta_lats_rad&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_lats_rad</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># Directivity</span>
        <span class="c1">#</span>
        <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;digits&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">imtstr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s2">&quot;directivity&quot;</span><span class="p">],</span> <span class="n">imtstr</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_storePointData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store point data in the output container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Store the Vs30</span>
        <span class="c1">#</span>
        <span class="n">vs30_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;m/s&quot;</span><span class="p">,</span> <span class="s2">&quot;digits&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([],</span> <span class="s2">&quot;vs30&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">vs30</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">metadata</span><span class="o">=</span><span class="n">vs30_metadata</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Store the distances</span>
        <span class="c1">#</span>
        <span class="n">distance_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span> <span class="s2">&quot;digits&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
            <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">([</span><span class="s2">&quot;distances&quot;</span><span class="p">],</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">metadata</span><span class="o">=</span><span class="n">distance_metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rrup&quot;</span><span class="p">,</span> <span class="s2">&quot;rjb&quot;</span><span class="p">):</span>
                <span class="n">dm_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dm_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">],</span>
                    <span class="n">dm</span> <span class="o">+</span> <span class="s2">&quot;_std&quot;</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dm_var</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">distance_metadata</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Store the IMTs</span>
        <span class="c1">#</span>
        <span class="n">ascii_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;interp&quot;</span><span class="p">][</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgrid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># set the data grid</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">mean_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span> <span class="s2">&quot;digits&quot;</span><span class="p">:</span> <span class="n">digits</span><span class="p">}</span>
            <span class="c1"># set the uncertainty grid</span>
            <span class="n">std_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">_get_layer_info</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span><span class="p">)</span>
            <span class="n">std_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span> <span class="s2">&quot;digits&quot;</span><span class="p">:</span> <span class="n">digits</span><span class="p">}</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setIMTArrays</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">component</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lons</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sx_out</span><span class="o">.</span><span class="n">lats</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">ascii_ids</span><span class="p">,</span>
                <span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">mean_metadata</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outsd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">std_metadata</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outphi</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outtau</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_storeAttenuationData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output arrays of rock and soil attenuation curves</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">dist_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;repi&quot;</span><span class="p">,</span> <span class="s2">&quot;rhypo&quot;</span><span class="p">,</span> <span class="s2">&quot;rrup&quot;</span><span class="p">,</span> <span class="s2">&quot;rjb&quot;</span><span class="p">]:</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;attenuation&quot;</span><span class="p">,</span> <span class="s2">&quot;distances&quot;</span><span class="p">],</span>
                <span class="n">dist_type</span><span class="p">,</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atten_dx</span><span class="p">,</span> <span class="n">dist_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">imtstrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imtstrs</span><span class="p">:</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;attenuation&quot;</span><span class="p">,</span> <span class="s2">&quot;rock&quot;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;attenuation&quot;</span><span class="p">,</span> <span class="s2">&quot;soil&quot;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_mean</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;attenuation&quot;</span><span class="p">,</span> <span class="s2">&quot;rock&quot;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_rock_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;attenuation&quot;</span><span class="p">,</span> <span class="s2">&quot;soil&quot;</span><span class="p">,</span> <span class="n">imtstr</span><span class="p">],</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_soil_sd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span>

    <span class="c1">#</span>
    <span class="c1"># Helper function to call get_mean_and_stddevs for the</span>
    <span class="c1"># appropriate object given the IMT and describe the</span>
    <span class="c1"># MultiGMPE structure.</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_gmas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gmpe</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">apply_gafs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a helper function to call get_mean_and_stddevs for the</span>
<span class="sd">        appropriate object given the IMT.</span>

<span class="sd">        Args:</span>
<span class="sd">            gmpe:</span>
<span class="sd">                A GMPE instance.</span>
<span class="sd">            sx:</span>
<span class="sd">                Sites context.</span>
<span class="sd">            dx:</span>
<span class="sd">                Distance context.</span>
<span class="sd">            oqimt:</span>
<span class="sd">                List of OpenQuake IMTs.</span>
<span class="sd">            apply_gafs (boolean):</span>
<span class="sd">                Whether or not to apply the generic</span>
<span class="sd">                amplification factors to the GMPE output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Tuple of two items:</span>

<span class="sd">                - Numpy array of means,</span>
<span class="sd">                - List of numpy array of standard deviations corresponding to</span>
<span class="sd">                  therequested stddev_types.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;MMI&quot;</span> <span class="ow">in</span> <span class="n">oqimt</span><span class="p">:</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe</span>
            <span class="n">sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipe_stddev_types</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_info&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;multigmpe&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">gmpe</span>
            <span class="n">sd_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmpe_stddev_types</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_simulations</span><span class="p">:</span>
                <span class="c1"># --------------------------------------------------------------------</span>
                <span class="c1"># Describe the MultiGMPE</span>
                <span class="c1"># --------------------------------------------------------------------</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_info&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;multigmpe&quot;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="s2">&quot;multigmpe&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)]</span> <span class="o">=</span> <span class="n">gmpe</span><span class="o">.</span><span class="n">__describe__</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">mean</span><span class="p">,</span> <span class="n">stddevs</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_mean_and_stddevs</span><span class="p">(</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rx</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">sd_types</span>
        <span class="p">)</span>

        <span class="c1"># Include generic amp factors?</span>
        <span class="k">if</span> <span class="n">apply_gafs</span><span class="p">:</span>
            <span class="n">gafs</span> <span class="o">=</span> <span class="n">get_generic_amp_factors</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">gafs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">+=</span> <span class="n">gafs</span>

        <span class="c1"># Does directivity apply to this imt?</span>
        <span class="n">row_pers</span> <span class="o">=</span> <span class="n">Rowshandel2013</span><span class="o">.</span><span class="n">getPeriods</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;PGA&quot;</span><span class="p">:</span>
            <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;PGV&quot;</span> <span class="ow">or</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
            <span class="n">tper</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="s2">&quot;SA&quot;</span> <span class="ow">in</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
            <span class="n">tper</span> <span class="o">=</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">period</span>
            <span class="n">min_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">row_pers</span><span class="p">)</span>
            <span class="n">max_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">row_pers</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tper</span> <span class="o">&gt;=</span> <span class="n">min_per</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tper</span> <span class="o">&lt;=</span> <span class="n">max_per</span><span class="p">):</span>
                <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imt_ok</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Did we calculate directivity?</span>
        <span class="n">calc_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_directivity</span>

        <span class="k">if</span> <span class="n">calc_dir</span> <span class="ow">and</span> <span class="n">imt_ok</span><span class="p">:</span>
            <span class="c1"># Use distance context to figure out which directivity result</span>
            <span class="c1"># we need to use.</span>
            <span class="n">all_fd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">dirdf</span><span class="p">,</span> <span class="n">tmpdx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dx</span> <span class="o">==</span> <span class="n">tmpdx</span><span class="p">:</span>
                    <span class="n">all_fd</span> <span class="o">=</span> <span class="n">dirdf</span><span class="o">.</span><span class="n">getFd</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">all_fd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to detect dataframe for directivity calculation.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Does oqimt match any of those periods?</span>
            <span class="k">if</span> <span class="n">tper</span> <span class="ow">in</span> <span class="n">row_pers</span><span class="p">:</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">all_fd</span><span class="p">[</span><span class="n">row_pers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tper</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Log(period) interpolation.</span>
                <span class="n">apers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row_pers</span><span class="p">)</span>
                <span class="n">per_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">apers</span><span class="p">[</span><span class="n">apers</span> <span class="o">&lt;</span> <span class="n">tper</span><span class="p">])</span>
                <span class="n">per_above</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">apers</span><span class="p">[</span><span class="n">apers</span> <span class="o">&gt;</span> <span class="n">tper</span><span class="p">])</span>
                <span class="n">fd_below</span> <span class="o">=</span> <span class="n">all_fd</span><span class="p">[</span><span class="n">row_pers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">per_below</span><span class="p">)]</span>
                <span class="n">fd_above</span> <span class="o">=</span> <span class="n">all_fd</span><span class="p">[</span><span class="n">row_pers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">per_above</span><span class="p">)]</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">per_below</span><span class="p">)</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">per_above</span><span class="p">)</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">fd_below</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tper</span><span class="p">)</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fd_above</span> <span class="o">-</span> <span class="n">fd_below</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="c1"># Reshape to match the mean</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="c1"># Store the interpolated grid</span>
            <span class="n">imtstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span>
            <span class="k">if</span> <span class="n">oqimt</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">+=</span> <span class="n">fd</span>

        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddevs</span>

    <span class="k">def</span> <span class="nf">_adjustResolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a helper function to adjust the resolution to be under</span>
<span class="sd">        the maximum value specified in the config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We want to only use resolutions that are multiples of 1 minute or</span>
        <span class="c1"># an integer division of 1 minute.</span>
        <span class="n">one_minute</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="n">multiples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
        <span class="n">divisions</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">multiples</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">divisions</span><span class="p">,</span> <span class="n">multiples</span><span class="p">))))</span>
        <span class="n">ok_res</span> <span class="o">=</span> <span class="n">one_minute</span> <span class="o">*</span> <span class="n">factors</span>
        <span class="n">latspan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>

        <span class="c1"># Deal with possible 180 longitude disontinuity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">:</span>
            <span class="n">lonspan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="mi">360</span>
            <span class="n">lonspan</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lonspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">latspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span>
        <span class="k">if</span> <span class="n">ngrid</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Extent and resolution of shakemap results in &quot;</span>
                <span class="s2">&quot;too many grid points. Adjusting resolution...&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Longitude span: </span><span class="si">{</span><span class="n">lonspan</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Latitude span: </span><span class="si">{</span><span class="n">latspan</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current dx: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current dy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current number of grid points: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ngrid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Max grid points allowed: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nmax</span><span class="p">)</span>
            <span class="n">target_res</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="p">(</span><span class="n">latspan</span> <span class="o">+</span> <span class="n">lonspan</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="n">latspan</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">lonspan</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">latspan</span> <span class="o">*</span> <span class="n">lonspan</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nmax</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok_res</span> <span class="o">&gt;</span> <span class="n">target_res</span><span class="p">):</span>
                <span class="n">sel_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ok_res</span><span class="p">[</span><span class="n">ok_res</span> <span class="o">&gt;</span> <span class="n">target_res</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sel_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ok_res</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span> <span class="o">=</span> <span class="n">sel_res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span> <span class="o">=</span> <span class="n">sel_res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated dx: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updatd dy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lonspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">latspan</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smdy</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated number of grid points: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_round_float</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">digits</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;--&quot;</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="s2">&quot;%.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_string_round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">digits</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;--&quot;</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">_round_float</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">digits</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_period_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return 1) a sorted array of the periods represented by the IMT list(s)</span>
<span class="sd">    in the input, and 2) a dictionary of the IMTs and their indices.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args (list): One or more lists of IMTs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        array, dict: Numpy array of the (sorted) periods represented by the</span>
<span class="sd">        IMTs in the input list(s), and a dictionary of the IMTs and their</span>
<span class="sd">        indices into the period array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imt_per</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">imt_per_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">imt_list</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">imt_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imt_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;PGA&quot;</span><span class="p">:</span>
                <span class="n">period</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="k">elif</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;PGV&quot;</span><span class="p">,</span> <span class="s2">&quot;MMI&quot;</span><span class="p">):</span>
                <span class="n">period</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">period</span> <span class="o">=</span> <span class="n">_get_period_from_imt</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
            <span class="n">imt_per</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
            <span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span>
    <span class="n">imt_per</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imt_per</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">imtstr</span><span class="p">,</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">imt_per_ix</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">imt_per</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imt_per</span><span class="p">),</span> <span class="n">imt_per_ix</span>


<span class="k">def</span> <span class="nf">_get_period_from_imt</span><span class="p">(</span><span class="n">imtstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a float representing the period of the SA IMT in the input.</span>

<span class="sd">    Args:</span>
<span class="sd">        imtstr (str): A string representing an SA IMT.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The period of the SA IMT as a float.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">imtstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SA(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_nearest_imts</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">imtset</span><span class="p">,</span> <span class="n">saset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the input IMT, or it&#39;s closest surrogarte (or bracket) found</span>
<span class="sd">    in imtset.</span>

<span class="sd">    Args:</span>
<span class="sd">        imtstr (str): An (OQ-style) IMT string.</span>
<span class="sd">        imtset (list): A list of IMTs to search for imtstr or its closest</span>
<span class="sd">            surrogate (or bracket).</span>
<span class="sd">        saset (list): The SA IMTs found in imtset.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The IMT, it&#39;s closest surrogate, or a bracket of SAs with</span>
<span class="sd">        periods on either side of the IMT&#39;s period, from the IMTs in intset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,)</span>
    <span class="c1">#</span>
    <span class="c1"># If we&#39;re here, then we know that IMT isn&#39;t in the inputs. Try</span>
    <span class="c1"># some alternatives.</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;PGA&quot;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># Use the highest frequency in the inputs</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">saset</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">saset</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_get_period_from_imt</span><span class="p">)[</span><span class="mi">0</span><span class="p">],)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;PGV&quot;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># PGV has no surrogate</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s2">&quot;MMI&quot;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># MMI has no surrogate</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">imtstr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SA(&quot;</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># We know the actual IMT isn&#39;t here, so get the bracket</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">_get_sa_bracket</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">saset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown IMT </span><span class="si">{</span><span class="n">imtstr</span><span class="si">}</span><span class="s2"> in get_imt_bracket&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_sa_bracket</span><span class="p">(</span><span class="n">myimt</span><span class="p">,</span> <span class="n">saset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given SA IMT, look through the input SAs and return a tuple of</span>
<span class="sd">    a) a pair of IMT strings representing the periods bracketing the given</span>
<span class="sd">    period; or b) the single IMT representing the first or last period in</span>
<span class="sd">    the input list if the given period is off the end of the list.</span>

<span class="sd">    Args:</span>
<span class="sd">        myper (float): The period to search for in the input lists.</span>
<span class="sd">        saset (list): A list of SA IMTs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: One or two strings representing the IMTs closest to or</span>
<span class="sd">        bracketing the input IMT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">saset</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="c1">#</span>
    <span class="c1"># Stick the target IMT into a copy of the list of SAs, then sort</span>
    <span class="c1"># the list by period.</span>
    <span class="c1">#</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">saset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myimt</span><span class="p">)</span>
    <span class="n">tmplist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_get_period_from_imt</span><span class="p">)</span>
    <span class="n">nimt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmplist</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Get the index of the target IMT in the sorted list</span>
    <span class="c1">#</span>
    <span class="n">myix</span> <span class="o">=</span> <span class="n">tmplist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">myimt</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># If the target IMT is off the end of the list, return the</span>
    <span class="c1"># appropriate endpoint; else return the pair of IMTs that</span>
    <span class="c1"># bracket the target.</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">myix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tmplist</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
    <span class="k">elif</span> <span class="n">myix</span> <span class="o">==</span> <span class="n">nimt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tmplist</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tmplist</span><span class="p">[</span><span class="n">myix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tmplist</span><span class="p">[</span><span class="n">myix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_get_imt_lists</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a data frame, return a list of lists of valid IMTS for</span>
<span class="sd">    each station in the dataframe; also return a list of the valid</span>
<span class="sd">    SA IMTs for each station.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): A DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list, list: Two lists of lists: each list contains lists</span>
<span class="sd">        corresponding to the stations in the data frame: the first</span>
<span class="sd">        list contains all of the valid IMTs for that station, the</span>
<span class="sd">        second list contains just the valid SA IMTs for the station.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imtlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">salist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlist</span><span class="p">):</span>
        <span class="n">valid_imts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sa_imts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;flagged&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">df</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">this_imt</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">imts</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">this_imt</span> <span class="o">+</span> <span class="s2">&quot;_residual&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">])</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">this_imt</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">valid_imts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_imt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">this_imt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SA(&quot;</span><span class="p">):</span>
                        <span class="n">sa_imts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_imt</span><span class="p">)</span>
        <span class="n">imtlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_imts</span><span class="p">)</span>
        <span class="n">salist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sa_imts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imtlist</span><span class="p">,</span> <span class="n">salist</span>


<span class="k">def</span> <span class="nf">_get_map_grade</span><span class="p">(</span><span class="n">do_grid</span><span class="p">,</span> <span class="n">outsd</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">moutgrid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a &#39;grade&#39; for the map. Essentially looks at the ratio of</span>
<span class="sd">    the computed PGA uncertainty to the predicted PGA uncertainty for</span>
<span class="sd">    the area inside the MMI 6 contour. If the maximum MMI is less than</span>
<span class="sd">    6, or the map is not a grid, the grade and mean ratio are set to &#39;--&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        do_grid (bool): Is the map a grid (True) or a list of points</span>
<span class="sd">            (False)?</span>

<span class="sd">        outsd (dict): A dictionary of computed uncertainty arrays.</span>

<span class="sd">        psd (dict): A dictionary of predicted uncertainty arrays.</span>

<span class="sd">        moutgrid (dict): A dictionary of landmasked output ground</span>
<span class="sd">            motion arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The mean uncertainty ratio and the letter grade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_rat</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
    <span class="n">mygrade</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_grid</span> <span class="ow">or</span> <span class="s2">&quot;PGA&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outsd</span> <span class="ow">or</span> <span class="s2">&quot;PGA&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psd</span> <span class="ow">or</span> <span class="s2">&quot;MMI&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">moutgrid</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span>
    <span class="n">sd_rat</span> <span class="o">=</span> <span class="n">outsd</span><span class="p">[</span><span class="s2">&quot;PGA&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">psd</span><span class="p">[</span><span class="s2">&quot;PGA&quot;</span><span class="p">]</span>
    <span class="n">mmimasked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="s2">&quot;MMI&quot;</span><span class="p">],</span> <span class="mf">6.0</span><span class="p">)</span>
    <span class="n">mpgasd_rat</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">sd_rat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mmimasked</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mpgasd_rat</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">gvals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">]</span>
        <span class="n">grades</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]</span>
        <span class="n">mean_rat</span> <span class="o">=</span> <span class="n">mpgasd_rat</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gvals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mean_rat</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">mygrade</span> <span class="o">=</span> <span class="n">grades</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">mygrade</span> <span class="o">==</span> <span class="s2">&quot;--&quot;</span><span class="p">:</span>
            <span class="n">mygrade</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span>
    <span class="k">return</span> <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span>


<span class="k">def</span> <span class="nf">_get_layer_info</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We need a way to get units information about intensity measure types</span>
<span class="sd">    and translate between OpenQuake naming convention and ShakeMap grid naming</span>
<span class="sd">    convention.</span>

<span class="sd">    Args:</span>
<span class="sd">        layer (str): ShakeMap grid name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple including:</span>

<span class="sd">            - OpenQuake naming convention,</span>
<span class="sd">            - units,</span>
<span class="sd">            - significant digits.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer_out</span> <span class="o">=</span> <span class="n">layer</span>
    <span class="n">layer_units</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">layer_digits</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of significant digits</span>

    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_sd&quot;</span><span class="p">):</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">oq_to_file</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_sd&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">layer_out</span> <span class="o">+</span> <span class="s2">&quot;_sd&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">oq_to_file</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SA&quot;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s2">&quot;ln(g)&quot;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;PGA&quot;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s2">&quot;ln(g)&quot;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;PGV&quot;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s2">&quot;ln(cm/s)&quot;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;MMI&quot;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s2">&quot;intensity&quot;</span>
        <span class="n">layer_digits</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;vs30&quot;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s2">&quot;m/s&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown layer type: </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">layer_out</span><span class="p">,</span> <span class="n">layer_units</span><span class="p">,</span> <span class="n">layer_digits</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/northridge_thumbnail_light_16x9.png" alt="Logo"/>
    
    <h1 class="logo logo-name">ShakeMap Documentation</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual4_0/index.html">ShakeMap 4.1 Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../programs/programs.html">ShakeMap 4.1 Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/shakemap.html">ShakeMap 4.1 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manual3_5/index.html">ShakeMap 3.5 Manual (Deprecated)</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>