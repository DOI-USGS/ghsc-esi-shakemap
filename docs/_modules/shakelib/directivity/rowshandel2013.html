
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>shakelib.directivity.rowshandel2013 &#8212; ShakeMap Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for shakelib.directivity.rowshandel2013</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implements the Rowshandel (2013) directivity model. Note that the report</span>
<span class="sd">provides many options for computing the directivity factor and we have</span>
<span class="sd">also used some coefficients that are unpublished updates by Rowshandel.</span>
<span class="sd">Some of the implementation options are controlled by arguments (e.g.,</span>
<span class="sd">mtype).</span>

<span class="sd">Fd is the directivity function. One of the options is whether or not to</span>
<span class="sd">use the &#39;centering&#39; term (the argument is &#39;centered&#39; and defaults to</span>
<span class="sd">True). If it is True then</span>

<span class="sd">Fd = C1 * (XiPrime - Xic) * LD * DT * WP</span>

<span class="sd">otherwise</span>

<span class="sd">Fd = (C1 * Xiprime + C2) * LD * DT * WP</span>

<span class="sd">where</span>

<span class="sd">- C1 and C2 are regression coefficients.</span>
<span class="sd">- XiPrime is a factor that accounts for rupture propagation and slip</span>
<span class="sd">  direction.</span>
<span class="sd">- Xic is the centering term.</span>
<span class="sd">- LD is the rupture length de-normalization factor.</span>
<span class="sd">- DT is the distance-taper.</span>
<span class="sd">- WP is the narrow-band multiplier.</span>

<span class="sd">Note that Fd is intended to be used in GMPEs as:</span>

<span class="sd">ln(IM_dir) = ln(IM) + Fd</span>

<span class="sd">where</span>

<span class="sd">- Fd is the directivity effect.</span>
<span class="sd">- IM is the intensity measure predicted by the GMPE.</span>
<span class="sd">- IM_dir is the directivity-adjusted IM.</span>

<span class="sd">To do</span>
<span class="sd">    - Add checks on function arguments (e.g., mtype) for valid values.</span>
<span class="sd">    - Interpolate periods.</span>

<span class="sd">References:</span>
<span class="sd">    Rowshandel, B. (2013). Rowshandelâ€™s NGA-West2 directivity model,</span>
<span class="sd">    Chapter 3 of PEER Report No. 2013/09, P. Spudich (Editor), Pacific</span>
<span class="sd">    Earthquake Engineering Research Center, Berkeley, CA.</span>
<span class="sd">    `[link] &lt;http://peer.berkeley.edu/publications/peer_reports/reports_2013/webPEER-2013-09-Spudich.pdf&gt;`__</span>
<span class="sd">&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">openquake.hazardlib.geo</span> <span class="k">as</span> <span class="nn">geo</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib.geo.utils</span> <span class="kn">import</span> <span class="n">OrthographicProjection</span>

<span class="kn">from</span> <span class="nn">shakelib.rupture</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">shakelib.distance</span> <span class="kn">import</span> <span class="n">get_distance</span>
<span class="kn">from</span> <span class="nn">impactutils.vectorutils.ecef</span> <span class="kn">import</span> <span class="n">latlon2ecef</span>
<span class="kn">from</span> <span class="nn">impactutils.vectorutils.ecef</span> <span class="kn">import</span> <span class="n">ecef2latlon</span>
<span class="kn">from</span> <span class="nn">impactutils.vectorutils.vector</span> <span class="kn">import</span> <span class="n">Vector</span>


<div class="viewcode-block" id="Rowshandel2013"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013">[docs]</a><span class="k">class</span> <span class="nc">Rowshandel2013</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">__c1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.28</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">]</span>
    <span class="n">__c2</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.035</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.30</span><span class="p">]</span>
    <span class="n">__periods</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">rup</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">simpleDT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for rowshandel2013.</span>

<span class="sd">        Args:</span>
<span class="sd">            origin: Origin instance.</span>
<span class="sd">            rup: Rupture instance.</span>
<span class="sd">            lat (ndarray): Numpy array of site latitudes.</span>
<span class="sd">            lon (ndarray): Numpy array of site longitudes.</span>
<span class="sd">            dep (ndarray): Numpy array of site depths (km); positive down.</span>
<span class="sd">            dx (float): Target mesh spacing for subruptures in km. The mesh</span>
<span class="sd">                snaps to the edges of the quadrilaterals so the actual mesh</span>
<span class="sd">                spacing will not equal this exactly; spacing in x and y will</span>
<span class="sd">                not be equal.</span>
<span class="sd">            T (list): List floats (or a float) for periods to compute fd;</span>
<span class="sd">                Currently, only acceptable values are 1, 2, 3, 4, 5, 7.5.</span>
<span class="sd">            a_weight (float): Weighting factor for how p-dot-q and s-dot-q are</span>
<span class="sd">                averaged; 0 for only p-dot-q (propagation factor) and 1 for</span>
<span class="sd">                only s-dot-q (slip factor).</span>
<span class="sd">            mtype (int): Either 1 or 2; 1 for adding only positive components</span>
<span class="sd">                of dot products, 2 for adding all components of dot products.</span>
<span class="sd">            simpleDT (bool): Should the simpler DT equation be used? Usually</span>
<span class="sd">                False.</span>
<span class="sd">            centered (bool): Should the centered directivity parameter be used?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rup</span> <span class="o">=</span> <span class="n">rup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">getHypo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dep</span> <span class="o">=</span> <span class="n">dep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rake</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">rake</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dx</span> <span class="o">=</span> <span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">mag</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="n">T</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a_weight</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">a_weight</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;a_weight must be between 0 and 1.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a_weight</span> <span class="o">=</span> <span class="n">a_weight</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mtype</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mtype</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mtype can onlty be 1 or 2.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mtype</span> <span class="o">=</span> <span class="n">mtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simpleDT</span> <span class="o">=</span> <span class="n">simpleDT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_centered</span> <span class="o">=</span> <span class="n">centered</span>

        <span class="c1"># Period independent parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__computeWrup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__computeLD</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__computeXiPrime</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__getCenteringTerm</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__computeFd</span><span class="p">()</span>

<div class="viewcode-block" id="Rowshandel2013.fromSites"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013.fromSites">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromSites</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">rup</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                  <span class="n">mtype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">simpleDT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a rowshandel2013 instance from a sites instance.</span>

<span class="sd">        Class method for constructing a rowshandel2013 instance from</span>
<span class="sd">        a sites instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            origin: Origin instance.</span>
<span class="sd">            rup: Rupture instance.</span>
<span class="sd">            sites: Sites object.</span>
<span class="sd">            dx: Float for target mesh spacing for subruptures in km. The mesh</span>
<span class="sd">                snaps to the edges of the quadrilaterals so the actual mesh</span>
<span class="sd">                spacing will not equal this exactly; spacing in x and y will</span>
<span class="sd">                not be equal.</span>
<span class="sd">            T: Period; Currently, only acceptable values are 1, 2, 3, 4, 5,</span>
<span class="sd">                7.5.</span>
<span class="sd">            a_weight: Weighting factor for how p-dot-q and s-dot-q are</span>
<span class="sd">                averaged; 0 for only p-dot-q (propagation factor) and 1 for</span>
<span class="sd">                only s-dot-q (slip factor).</span>
<span class="sd">            mtype: Integer, either 1 or 2; 1 for adding only positive</span>
<span class="sd">                components of dot products, 2 for adding all components of dot</span>
<span class="sd">                products.</span>
<span class="sd">            simpleDT: Boolean; should the simpler DT equation be used? Usually</span>
<span class="sd">                False.</span>
<span class="sd">            centered: Boolean; should the centered directivity parameter be</span>
<span class="sd">                used</span>

<span class="sd">        Returns:</span>
<span class="sd">            Rowshandel2013 directivity class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sm_dict</span> <span class="o">=</span> <span class="n">sites</span><span class="o">.</span><span class="n">getVs30Grid</span><span class="p">()</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
        <span class="n">west</span> <span class="o">=</span> <span class="n">sm_dict</span><span class="o">.</span><span class="n">xmin</span>
        <span class="n">east</span> <span class="o">=</span> <span class="n">sm_dict</span><span class="o">.</span><span class="n">xmax</span>
        <span class="n">south</span> <span class="o">=</span> <span class="n">sm_dict</span><span class="o">.</span><span class="n">ymin</span>
        <span class="n">north</span> <span class="o">=</span> <span class="n">sm_dict</span><span class="o">.</span><span class="n">ymax</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">sm_dict</span><span class="o">.</span><span class="n">nx</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">sm_dict</span><span class="o">.</span><span class="n">ny</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">rup</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
                   <span class="n">a_weight</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">simpleDT</span><span class="p">,</span> <span class="n">centered</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rowshandel2013.getFd"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013.getFd">[docs]</a>    <span class="k">def</span> <span class="nf">getFd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns:</span>
<span class="sd">            Numpy array of Fd; this is the directivity amplification factor</span>
<span class="sd">            (log units).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rowshandel2013.getXiPrime"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013.getXiPrime">[docs]</a>    <span class="k">def</span> <span class="nf">getXiPrime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            Numpy array of Xi&#39;; this is the variable that accounts for</span>
<span class="sd">            geometric factors in Fd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xi_prime</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rowshandel2013.getDT"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013.getDT">[docs]</a>    <span class="k">def</span> <span class="nf">getDT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">           List of numpy arrays of the distance taper factor. Length is the</span>
<span class="sd">           number of periods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DTlist</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rowshandel2013.getWP"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013.getWP">[docs]</a>    <span class="k">def</span> <span class="nf">getWP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of numpy array of the narrow-band multiplier. Length is the</span>
<span class="sd">            number of periods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_WPlist</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rowshandel2013.getLD"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013.getLD">[docs]</a>    <span class="k">def</span> <span class="nf">getLD</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            Numpy array of the rupture length de-normalization factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_LD</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__computeFd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fd is the term that modifies the GMPE output as an additive term</span>
<span class="sd">        (in log space).</span>
<span class="sd">        ln(Y) = f(M, R, ...) + Fd</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xcipc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xi_prime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xi_c</span>

        <span class="c1"># fd is a list with same length as T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fd</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DTlist</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_WPlist</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">)):</span>
            <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">c1sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__c1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__periods</span> <span class="o">==</span> <span class="n">period</span><span class="p">]</span>
            <span class="n">c2sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__c2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__periods</span> <span class="o">==</span> <span class="n">period</span><span class="p">]</span>

            <span class="c1"># Period dependent parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__computeWP</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__computeDT</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DTlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_WPlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_WP</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_centered</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1sel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WP</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DT</span> <span class="o">*</span> <span class="n">xcipc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1sel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xi_prime</span> <span class="o">+</span> <span class="n">c2sel</span><span class="p">)</span> <span class="o">*</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_LD</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DT</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WP</span>

    <span class="k">def</span> <span class="nf">__computeWrup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the the portion (in km) of the width of the rupture which</span>
<span class="sd">        ruptures up-dip from the hypocenter to the top of the rupture.</span>

<span class="sd">        Wrup is the portion (in km) of the width of the rupture which</span>
<span class="sd">        ruptures up-dip from the hypocenter to the top of the rupture.</span>

<span class="sd">        * This is ambiguous for ruptures with varible top of rupture (not</span>
<span class="sd">          allowed in NGA). For now, lets just compute this for the</span>
<span class="sd">          quad where the hypocenter is located.</span>
<span class="sd">        * Alternative is to compute max Wrup for the different quads.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nquad</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">())</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># First find which quad the hypocenter is on</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">latlon2ecef</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
        <span class="n">hyp_ecef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]])</span>
        <span class="n">qdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nquad</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nquad</span><span class="p">):</span>
            <span class="n">qdist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_quad_distance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span> <span class="n">hyp_ecef</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">qdist</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">qdist</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># *** check that this doesn&#39;t break with more than one quad</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Compute Wrup on that quad</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="n">pp0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span>
            <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
        <span class="n">hyp_ecef</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
        <span class="n">hp0</span> <span class="o">=</span> <span class="n">hyp_ecef</span> <span class="o">-</span> <span class="n">pp0</span>
        <span class="n">ddv</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_down_dip_vector</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Wrup</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ddv</span><span class="p">,</span> <span class="n">hp0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>

    <span class="k">def</span> <span class="nf">__computeXiPrime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the xi&#39; value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hypo_ecef</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>

        <span class="n">slat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span>
        <span class="n">slon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span>

        <span class="c1"># Convert site to ECEF:</span>
        <span class="n">site_ecef_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>
        <span class="n">site_ecef_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>
        <span class="n">site_ecef_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>

        <span class="c1"># Make a 3x(#number of sites) matrix of site locations</span>
        <span class="c1"># (rows are x, y, z) in ECEF</span>
        <span class="n">site_ecef_x</span><span class="p">,</span> <span class="n">site_ecef_y</span><span class="p">,</span> <span class="n">site_ecef_z</span> <span class="o">=</span> <span class="n">latlon2ecef</span><span class="p">(</span>
            <span class="n">slat</span><span class="p">,</span> <span class="n">slon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">slon</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">site_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">site_ecef_x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">site_ecef_y</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">site_ecef_z</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))])</span>

        <span class="n">xi_prime_unscaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>

        <span class="c1"># Normalize by total number of subruptures. For mtype == 1, the number</span>
        <span class="c1"># of subruptures will vary with site and be different for xi_s and</span>
        <span class="c1"># xi_p, so keep two variables and sum them for each quad.</span>
        <span class="n">nsubs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">slat</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">nsubp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">slat</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">xi_prime_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">slat</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">xi_prime_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">slat</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">())):</span>
            <span class="c1"># Select a quad</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Quad mesh (ECEF coords)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_mesh</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dx</span><span class="p">)</span>

            <span class="c1"># Rupture plane normal vector (ECEF coords)</span>
            <span class="n">rpnv</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_normal</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">rpnvcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">rpnv</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">rpnv</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">rpnv</span><span class="o">.</span><span class="n">z</span><span class="p">]])</span>

            <span class="n">cp_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpx&#39;</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpy&#39;</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpz&#39;</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))])</span>

            <span class="c1"># Compute matrix of p vectors</span>
            <span class="n">hypcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">hypo_ecef</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">hypo_ecef</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">hypo_ecef</span><span class="o">.</span><span class="n">z</span><span class="p">]])</span>
            <span class="n">pmat</span> <span class="o">=</span> <span class="n">cp_mat</span> <span class="o">-</span> <span class="n">hypcol</span>

            <span class="c1"># Project pmat onto quad</span>
            <span class="n">ndotp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmat</span> <span class="o">*</span> <span class="n">rpnvcol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pmat</span> <span class="o">=</span> <span class="n">pmat</span> <span class="o">-</span> <span class="n">ndotp</span> <span class="o">*</span> <span class="n">rpnvcol</span>

            <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmat</span> <span class="o">*</span> <span class="n">pmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">pmatnorm</span> <span class="o">=</span> <span class="n">pmat</span> <span class="o">/</span> <span class="n">mag</span>  <span class="c1"># like r1</span>

            <span class="c1"># According to Rowshandel:</span>
            <span class="c1">#   &quot;The choice of the +/- sign in the above equations</span>
            <span class="c1">#    depends on the (along-the-strike and across-the-dip)</span>
            <span class="c1">#    location of the rupturing sub-fault relative to the</span>
            <span class="c1">#    location of the hypocenter.&quot;</span>
            <span class="c1"># and:</span>
            <span class="c1">#   &quot;for the along the strike component of the slip unit</span>
            <span class="c1">#    vector, the choice of the sign should result in the</span>
            <span class="c1">#    slip unit vector (s) being exactly the same as  the</span>
            <span class="c1">#    rupture unit vector (p) for a pure strike-slip case&quot;</span>

            <span class="c1"># Strike slip and dip slip components of unit slip vector</span>
            <span class="c1"># (ECEF coords)</span>
            <span class="n">ds_mat</span><span class="p">,</span> <span class="n">ss_mat</span> <span class="o">=</span> <span class="n">_get_quad_slip_ds_ss</span><span class="p">(</span>
                <span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rake</span><span class="p">,</span> <span class="n">cp_mat</span><span class="p">,</span> <span class="n">pmatnorm</span><span class="p">)</span>

            <span class="n">slpmat</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds_mat</span> <span class="o">+</span> <span class="n">ss_mat</span><span class="p">)</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">slpmat</span> <span class="o">*</span> <span class="n">slpmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">slpmatnorm</span> <span class="o">=</span> <span class="n">slpmat</span> <span class="o">/</span> <span class="n">mag</span>

            <span class="c1"># Loop over sites</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">site_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">sitecol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">site_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]],</span>
                                    <span class="p">[</span><span class="n">site_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]],</span>
                                    <span class="p">[</span><span class="n">site_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]]])</span>

                <span class="n">qmat</span> <span class="o">=</span> <span class="n">sitecol</span> <span class="o">-</span> <span class="n">cp_mat</span>  <span class="c1"># 3x(ni*nj), like r2</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">qmat</span> <span class="o">*</span> <span class="n">qmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">qmatnorm</span> <span class="o">=</span> <span class="n">qmat</span> <span class="o">/</span> <span class="n">mag</span>

                <span class="c1"># Propagation dot product</span>
                <span class="n">pdotqraw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmatnorm</span> <span class="o">*</span> <span class="n">qmatnorm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Slip vector dot product</span>
                <span class="n">sdotqraw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">slpmatnorm</span> <span class="o">*</span> <span class="n">qmatnorm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Only sum over (+) directivity effect subruptures</span>

                    <span class="c1"># xi_p_prime</span>
                    <span class="n">pdotq</span> <span class="o">=</span> <span class="n">pdotqraw</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">nsubp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsubp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pdotq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># xi_s_prime</span>
                    <span class="n">sdotq</span> <span class="o">=</span> <span class="n">sdotqraw</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">nsubs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsubs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sdotq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Sum over contributing subruptures</span>

                    <span class="c1"># xi_p_prime</span>
                    <span class="n">pdotq</span> <span class="o">=</span> <span class="n">pdotqraw</span>
                    <span class="n">nsubp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsubp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cp_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># xi_s_prime</span>
                    <span class="n">sdotq</span> <span class="o">=</span> <span class="n">sdotqraw</span>
                    <span class="n">nsubs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsubs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cp_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Normalize by n sub ruptures later</span>
                <span class="n">xi_prime_s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_prime_s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sdotq</span><span class="p">)</span>
                <span class="n">xi_prime_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_prime_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pdotq</span><span class="p">)</span>

        <span class="c1"># Apply a water level to nsubp and nsubs to avoid division by</span>
        <span class="c1"># zero. This should only occur when the numerator is also zero</span>
        <span class="c1"># and so the resulting value should be zero.</span>
        <span class="n">nsubs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nsubp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">nsubp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># We are outside the &#39;k&#39; loop over nquads.</span>
        <span class="c1"># o Normalize xi_prime_s and xi_prime_p</span>
        <span class="c1"># o Reshape them</span>
        <span class="c1"># o Add them together with the &#39;a&#39; weights</span>
        <span class="n">xi_prime_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_weight</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi_prime_s</span> <span class="o">/</span> <span class="n">nsubs</span><span class="p">)</span> <span class="o">+</span> \
                       <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_weight</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi_prime_p</span> <span class="o">/</span> <span class="n">nsubp</span><span class="p">)</span>
        <span class="n">xi_prime_unscaled</span> <span class="o">=</span> <span class="n">xi_prime_unscaled</span> <span class="o">+</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xi_prime_tmp</span><span class="p">,</span> <span class="n">slat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Scale so that xi_prime has range (0, 1)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">xi_prime</span> <span class="o">=</span> <span class="n">xi_prime_unscaled</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">xi_prime</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi_prime_unscaled</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xi_prime</span> <span class="o">=</span> <span class="n">xi_prime</span>

    <span class="k">def</span> <span class="nf">__computeLD</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes LD -- the rupture length de-normalization term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use an orthographic projection</span>
        <span class="n">latmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">latmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lonmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">lonmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">OrthographicProjection</span><span class="p">(</span><span class="n">lonmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">,</span> <span class="n">latmax</span><span class="p">,</span> <span class="n">latmin</span><span class="p">)</span>

        <span class="c1"># Get epi projection</span>
        <span class="n">epi_x</span><span class="p">,</span> <span class="n">epi_y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hyp</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>

        <span class="c1"># Get the lines for the top edge of the rupture</span>
        <span class="n">qds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()</span>
        <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qds</span><span class="p">)</span>
        <span class="n">top_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
        <span class="n">top_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
        <span class="n">top_dep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nq</span><span class="p">):</span>
            <span class="n">top_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_lat</span><span class="p">,</span> <span class="n">qds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
            <span class="n">top_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_lat</span><span class="p">,</span> <span class="n">qds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
            <span class="n">top_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_lon</span><span class="p">,</span> <span class="n">qds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
            <span class="n">top_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_lon</span><span class="p">,</span> <span class="n">qds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
            <span class="n">top_dep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_dep</span><span class="p">,</span> <span class="n">qds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
            <span class="n">top_dep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_dep</span><span class="p">,</span> <span class="n">qds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
        <span class="n">top_x</span><span class="p">,</span> <span class="n">top_y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">top_lon</span><span class="p">,</span> <span class="n">top_lat</span><span class="p">)</span>

        <span class="n">Lrup_max</span> <span class="o">=</span> <span class="mi">400</span>
        <span class="n">slat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span>
        <span class="n">slon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span>
        <span class="n">LD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>
        <span class="n">Ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>

        <span class="n">ni</span><span class="p">,</span> <span class="n">nj</span> <span class="o">=</span> <span class="n">LD</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ni</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nj</span><span class="p">):</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># Compute Ls</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># Convert to local orthographic</span>
                <span class="n">site_x</span><span class="p">,</span> <span class="n">site_y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">slon</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">slat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

                <span class="c1"># Shift so center is at epicenter</span>
                <span class="n">site_x2</span> <span class="o">=</span> <span class="n">site_x</span> <span class="o">-</span> <span class="n">epi_x</span>
                <span class="n">site_y2</span> <span class="o">=</span> <span class="n">site_y</span> <span class="o">-</span> <span class="n">epi_y</span>
                <span class="n">top_x2</span> <span class="o">=</span> <span class="n">top_x</span> <span class="o">-</span> <span class="n">epi_x</span>
                <span class="n">top_y2</span> <span class="o">=</span> <span class="n">top_y</span> <span class="o">-</span> <span class="n">epi_y</span>

                <span class="c1"># Angle to rotate to put site on x-axis</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">site_y2</span><span class="p">,</span> <span class="n">site_x2</span><span class="p">)</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">rmat</span> <span class="o">=</span> <span class="n">_rotation_matrix</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">llr</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_lat</span><span class="p">)</span>

                <span class="c1"># Apply rotation to each point on trace</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_lat</span><span class="p">)):</span>
                    <span class="n">llr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rmat</span><span class="p">,</span> <span class="p">[</span><span class="n">top_x2</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">top_y2</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">site3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rmat</span><span class="p">,</span> <span class="p">[</span><span class="n">site_x2</span><span class="p">,</span> <span class="n">site_y2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">Li</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">llr</span><span class="p">]),</span> <span class="n">site3</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># Compute LD and save results into matrices</span>
                <span class="c1"># -------------------------------------------------------------</span>

                <span class="n">Lrup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Li</span> <span class="o">*</span> <span class="n">Li</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Wrup</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Wrup</span><span class="p">)</span>
                <span class="n">LD</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Lrup</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Lrup_max</span><span class="p">)</span>
                <span class="n">Ls</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Li</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LD</span> <span class="o">=</span> <span class="n">LD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ls</span> <span class="o">=</span> <span class="n">Ls</span>

    <span class="k">def</span> <span class="nf">__computeDT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes DT -- the distance taper term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span>
        <span class="n">slon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span>
        <span class="n">site_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>
        <span class="n">ddict</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">(</span><span class="s1">&#39;rrup&#39;</span><span class="p">,</span> <span class="n">slat</span><span class="p">,</span> <span class="n">slon</span><span class="p">,</span> <span class="n">site_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="p">)</span>
        <span class="n">Rrup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ddict</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">nsite</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Rrup</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simpleDT</span><span class="p">:</span>   <span class="c1"># eqn 3.10</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="mi">35</span>
            <span class="n">R2</span> <span class="o">=</span> <span class="mi">70</span>
            <span class="n">DT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nsite</span><span class="p">)</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">Rrup</span> <span class="o">&gt;</span> <span class="n">R1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Rrup</span> <span class="o">&lt;</span> <span class="n">R2</span><span class="p">)])</span>
            <span class="n">DT</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">Rrup</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">/</span> <span class="n">R1</span>
            <span class="n">DT</span><span class="p">[</span><span class="n">Rrup</span> <span class="o">&gt;=</span> <span class="n">R2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>                  <span class="c1"># eqn 3.9</span>
            <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">R1</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
                <span class="n">R2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">period</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">R1</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="n">R2</span> <span class="o">=</span> <span class="mi">40</span>
            <span class="n">DT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nsite</span><span class="p">)</span>
            <span class="c1"># As written in report:</span>
            <span class="c1"># DT[(Rrup &gt; R1) &amp; (Rrup &lt; R2)] = \</span>
            <span class="c1">#    2 - Rrup[(Rrup &gt; R1) &amp; (Rrup &lt; R2)]/(20 + 10 * np.log(period))</span>
            <span class="c1"># Modification:</span>
            <span class="n">DT</span><span class="p">[(</span><span class="n">Rrup</span> <span class="o">&gt;</span> <span class="n">R1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Rrup</span> <span class="o">&lt;</span> <span class="n">R2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> \
                <span class="n">Rrup</span><span class="p">[(</span><span class="n">Rrup</span> <span class="o">&gt;</span> <span class="n">R1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Rrup</span> <span class="o">&lt;</span> <span class="n">R2</span><span class="p">)]</span> <span class="o">/</span> <span class="n">R1</span>
            <span class="c1"># Note: it is not clear if the above modification is &#39;correct&#39;</span>
            <span class="c1">#       but it gives results that make more sense</span>
            <span class="n">DT</span><span class="p">[</span><span class="n">Rrup</span> <span class="o">&gt;=</span> <span class="n">R2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">DT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">DT</span><span class="p">,</span> <span class="n">slat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DT</span> <span class="o">=</span> <span class="n">DT</span>

    <span class="k">def</span> <span class="nf">__getCenteringTerm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rup</span><span class="o">.</span><span class="n">getLength</span><span class="p">()</span>
        <span class="n">CSSLP</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.32</span> <span class="o">+</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">CTRST</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.20</span> <span class="o">+</span> <span class="mf">0.09</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">CNRML</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.20</span> <span class="o">+</span> <span class="mf">0.08</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rake</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">act</span> <span class="o">=</span> <span class="p">(</span><span class="n">CSSLP</span> <span class="o">-</span> <span class="n">CTRST</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">cct</span> <span class="o">=</span> <span class="p">(</span><span class="n">CSSLP</span> <span class="o">+</span> <span class="n">CTRST</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xi_c</span> <span class="o">=</span> <span class="n">act</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rake</span><span class="p">))</span> <span class="o">+</span> <span class="n">cct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">act</span> <span class="o">=</span> <span class="p">(</span><span class="n">CSSLP</span> <span class="o">-</span> <span class="n">CNRML</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">cct</span> <span class="o">=</span> <span class="p">(</span><span class="n">CSSLP</span> <span class="o">+</span> <span class="n">CNRML</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xi_c</span> <span class="o">=</span> <span class="n">act</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rake</span><span class="p">))</span> <span class="o">+</span> <span class="n">cct</span>

    <span class="k">def</span> <span class="nf">__computeWP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes WP -- the narrow-band multiplier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># As written in report:</span>
        <span class="c1"># sig = 0.6</span>
        <span class="c1"># Tp = np.exp(1.27*self._M - 7.28)</span>
        <span class="c1"># Update (Rowshandel, personal communication)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="mf">0.55</span>
        <span class="n">Tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.04</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">-</span> <span class="mf">6.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_WP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="n">Tp</span><span class="p">)</span> <span class="o">*</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="n">Tp</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">sig</span><span class="p">))</span>

<div class="viewcode-block" id="Rowshandel2013.getPeriods"><a class="viewcode-back" href="../../../shakelib/shakelib.directivity.rowshandel2013.html#shakelib.directivity.rowshandel2013.Rowshandel2013.getPeriods">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getPeriods</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of the periods for which the model is defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__periods</span></div></div>


<span class="k">def</span> <span class="nf">_get_quad_slip_ds_ss</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rake</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the DIP SLIP and STRIKE SLIP components of the unit slip vector in</span>
<span class="sd">    ECEF coords for a quad and rake angle.</span>
<span class="sd">    :param q:</span>
<span class="sd">        A quadrilateral.</span>
<span class="sd">    :param rake:</span>
<span class="sd">        Direction of motion of the hanging wall relative to the</span>
<span class="sd">        foot wall, as measured by the angle (deg) from the strike vector.</span>
<span class="sd">    :param cp:</span>
<span class="sd">        A 3x(n sub rupture) array giving center points of each sub rupture</span>
<span class="sd">        in ECEF coords.</span>
<span class="sd">    :param p:</span>
<span class="sd">        A 3x(n sub rupture) array giving the unit vectors of the propagation</span>
<span class="sd">        vector on each sub rupture in ECEF coords.</span>
<span class="sd">    :returns:</span>
<span class="sd">        List of dip slip and strike slip components (each is a matrix)</span>
<span class="sd">        of the unit slip vector in ECEF space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get quad vertices, strike, dip</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">strike</span> <span class="o">=</span> <span class="n">P0</span><span class="o">.</span><span class="n">azimuth</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">dip</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_dip</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="c1"># Slip unit vectors in &#39;local&#39; (i.e., z-up, x-east) coordinates</span>
    <span class="n">d1_local</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_local_unit_slip_vector_DS</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="p">)</span>
    <span class="n">s1_local</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_local_unit_slip_vector_SS</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="p">)</span>

    <span class="c1"># Convert to a column array</span>
    <span class="n">d1_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">d1_local</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">d1_local</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">d1_local</span><span class="o">.</span><span class="n">z</span><span class="p">]])</span>
    <span class="n">s1_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s1_local</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">s1_local</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">s1_local</span><span class="o">.</span><span class="n">z</span><span class="p">]])</span>

    <span class="c1"># Define &#39;local&#39; coordinate system</span>
    <span class="n">qlats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">latitude</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">q</span><span class="p">]</span>
    <span class="n">qlons</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">longitude</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">q</span><span class="p">]</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">OrthographicProjection</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">qlons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">qlons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">qlats</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">qlats</span><span class="p">))</span>

    <span class="c1"># Convert p and cp to geographic coords</span>
    <span class="n">p0lat</span><span class="p">,</span> <span class="n">p0lon</span><span class="p">,</span> <span class="n">p0z</span> <span class="o">=</span> <span class="n">ecef2latlon</span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">])</span>
    <span class="n">p1lat</span><span class="p">,</span> <span class="n">p1lon</span><span class="p">,</span> <span class="n">p1z</span> <span class="o">=</span> <span class="n">ecef2latlon</span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
                                    <span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
                                    <span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">])</span>

    <span class="c1"># Convert p to &#39;local&#39; coords</span>
    <span class="n">p0x</span><span class="p">,</span> <span class="n">p0y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">p0lon</span><span class="p">,</span> <span class="n">p0lat</span><span class="p">)</span>
    <span class="n">p1x</span><span class="p">,</span> <span class="n">p1y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">p1lon</span><span class="p">,</span> <span class="n">p1lat</span><span class="p">)</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">p1x</span> <span class="o">-</span> <span class="n">p0x</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">p1y</span> <span class="o">-</span> <span class="n">p0y</span>
    <span class="n">pz</span> <span class="o">=</span> <span class="n">p1z</span> <span class="o">-</span> <span class="n">p0z</span>

    <span class="c1"># Apply sign changes in &#39;local&#39; coords</span>
    <span class="n">s1mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s1_col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">px</span><span class="p">)],</span>
                      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s1_col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">py</span><span class="p">)],</span>
                      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s1_col</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pz</span><span class="p">)]])</span>
<span class="c1">#                      [np.abs(s1_col[2])*np.ones_like(pz)]])</span>

    <span class="n">dipsign</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">rake</span><span class="p">)))</span>
    <span class="n">d1mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">d1_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">px</span><span class="p">)</span> <span class="o">*</span> <span class="n">dipsign</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">d1_col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">py</span><span class="p">)</span> <span class="o">*</span> <span class="n">dipsign</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">d1_col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">pz</span><span class="p">)</span> <span class="o">*</span> <span class="n">dipsign</span><span class="p">]])</span>

    <span class="c1"># Need to track &#39;origin&#39;</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="c1"># Convert from &#39;local&#39; to geographic coords</span>
    <span class="n">s1_ll</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">s1mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="n">s1mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">d1_ll</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">d1mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="n">d1mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s0_ll</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">s0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># And then back to ECEF:</span>
    <span class="n">s1_ecef</span> <span class="o">=</span> <span class="n">latlon2ecef</span><span class="p">(</span><span class="n">s1_ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s1_ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s1mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">])</span>
    <span class="n">d1_ecef</span> <span class="o">=</span> <span class="n">latlon2ecef</span><span class="p">(</span><span class="n">d1_ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d1_ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d1mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">])</span>
    <span class="n">s0_ecef</span> <span class="o">=</span> <span class="n">latlon2ecef</span><span class="p">(</span><span class="n">s0_ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s0_ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">s00</span> <span class="o">=</span> <span class="n">s0_ecef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s01</span> <span class="o">=</span> <span class="n">s0_ecef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s02</span> <span class="o">=</span> <span class="n">s0_ecef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">d_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d1_ecef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">s00</span><span class="p">,</span>
                      <span class="n">d1_ecef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">s01</span><span class="p">,</span>
                      <span class="n">d1_ecef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">s02</span><span class="p">])</span>
    <span class="n">s_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s1_ecef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">s00</span><span class="p">,</span>
                      <span class="n">s1_ecef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">s01</span><span class="p">,</span>
                      <span class="n">s1_ecef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">s02</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">d_mat</span><span class="p">,</span> <span class="n">s_mat</span>


<span class="k">def</span> <span class="nf">_rotation_matrix</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the rotation matrix associated with counterclockwise rotation about</span>
<span class="sd">    the given axis by theta radians.</span>
<span class="sd">    Source: Response by &#39;unutbu&#39; in this thread:</span>
<span class="sd">    http://stackoverflow.com/questions/6802577/python-rotation-of-3d-vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">axis</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">d</span>
    <span class="n">bc</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">ac</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">cd</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">aa</span> <span class="o">+</span> <span class="n">bb</span> <span class="o">-</span> <span class="n">cc</span> <span class="o">-</span> <span class="n">dd</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bc</span> <span class="o">+</span> <span class="n">ad</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bd</span> <span class="o">-</span> <span class="n">ac</span><span class="p">)],</span>
                     <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bc</span> <span class="o">-</span> <span class="n">ad</span><span class="p">),</span> <span class="n">aa</span> <span class="o">+</span> <span class="n">cc</span> <span class="o">-</span> <span class="n">bb</span> <span class="o">-</span> <span class="n">dd</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">cd</span> <span class="o">+</span> <span class="n">ab</span><span class="p">)],</span>
                     <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bd</span> <span class="o">+</span> <span class="n">ac</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">cd</span> <span class="o">-</span> <span class="n">ab</span><span class="p">),</span> <span class="n">aa</span> <span class="o">+</span> <span class="n">dd</span> <span class="o">-</span> <span class="n">bb</span> <span class="o">-</span> <span class="n">cc</span><span class="p">]])</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/northridge_thumbnail_light_16x9.png" alt="Logo"/>
    
    <h1 class="logo logo-name">ShakeMap Documentation</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual4_0/index.html">ShakeMap 4.0 Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../programs/programs.html">ShakeMap 4.0 Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/shakemap.html">ShakeMap 4.0 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manual3_5/index.html">ShakeMap 3.5 Manual (Deprecated)</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>