
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>shakelib.rupture.quad_rupture &#8212; ShakeMap Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for shakelib.rupture.quad_rupture</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># stdlib modules</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib.geo.mesh</span> <span class="kn">import</span> <span class="n">Mesh</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib.geo.geodetic</span> <span class="kn">import</span> <span class="n">point_at</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib.geo.point</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib.geo.utils</span> <span class="kn">import</span> <span class="n">OrthographicProjection</span>

<span class="kn">from</span> <span class="nn">impactutils.vectorutils.ecef</span> <span class="kn">import</span> <span class="n">latlon2ecef</span>
<span class="kn">from</span> <span class="nn">impactutils.vectorutils.ecef</span> <span class="kn">import</span> <span class="n">ecef2latlon</span>
<span class="kn">from</span> <span class="nn">impactutils.vectorutils.vector</span> <span class="kn">import</span> <span class="n">Vector</span>
<span class="kn">from</span> <span class="nn">impactutils.time.ancient_time</span> <span class="kn">import</span> <span class="n">HistoricTime</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.exception</span> <span class="kn">import</span> <span class="n">ShakeLibException</span>
<span class="kn">from</span> <span class="nn">shakelib.rupture.base</span> <span class="kn">import</span> <span class="n">Rupture</span>
<span class="kn">from</span> <span class="nn">shakelib.rupture</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">shakelib.rupture</span> <span class="kn">import</span> <span class="n">gc2</span>
<span class="kn">import</span> <span class="nn">shakelib.rupture.constants</span> <span class="k">as</span> <span class="nn">constants</span>


<div class="viewcode-block" id="QuadRupture"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture">[docs]</a><span class="k">class</span> <span class="nc">QuadRupture</span><span class="p">(</span><span class="n">Rupture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rupture class that represents the rupture surface as a combination of</span>
<span class="sd">    quadrilaterals. Each quadrilateral must have horizontal top and bottom</span>
<span class="sd">    edges and must be coplanar. These restrictions make the computation of</span>
<span class="sd">    rupture distances more efficient. The number of points in the top edges</span>
<span class="sd">    must match the number of points in the bottom edge.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a QuadRupture instance from a GeoJSON dictionary and an Origin.</span>

<span class="sd">        Args:</span>
<span class="sd">           d (dict): Rupture GeoJSON dictionary.</span>
<span class="sd">           origin (Origin): Reference to a ShakeMap Origin object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QuadRupture instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">polys</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_polygons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_polygons</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p_lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p_lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p_depths</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span> <span class="o">+</span> <span class="n">p_lons</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span> <span class="o">+</span> <span class="n">p_lats</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="n">dep</span> <span class="o">+</span> <span class="n">p_depths</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>

        <span class="c1"># Add origin information to metadata</span>
        <span class="n">odict</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">odict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TIMEFMT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_geojson</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">=</span> <span class="n">dep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setQuadrilaterals</span><span class="p">()</span>

<div class="viewcode-block" id="QuadRupture.getDepthAtPoint"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getDepthAtPoint">[docs]</a>    <span class="k">def</span> <span class="nf">getDepthAtPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
        <span class="n">SMALL_DISTANCE</span> <span class="o">=</span> <span class="mf">2e-03</span>  <span class="c1"># 2 meters</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">tmp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeRjb</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lon</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lat</span><span class="p">]),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">SMALL_DISTANCE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">depth</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">dmin</span> <span class="o">=</span> <span class="mi">9999999999999999</span>
        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">():</span>
            <span class="n">pX</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pX</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pX</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pX</span><span class="o">.</span><span class="n">z</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">rjb</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_quad_distance</span><span class="p">(</span><span class="n">quad</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rjb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dmin</span><span class="p">:</span>
                <span class="n">dmin</span> <span class="o">=</span> <span class="n">rjb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">imin</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>
        <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">quad</span>
        <span class="c1"># project the quad and the point in question to orthographic defined by</span>
        <span class="c1"># quad</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">P0</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">P0</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">P0</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">P0</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">OrthographicProjection</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">)</span>

        <span class="c1"># project each vertex of quad (at 0 depth)</span>
        <span class="n">s0x</span><span class="p">,</span> <span class="n">s0y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">P0</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P0</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s1x</span><span class="p">,</span> <span class="n">s1y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">P1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s2x</span><span class="p">,</span> <span class="n">s2y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">P2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s3x</span><span class="p">,</span> <span class="n">s3y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">P3</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">sxx</span><span class="p">,</span> <span class="n">sxy</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

        <span class="c1"># turn these to vectors</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">s0x</span><span class="p">,</span> <span class="n">s0y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">s1x</span><span class="p">,</span> <span class="n">s1y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">s3x</span><span class="p">,</span> <span class="n">s3y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">sxx</span><span class="p">,</span> <span class="n">sxy</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Compute vector from s0 to s1</span>
        <span class="n">s0s1</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">s0</span>
        <span class="c1"># Compute the vector from s0 to s3</span>
        <span class="n">s0s3</span> <span class="o">=</span> <span class="n">s3</span> <span class="o">-</span> <span class="n">s0</span>
        <span class="c1"># Compute the vector from s0 to sx</span>
        <span class="n">s0sx</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">-</span> <span class="n">s0</span>

        <span class="c1"># cross products</span>
        <span class="n">s0normal</span> <span class="o">=</span> <span class="n">s0s3</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">s0s1</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">s0s1</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">s0normal</span><span class="p">)</span>
        <span class="c1"># normalize dd (down dip direction)</span>
        <span class="n">ddn</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="c1"># dot product</span>
        <span class="n">sxdd</span> <span class="o">=</span> <span class="n">ddn</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s0sx</span><span class="p">)</span>

        <span class="c1"># get width of quad (convert from km to m)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_width</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>

        <span class="c1"># Get weights for top and bottom edge depths</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_normal</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_vertical_vector</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
        <span class="n">dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Vector</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">V</span><span class="p">)))</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dip</span><span class="p">)))</span>
        <span class="n">wtt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ws</span> <span class="o">-</span> <span class="n">sxdd</span><span class="p">)</span> <span class="o">/</span> <span class="n">ws</span>
        <span class="n">wtb</span> <span class="o">=</span> <span class="n">sxdd</span> <span class="o">/</span> <span class="n">ws</span>

        <span class="c1"># Compute the depth of of the plane at Px:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">wtt</span> <span class="o">*</span> <span class="n">P0</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">wtb</span> <span class="o">*</span> <span class="n">P3</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="k">return</span> <span class="n">depth</span></div>

<div class="viewcode-block" id="QuadRupture.getLength"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getLength">[docs]</a>    <span class="k">def</span> <span class="nf">getLength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute length of rupture based on top edge in km.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Length of rupture (km).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flength</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">:</span>
            <span class="n">flength</span> <span class="o">=</span> <span class="n">flength</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_length</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flength</span></div>

<div class="viewcode-block" id="QuadRupture.getWidth"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getWidth">[docs]</a>    <span class="k">def</span> <span class="nf">getWidth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute average rupture width (km) for all quadrilaterals defined for</span>
<span class="sd">        the rupture.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Average width in km of all rupture quadrilaterals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">:</span>
            <span class="n">wsum</span> <span class="o">=</span> <span class="n">wsum</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_width</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
        <span class="n">mwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">wsum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mwidth</span></div>

<div class="viewcode-block" id="QuadRupture.getArea"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getArea">[docs]</a>    <span class="k">def</span> <span class="nf">getArea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute area of rupture.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Rupture area in square km.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_width</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_length</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
            <span class="n">asum</span> <span class="o">=</span> <span class="n">asum</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">length</span>
        <span class="k">return</span> <span class="n">asum</span></div>

<div class="viewcode-block" id="QuadRupture.fromTrace"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.fromTrace">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromTrace</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xp0</span><span class="p">,</span> <span class="n">yp0</span><span class="p">,</span> <span class="n">xp1</span><span class="p">,</span> <span class="n">yp1</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span>
                  <span class="n">strike</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a QuadRupture instance from a set of vertices that define the</span>
<span class="sd">        top of the rupture, and an array of widths/dips.</span>

<span class="sd">        Each rupture quadrilaterial is defined by specifying the latitude,</span>
<span class="sd">        longitude, and depth of the two vertices on the top edges, which must</span>
<span class="sd">        have the dame depths. The other verticies are then constructed from</span>
<span class="sd">        the top edges and the width and dip of the quadrilateral.</span>

<span class="sd">        Args:</span>
<span class="sd">            xp0 (array): Array or list of longitudes (floats) of p0.</span>
<span class="sd">            yp0 (array): Array or list of latitudes (floats) of p0.</span>
<span class="sd">            xp1 (array): Array or list of longitudes (floats) of p1.</span>
<span class="sd">            yp1 (array): Array or list of latitudes (floats) of p1.</span>
<span class="sd">            zp (array): Array or list of depths for each of the top of rupture</span>
<span class="sd">                rectangles (km).</span>
<span class="sd">            widths (array): Array of widths for each of rectangle (km).</span>
<span class="sd">            dips (array): Array of dips for each of rectangle (degrees).</span>
<span class="sd">            origin (Origin): Reference to a ShakeMap origin object.</span>
<span class="sd">            strike (array): If None then strike is computed from verticies of</span>
<span class="sd">                top edge of each quadrilateral. If the array has only a</span>
<span class="sd">                single value, then all</span>
<span class="sd">                quadrilaterals are constructed assuming this strike direction.</span>
<span class="sd">                If an array with the same length as the trace coordinates then</span>
<span class="sd">                it specifies the strike for each quadrilateral.</span>
<span class="sd">            group_index (list): List of integers to indicate group index. If</span>
<span class="sd">                None then each quadrilateral is assumed to be in a different</span>
<span class="sd">                group since there is no guarantee that any of them are</span>
<span class="sd">                continuous.</span>
<span class="sd">            reference (str): String explaining where the rupture definition</span>
<span class="sd">                came from (publication style reference, etc.).</span>

<span class="sd">        Returns:</span>
<span class="sd">            QuadRupture instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ShakeLibException: if the input arrays are not all the same</span>
<span class="sd">                length, or if the strike array is not length 1 or the same</span>
<span class="sd">                length as the input arrays.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp1</span><span class="p">)</span> <span class="o">==</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dips</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ShakeLibException</span><span class="p">(</span>
                <span class="s1">&#39;Number of xp0,yp0,xp1,yp1,zp,widths,dips points must be &#39;</span>
                <span class="s1">&#39;equal.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strike</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ShakeLibException</span><span class="p">(</span>
                <span class="s1">&#39;Strike must be None or an array of one value or the &#39;</span>
                <span class="s1">&#39;same length as trace coordinates.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xp0</span><span class="p">)))</span>

        <span class="c1"># Convert dips to radians</span>
        <span class="n">dips</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dips</span><span class="p">)</span>

        <span class="c1"># Ensure that all input sequences are numpy arrays</span>
        <span class="n">xp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">xp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">yp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yp0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">yp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yp1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">widths</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dips</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dips</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="c1"># Get a projection object</span>
        <span class="n">west</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">xp0</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xp1</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="n">east</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">xp0</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">xp1</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">south</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">yp0</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yp1</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="n">north</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">yp0</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">yp1</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

        <span class="c1"># Projected coordinates are in km</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">OrthographicProjection</span><span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="p">)</span>
        <span class="n">xp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span>
        <span class="n">xp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span>
        <span class="n">yp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span>
        <span class="n">yp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span>
        <span class="n">zpdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp0</span><span class="p">)):</span>
            <span class="c1"># Project the top edge coordinates</span>
            <span class="n">p0x</span><span class="p">,</span> <span class="n">p0y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">xp0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yp0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">p1x</span><span class="p">,</span> <span class="n">p1y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">xp1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yp1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Get the rotation angle defined by these two points</span>
            <span class="k">if</span> <span class="n">strike</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">p1x</span> <span class="o">-</span> <span class="n">p0x</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">p1y</span> <span class="o">-</span> <span class="n">p0y</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>  <span class="c1"># theta is angle from north</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">strike</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">strike</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
                          <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>

            <span class="c1"># Rotate the top edge points into a new coordinate system (vertical</span>
            <span class="c1"># line)</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p0x</span><span class="p">,</span> <span class="n">p0y</span><span class="p">])</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p1x</span><span class="p">,</span> <span class="n">p1y</span><span class="p">])</span>
            <span class="n">p0p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">p0</span><span class="p">)</span>
            <span class="n">p1p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>

            <span class="c1"># Get right side coordinates in project, rotated system</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dips</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dips</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p3xp</span> <span class="o">=</span> <span class="n">p0p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span>
            <span class="n">p3yp</span> <span class="o">=</span> <span class="n">p0p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p2xp</span> <span class="o">=</span> <span class="n">p1p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span>
            <span class="n">p2yp</span> <span class="o">=</span> <span class="n">p1p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Get right side coordinates in un-rotated projected system</span>
            <span class="n">p3p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p3xp</span><span class="p">,</span> <span class="n">p3yp</span><span class="p">])</span>
            <span class="n">p2p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p2xp</span><span class="p">,</span> <span class="n">p2yp</span><span class="p">])</span>
            <span class="n">Rback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">)],</span>
                              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">)]])</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rback</span><span class="p">,</span> <span class="n">p3p</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rback</span><span class="p">,</span> <span class="n">p2p</span><span class="p">)</span>
            <span class="n">p3x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p3</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">p3y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p3</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">p2x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">p2y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="c1"># project lower edge points back to lat/lon coordinates</span>
            <span class="n">lon3</span><span class="p">,</span> <span class="n">lat3</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">p3x</span><span class="p">,</span> <span class="n">p3y</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">p2x</span><span class="p">,</span> <span class="n">p2y</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">xp2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon2</span>
            <span class="n">xp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon3</span>
            <span class="n">yp2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat2</span>
            <span class="n">yp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat3</span>
            <span class="n">zpdown</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dz</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Create GeoJSON object</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">group_index</span><span class="p">)</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">u_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">group_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">xp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">xp1</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">xp2</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">xp3</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">xp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
                 <span class="p">])</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">yp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">yp1</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                 <span class="n">yp2</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">yp3</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">yp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
                 <span class="p">])</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">zp</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">zp</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                 <span class="n">zpdown</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">zpdown</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">zp</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))])</span>

            <span class="n">poly</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
                <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">dep</span><span class="p">])</span>
            <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
             <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="n">reference</span>
             <span class="p">},</span>
             <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[{</span>
                 <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s2">&quot;rupture type&quot;</span><span class="p">:</span> <span class="s2">&quot;rupture extent&quot;</span>
                 <span class="p">},</span>
                 <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">coords</span><span class="p">]</span>
                 <span class="p">}</span>
             <span class="p">}]}</span>

        <span class="c1"># Add origin information to metadata</span>
        <span class="n">odict</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">odict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">HistoricTime</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TIMEFMT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuadRupture.writeTextFile"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.writeTextFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeTextFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rupturefile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write rupture data to rupture file format as defined in ShakeMap</span>
<span class="sd">        Software Guide.</span>

<span class="sd">        Note that this currently treats each quadrilateral as a separate</span>
<span class="sd">        polygon. This needs to be udpated.</span>

<span class="sd">        Args:</span>
<span class="sd">            rupturefile (str): Filename of output data file OR file-like</span>
<span class="sd">                object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rupturefile</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rupturefile</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">rupturefile</span>  <span class="c1"># just a reference to the input file-like object</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">():</span>
            <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">quad</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P0</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">P0</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">P0</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P1</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P2</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P3</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P0</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">P0</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">P0</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rupturefile</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="QuadRupture.fromOrientation"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.fromOrientation">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromOrientation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
                        <span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a QuadRupture instance from a known point, shape, and</span>
<span class="sd">        orientation.</span>

<span class="sd">        A point is defined as a set of latitude, longitude, and depth, which</span>
<span class="sd">        is located in the corner between the tail of the vector pointing in</span>
<span class="sd">        the strike direction and the dip direction (nearest to the surface).</span>
<span class="sd">        The shape is defined by length, width, dx, and dy. The length is the</span>
<span class="sd">        measurement of the quadrilateral in the direction of strike, and</span>
<span class="sd">        width is the measurement of quadrilateral in the direction of dip.</span>
<span class="sd">        Dx is the measurement on the plane in the strike direction between</span>
<span class="sd">        the known point and the corner between the tail of the vector pointing</span>
<span class="sd">        in the strike direction and the dip direction (nearest to the surface).</span>
<span class="sd">        Dy is the measurement on the plane in the dip direction between</span>
<span class="sd">        the known point and the corner between the tail of the vector pointing</span>
<span class="sd">        in the strike direction and the dip direction (nearest to the surface).</span>
<span class="sd">        The orientation is defined by azimuth and angle from</span>
<span class="sd">        horizontal, strike and dip respectively. For example in plane view:</span>
<span class="sd">            ::</span>
<span class="sd">                            strike direction</span>
<span class="sd">                        p1*-------------------&gt;&gt;p2</span>
<span class="sd">                        *        | dy           |</span>
<span class="sd">                 dip    |--------o              |</span>
<span class="sd">              direction |   dx    known point   | Width</span>
<span class="sd">                        V                       |</span>
<span class="sd">                        V                       |</span>
<span class="sd">                        p4----------------------p3</span>
<span class="sd">                                Length</span>

<span class="sd">        Args:</span>
<span class="sd">            px (array): Array or list of longitudes (floats) of the known</span>
<span class="sd">                point.</span>
<span class="sd">            py (array): Array or list of latitudes (floats) of the known point.</span>
<span class="sd">            pz (array): Array or list of depths (floats) of the known point.</span>
<span class="sd">            dx (array): Array or list of distances (floats), in the strike</span>
<span class="sd">                direction, between the known point and P1. dx must be less than</span>
<span class="sd">                length.</span>
<span class="sd">            dy (array): Array or list of distances (floats), in the dip</span>
<span class="sd">                direction, between the known point and P1. dy must be less than</span>
<span class="sd">                width.</span>
<span class="sd">            length (array): Array or list of widths (floats) of the plane in</span>
<span class="sd">                the strike direction.</span>
<span class="sd">            width (array): Array or list of widths (floats) of the plane in the</span>
<span class="sd">                dip direction.</span>
<span class="sd">            strike (array): Array or list of strike angles (floats).</span>
<span class="sd">            dip (array): Array or list of dip angles (floats).</span>
<span class="sd">            origin (Origin): Reference to a ShakeMap Origin object.</span>
<span class="sd">        Returns:</span>
<span class="sd">            QuadRupture instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ShakeLibException: if the lengths of the points arrays are not</span>
<span class="sd">                all equal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Verify that arrays are of equal length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">px</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">py</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">dx</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">strike</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dip</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ShakeLibException</span><span class="p">(</span>
                <span class="s1">&#39;Number of px, py, pz, dx, dy, length, width, &#39;</span>
                <span class="s1">&#39;strike, dip points must be &#39;</span>
                <span class="s1">&#39;equal.&#39;</span><span class="p">)</span>

        <span class="c1"># Verify that all are numpy arrays</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">pz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pz</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">strike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="c1"># Get P1 and P2 (top horizontal points)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">dip</span><span class="p">)),</span> <span class="n">dx</span><span class="p">))</span>
        <span class="n">P1_direction</span> <span class="o">=</span> <span class="n">strike</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">theta</span>
        <span class="n">P1_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">dip</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">P2_direction</span> <span class="o">=</span> <span class="n">strike</span>
        <span class="n">P2_distance</span> <span class="o">=</span> <span class="n">length</span>
        <span class="n">P1_lon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P1_lat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P2_lon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P2_lat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">px</span><span class="p">):</span>
            <span class="n">P1_points</span> <span class="o">=</span> <span class="n">point_at</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">P1_direction</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">P1_distance</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">P1_lon</span> <span class="o">+=</span> <span class="p">[</span><span class="n">P1_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">P1_lat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">P1_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">P2_points</span> <span class="o">=</span> <span class="n">point_at</span><span class="p">(</span><span class="n">P1_points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P1_points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">P2_direction</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">P2_distance</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">P2_lon</span> <span class="o">+=</span> <span class="p">[</span><span class="n">P2_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">P2_lat</span> <span class="o">+=</span> <span class="p">[</span><span class="n">P2_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># Get top depth</span>
        <span class="n">top_horizontal_depth</span> <span class="o">=</span> <span class="n">pz</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">dip</span><span class="p">)))</span>

        <span class="c1"># Get QuadRupture object</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">QuadRupture</span><span class="o">.</span><span class="n">fromTrace</span><span class="p">(</span><span class="n">P1_lon</span><span class="p">,</span> <span class="n">P1_lat</span><span class="p">,</span> <span class="n">P2_lon</span><span class="p">,</span> <span class="n">P2_lat</span><span class="p">,</span>
                                     <span class="n">top_horizontal_depth</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span>
                                     <span class="n">origin</span><span class="p">,</span> <span class="n">strike</span><span class="o">=</span><span class="n">strike</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">quad</span></div>

<div class="viewcode-block" id="QuadRupture.fromVertices"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.fromVertices">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromVertices</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                     <span class="n">xp0</span><span class="p">,</span> <span class="n">yp0</span><span class="p">,</span> <span class="n">zp0</span><span class="p">,</span> <span class="n">xp1</span><span class="p">,</span> <span class="n">yp1</span><span class="p">,</span> <span class="n">zp1</span><span class="p">,</span>
                     <span class="n">xp2</span><span class="p">,</span> <span class="n">yp2</span><span class="p">,</span> <span class="n">zp2</span><span class="p">,</span> <span class="n">xp3</span><span class="p">,</span> <span class="n">yp3</span><span class="p">,</span> <span class="n">zp3</span><span class="p">,</span>
                     <span class="n">origin</span><span class="p">,</span>
                     <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a QuadDrupture instance from the vector of vertices that fully</span>
<span class="sd">        define the quadrilaterals. The points p0, ..., p3 are labeled below for</span>
<span class="sd">        a trapezoid:</span>

<span class="sd">        ::</span>

<span class="sd">              p0--------p1</span>
<span class="sd">             /          |</span>
<span class="sd">            /           |</span>
<span class="sd">           p3-----------p2</span>

<span class="sd">        All of the following vector arguments must have the same length.</span>

<span class="sd">        Args:</span>
<span class="sd">            xp0 (array): Array or list of longitudes (floats) of p0.</span>
<span class="sd">            yp0 (array): Array or list of latitudes (floats) of p0.</span>
<span class="sd">            zp0 (array): Array or list of depths (floats) of p0.</span>
<span class="sd">            xp1 (array): Array or list of longitudes (floats) of p1.</span>
<span class="sd">            yp1 (array): Array or list of latitudes (floats) of p1.</span>
<span class="sd">            zp1 (array): Array or list of depths (floats) of p1.</span>
<span class="sd">            xp2 (array): Array or list of longitudes (floats) of p2.</span>
<span class="sd">            yp2 (array): Array or list of latitudes (floats) of p2.</span>
<span class="sd">            zp2 (array): Array or list of depths (floats) of p2.</span>
<span class="sd">            xp3 (array): Array or list of longitudes (floats) of p3.</span>
<span class="sd">            yp3 (array): Array or list of latitudes (floats) of p3.</span>
<span class="sd">            zp3 (array): Array or list of depths (floats) of p3.</span>
<span class="sd">            origin (Origin): Reference to a ShakeMap Origin object.</span>
<span class="sd">            group_index (list): List of integers to indicate group index. If</span>
<span class="sd">                None then each quadrilateral is assumed to be in a different</span>
<span class="sd">                group since there is no guarantee that any of them are</span>
<span class="sd">                continuous.</span>
<span class="sd">            reference (str): String explaining where the rupture definition</span>
<span class="sd">                came from (publication style reference, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            QuadRupture object, where the rupture is modeled as a series of</span>
<span class="sd">            trapezoids.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ShakeLibException: if the lengths of the inptu arrays are not</span>
<span class="sd">                all equal, or if the length of the group_index is not the</span>
<span class="sd">                same as the arrays (if group_index is supplied)..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">zp0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp1</span><span class="p">)</span> <span class="o">==</span> \
           <span class="nb">len</span><span class="p">(</span><span class="n">zp1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">zp2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp3</span><span class="p">)</span> <span class="o">==</span> \
           <span class="nb">len</span><span class="p">(</span><span class="n">yp3</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">zp3</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ShakeLibException</span><span class="p">(</span><span class="s1">&#39;All vectors specifying quadrilateral &#39;</span>
                                    <span class="s1">&#39;vertices must have the same length.&#39;</span><span class="p">)</span>

        <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xp0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_index</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nq</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ShakeLibException</span><span class="p">(</span>
                    <span class="s2">&quot;group_index must have same length as vertices.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">))</span>

        <span class="n">xp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">yp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yp0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">zp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zp0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">xp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">yp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yp1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">zp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zp1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">xp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">yp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yp2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">zp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zp2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">xp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">yp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yp3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">zp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zp3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Create GeoJSON object</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">group_index</span><span class="p">)</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">u_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">group_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">xp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">xp1</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                 <span class="n">xp2</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">xp3</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">xp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
                 <span class="p">])</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">yp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">yp1</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                 <span class="n">yp2</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">yp3</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">yp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
                 <span class="p">])</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">zp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">zp1</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                 <span class="n">zp2</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">zp3</span><span class="p">[</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span>
                 <span class="n">zp0</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
                 <span class="p">])</span>

            <span class="n">poly</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
                <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">dep</span><span class="p">])</span>
            <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
             <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="n">reference</span>
             <span class="p">},</span>
             <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[{</span>
                 <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s2">&quot;rupture type&quot;</span><span class="p">:</span> <span class="s2">&quot;rupture extent&quot;</span>
                 <span class="p">},</span>
                 <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">coords</span><span class="p">]</span>
                 <span class="p">}</span>
             <span class="p">}]}</span>

        <span class="c1"># Add origin information to metadata</span>
        <span class="n">odict</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">odict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">HistoricTime</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TIMEFMT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;eventid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuadRupture.getQuadrilaterals"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getQuadrilaterals">[docs]</a>    <span class="k">def</span> <span class="nf">getQuadrilaterals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of quadrilaterals.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of quadrilaterals where each quad is a tuple of four</span>
<span class="sd">                `Point &lt;https://github.com/gem/oq-hazardlib/blob/master/openquake/hazardlib/geo/point.py&gt;`__</span>
<span class="sd">                objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuadRupture.getStrike"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getStrike">[docs]</a>    <span class="k">def</span> <span class="nf">getStrike</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return strike angle. If rupture consists of multiple quadrilaterals,</span>
<span class="sd">        the average strike angle, weighted by quad length, is returned.</span>
<span class="sd">        Note: for ruptures with quads where the strike angle changes by 180 deg</span>
<span class="sd">        due to reverses in dip direction are problematic and not handeled well</span>
<span class="sd">        by this algorithm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Strike angle in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">)</span>
        <span class="n">strikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
            <span class="n">P0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">strikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span><span class="o">.</span><span class="n">azimuth</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
            <span class="n">lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">strikes</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">strikes</span><span class="p">))</span>
        <span class="n">xbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
        <span class="n">ybar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xbar</span><span class="p">,</span> <span class="n">ybar</span><span class="p">))</span></div>

<div class="viewcode-block" id="QuadRupture.getDepthToTop"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getDepthToTop">[docs]</a>    <span class="k">def</span> <span class="nf">getDepthToTop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine shallowest vertex of entire rupture.</span>

<span class="sd">        :returns:</span>
<span class="sd">            Shallowest depth of all vertices (float).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mindep</span> <span class="o">=</span> <span class="mi">9999999</span>
        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">:</span>
            <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">quad</span>
            <span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">P0</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">depth</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mindep</span><span class="p">:</span>
                <span class="n">mindep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mindep</span></div>

<div class="viewcode-block" id="QuadRupture.getDip"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getDip">[docs]</a>    <span class="k">def</span> <span class="nf">getDip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return average dip of all quadrilaterals in the rupture.</span>

<span class="sd">        Returns:</span>
<span class="sd">           float: Average dip in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dipsum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_normal</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_vertical_vector</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
            <span class="n">dipsum</span> <span class="o">=</span> <span class="n">dipsum</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Vector</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">V</span><span class="p">)))</span>
        <span class="n">dip</span> <span class="o">=</span> <span class="n">dipsum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dip</span></div>

<div class="viewcode-block" id="QuadRupture.getIndividualWidths"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getIndividualWidths">[docs]</a>    <span class="k">def</span> <span class="nf">getIndividualWidths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of rupture widths (km), one for each quadrilateral</span>
<span class="sd">        defined for the rupture.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Array of quad widths in km of all rupture quadrilaterals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nquad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumQuads</span><span class="p">()</span>
        <span class="n">widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nquad</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nquad</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_quad_width</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">widths</span></div>

<div class="viewcode-block" id="QuadRupture.getIndividualTopLengths"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getIndividualTopLengths">[docs]</a>    <span class="k">def</span> <span class="nf">getIndividualTopLengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of rupture lengths along top edge (km),</span>
<span class="sd">        one for each quadrilateral defined for the rupture.</span>

<span class="sd">        :returns:</span>
<span class="sd">            Array of lengths in km of top edge of quadrilaterals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nquad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumQuads</span><span class="p">()</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nquad</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nquad</span><span class="p">):</span>
            <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
            <span class="n">lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">mag</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="k">return</span> <span class="n">lengths</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fixStrikeDirection</span><span class="p">(</span><span class="n">quad</span><span class="p">):</span>
        <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">quad</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>  <span class="c1"># fromPoint converts to ECEF</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
        <span class="n">p1p0</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>
        <span class="n">p2p0</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p0</span>
        <span class="n">qnv</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">p2p0</span><span class="p">,</span> <span class="n">p1p0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">+</span> <span class="n">qnv</span>
        <span class="n">tmplat</span><span class="p">,</span> <span class="n">tmplon</span><span class="p">,</span> <span class="n">tmpz</span> <span class="o">=</span> <span class="n">ecef2latlon</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tmpz</span> <span class="o">-</span> <span class="n">P0</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>  <span class="c1"># If True then do nothing</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="n">quad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newP0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
            <span class="n">newP1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">newP2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>
            <span class="n">newP3</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="p">[</span><span class="n">newP0</span><span class="p">,</span> <span class="n">newP1</span><span class="p">,</span> <span class="n">newP2</span><span class="p">,</span> <span class="n">newP3</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fixed</span>

    <span class="k">def</span> <span class="nf">_setQuadrilaterals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create internal list of N quadrilaterals. Reverses quad if dip</span>
<span class="sd">        direction is incorrect.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Make sure arrays are numpy arrays.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_depth</span><span class="p">)</span>

        <span class="c1"># Find the nans, which tells is where the separate polygons/groups are</span>
        <span class="n">group_ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_ends</span><span class="p">)</span>

        <span class="c1"># Check that arrays are the same length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lat</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_depth</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                <span class="s1">&#39;Length of input lon, lat, depth arrays must be equal&#39;</span><span class="p">)</span>

        <span class="c1"># Construct quads</span>
        <span class="n">group_start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groupind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
            <span class="n">lonseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="p">[</span><span class="n">group_start</span><span class="p">:</span><span class="n">group_ends</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">latseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span><span class="p">[</span><span class="n">group_start</span><span class="p">:</span><span class="n">group_ends</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">depthseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span><span class="p">[</span><span class="n">group_start</span><span class="p">:</span><span class="n">group_ends</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

            <span class="c1"># Each group can have many contiguous quadrilaterals defined in it</span>
            <span class="c1"># separations (nans) between segments mean that segments are not</span>
            <span class="c1"># contiguous.</span>

            <span class="n">npoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lonseg</span><span class="p">)</span>
            <span class="n">nquads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">quad_start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">quad_end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nquads</span><span class="p">):</span>
                <span class="n">P0</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">lonseg</span><span class="p">[</span><span class="n">quad_start</span><span class="p">],</span>
                           <span class="n">latseg</span><span class="p">[</span><span class="n">quad_start</span><span class="p">],</span>
                           <span class="n">depthseg</span><span class="p">[</span><span class="n">quad_start</span><span class="p">])</span>
                <span class="n">P1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">lonseg</span><span class="p">[</span><span class="n">quad_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                           <span class="n">latseg</span><span class="p">[</span><span class="n">quad_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                           <span class="n">depthseg</span><span class="p">[</span><span class="n">quad_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">P2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">lonseg</span><span class="p">[</span><span class="n">quad_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                           <span class="n">latseg</span><span class="p">[</span><span class="n">quad_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                           <span class="n">depthseg</span><span class="p">[</span><span class="n">quad_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">P3</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">lonseg</span><span class="p">[</span><span class="n">quad_end</span><span class="p">],</span>
                           <span class="n">latseg</span><span class="p">[</span><span class="n">quad_end</span><span class="p">],</span>
                           <span class="n">depthseg</span><span class="p">[</span><span class="n">quad_end</span><span class="p">])</span>
                <span class="n">quad</span> <span class="o">=</span> <span class="p">[</span><span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">]</span>

                <span class="c1"># Enforce plane by moving P2 -- already close because of check</span>
                <span class="c1"># in read_rupture_file/is_quadrupture_class/is_quad</span>

                <span class="n">dummy</span><span class="p">,</span> <span class="n">fixed_quad</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_quad</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>

                <span class="c1"># Reverse quad if necessary</span>
                <span class="n">fixed_quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixStrikeDirection</span><span class="p">(</span><span class="n">fixed_quad</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixed_quad</span><span class="p">)</span>

                <span class="n">quad_start</span> <span class="o">=</span> <span class="n">quad_start</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">quad_end</span> <span class="o">=</span> <span class="n">quad_end</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">group_start</span> <span class="o">=</span> <span class="n">group_ends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_index</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">groupind</span><span class="p">]</span> <span class="o">*</span> <span class="n">nquads</span><span class="p">)</span>
            <span class="n">groupind</span> <span class="o">=</span> <span class="n">groupind</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_getGroupIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of segment group indexes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Segment group indexes; length equals the number of</span>
<span class="sd">                quadrilaterals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_index</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of latitudes for the rupture verticies arranged for</span>
<span class="sd">        plotting purposes; will give an outline of each group connected</span>
<span class="sd">        segments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Numpy array of closed-loop latitude values; disconnected</span>
<span class="sd">                segments are separated by nans.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">quads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getGroupIndex</span><span class="p">()</span>
        <span class="n">u_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">ng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ng</span><span class="p">):</span>
            <span class="n">q_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span> <span class="o">==</span> <span class="n">u_groups</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_ind</span><span class="p">)</span>
            <span class="n">top_lats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bot_lats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">top0</span> <span class="o">=</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">]</span>
                    <span class="n">bot0</span> <span class="o">=</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">]</span>
                    <span class="n">top_lats</span> <span class="o">=</span> <span class="n">top_lats</span> <span class="o">+</span> <span class="n">top0</span>
                    <span class="n">bot_lats</span> <span class="o">=</span> <span class="n">bot_lats</span> <span class="o">+</span> <span class="n">bot0</span>
                <span class="n">top_lats</span> <span class="o">=</span> <span class="n">top_lats</span> <span class="o">+</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">]</span>
                <span class="n">bot_lats</span> <span class="o">=</span> <span class="n">bot_lats</span> <span class="o">+</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">]</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span> <span class="o">+</span> <span class="n">top_lats</span> <span class="o">+</span> <span class="n">bot_lats</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">top0</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of longitudes for the rupture verticies arranged for</span>
<span class="sd">        plotting purposes; will give an outline of each group connected</span>
<span class="sd">        segments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Numpy array of closed-loop longitude values; disconnected</span>
<span class="sd">                segments are separated by nans.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">quads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getGroupIndex</span><span class="p">()</span>
        <span class="n">u_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">ng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ng</span><span class="p">):</span>
            <span class="n">q_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span> <span class="o">==</span> <span class="n">u_groups</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_ind</span><span class="p">)</span>
            <span class="n">top_lons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bot_lons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">top0</span> <span class="o">=</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">]</span>
                    <span class="n">bot0</span> <span class="o">=</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">]</span>
                    <span class="n">top_lons</span> <span class="o">=</span> <span class="n">top_lons</span> <span class="o">+</span> <span class="n">top0</span>
                    <span class="n">bot_lons</span> <span class="o">=</span> <span class="n">bot_lons</span> <span class="o">+</span> <span class="n">bot0</span>
                <span class="n">top_lons</span> <span class="o">=</span> <span class="n">top_lons</span> <span class="o">+</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">]</span>
                <span class="n">bot_lons</span> <span class="o">=</span> <span class="n">bot_lons</span> <span class="o">+</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">]</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span> <span class="o">+</span> <span class="n">top_lons</span> <span class="o">+</span> <span class="n">bot_lons</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">top0</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">depths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of depths for the rupture verticies arranged for</span>
<span class="sd">        plotting purposes; will give an outline of each group connected</span>
<span class="sd">        segments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Numpy array of closed-loop depths; disconnected</span>
<span class="sd">                segments are separated by nans.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">quads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getGroupIndex</span><span class="p">()</span>
        <span class="n">u_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">ng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ng</span><span class="p">):</span>
            <span class="n">q_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span> <span class="o">==</span> <span class="n">u_groups</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_ind</span><span class="p">)</span>
            <span class="n">top_deps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bot_deps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">top0</span> <span class="o">=</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">]</span>
                    <span class="n">bot0</span> <span class="o">=</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">]</span>
                    <span class="n">top_deps</span> <span class="o">=</span> <span class="n">top_deps</span> <span class="o">+</span> <span class="n">top0</span>
                    <span class="n">bot_deps</span> <span class="o">=</span> <span class="n">bot_deps</span> <span class="o">+</span> <span class="n">bot0</span>
                <span class="n">top_deps</span> <span class="o">=</span> <span class="n">top_deps</span> <span class="o">+</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">]</span>
                <span class="n">bot_deps</span> <span class="o">=</span> <span class="n">bot_deps</span> <span class="o">+</span> <span class="p">[</span><span class="n">quads</span><span class="p">[</span><span class="n">q_ind</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">]</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span> <span class="o">+</span> <span class="n">top_deps</span> <span class="o">+</span> <span class="n">bot_deps</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">top0</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

<div class="viewcode-block" id="QuadRupture.getDeps"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getDeps">[docs]</a>    <span class="k">def</span> <span class="nf">getDeps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a copy of the array of depths for the rupture verticies.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Numpy array of latitude values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="QuadRupture.getNumGroups"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getNumGroups">[docs]</a>    <span class="k">def</span> <span class="nf">getNumGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a count of the number of rupture groups.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int:Rnumber of rupture groups.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_index</span><span class="p">))</span></div>

<div class="viewcode-block" id="QuadRupture.getNumQuads"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getNumQuads">[docs]</a>    <span class="k">def</span> <span class="nf">getNumQuads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a count of the number of rupture quadrilaterals.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of rupture quadrilaterals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quadrilaterals</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuadRupture.getRuptureAsArrays"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getRuptureAsArrays">[docs]</a>    <span class="k">def</span> <span class="nf">getRuptureAsArrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a 3-tuple of numpy arrays indicating X, Y, Z (lon,lat,depth)</span>
<span class="sd">        coordinates. Rupture groups are separated by numpy.NaN values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: 3-tuple of numpy arrays indicating X,Y,Z (lon,lat,depth)</span>
<span class="sd">                coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lat</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_depth</span><span class="p">))</span></div>

<div class="viewcode-block" id="QuadRupture.getRuptureAsMesh"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.getRuptureAsMesh">[docs]</a>    <span class="k">def</span> <span class="nf">getRuptureAsMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return rupture segments as a OQ-Hazardlib Mesh object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mesh (https://github.com/gem/oq-hazardlib/blob/master/openquake/hazardlib/geo/mesh.py)</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
        <span class="n">rupture</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rupture</span></div>

<div class="viewcode-block" id="QuadRupture.computeRjb"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.computeRjb">[docs]</a>    <span class="k">def</span> <span class="nf">computeRjb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for computing Joyner-Boore distance.</span>

<span class="sd">        Args:</span>
<span class="sd">            lon (array): Numpy array of longitudes.</span>
<span class="sd">            lat (array): Numpy array of latitudes.</span>
<span class="sd">            depth (array): Numpy array of depths (km; positive down).</span>

<span class="sd">        Returns:</span>
<span class="sd">           tuple: A tuple of an array of Joyner-Boore distance (km), and None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Sort out sites</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">oldshape</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">oldshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">latlon2ecef</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">newshape</span>
        <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">newshape</span>
        <span class="n">z</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">newshape</span>
        <span class="n">sites_ecef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>

        <span class="n">minrjb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">newshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">lon</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e16</span>
        <span class="n">quads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quads</span><span class="p">)):</span>
            <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">quads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">S0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">S1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
            <span class="n">S2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
            <span class="n">S3</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>
            <span class="n">S0</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">S1</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">S2</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">S3</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">squad</span> <span class="o">=</span> <span class="p">[</span><span class="n">S0</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">S3</span><span class="p">]</span>
            <span class="n">rjbdist</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_quad_distance</span><span class="p">(</span><span class="n">squad</span><span class="p">,</span> <span class="n">sites_ecef</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">minrjb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">minrjb</span><span class="p">,</span> <span class="n">rjbdist</span><span class="p">)</span>

        <span class="n">minrjb</span> <span class="o">=</span> <span class="n">minrjb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">oldshape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">minrjb</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="QuadRupture.computeRrup"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.computeRrup">[docs]</a>    <span class="k">def</span> <span class="nf">computeRrup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for computing rupture distance.</span>

<span class="sd">        Args:</span>
<span class="sd">            lon (array): Numpy array of longitudes.</span>
<span class="sd">            lat (array): Numpy array of latitudes.</span>
<span class="sd">            depth (array): Numpy array of depths (km; positive down).</span>

<span class="sd">        Returns:</span>
<span class="sd">           tuple: A tuple of an array of Rupture distance (km), and None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Sort out sites</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">oldshape</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">oldshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">latlon2ecef</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">newshape</span>
        <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">newshape</span>
        <span class="n">z</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">newshape</span>
        <span class="n">sites_ecef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>

        <span class="n">minrrup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">newshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">lon</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e16</span>
        <span class="n">quads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQuadrilaterals</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quads</span><span class="p">)):</span>
            <span class="n">rrupdist</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_quad_distance</span><span class="p">(</span><span class="n">quads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sites_ecef</span><span class="p">)</span>
            <span class="n">minrrup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">minrrup</span><span class="p">,</span> <span class="n">rrupdist</span><span class="p">)</span>

        <span class="n">minrrup</span> <span class="o">=</span> <span class="n">minrrup</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">oldshape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">minrrup</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="QuadRupture.computeGC2"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.quad_rupture.html#shakelib.rupture.quad_rupture.QuadRupture.computeGC2">[docs]</a>    <span class="k">def</span> <span class="nf">computeGC2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for computing version 2 of the Generalized Coordinate system</span>
<span class="sd">        (GC2) by Spudich and Chiou OFR 2015-1028.</span>

<span class="sd">        Args:</span>
<span class="sd">            lon (array): Numpy array of longitudes.</span>
<span class="sd">            lat (array): Numpy array of latitudes.</span>
<span class="sd">            depth (array): Numpy array of depths (km; positive down).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary with keys for each of the GC2-related distances,</span>
<span class="sd">                which include &#39;rx&#39;, &#39;ry&#39;, &#39;ry0&#39;, &#39;U&#39;, &#39;T&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This just hands off to the module-level method</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">gc2</span><span class="o">.</span><span class="n">_computeGC2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/northridge_thumbnail_light_16x9.png" alt="Logo"/>
    
    <h1 class="logo logo-name">ShakeMap Documentation</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual4_0/index.html">ShakeMap 4.0 Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../programs/programs.html">ShakeMap 4.0 Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/shakemap.html">ShakeMap 4.0 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manual3_5/index.html">ShakeMap 3.5 Manual (Deprecated)</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>