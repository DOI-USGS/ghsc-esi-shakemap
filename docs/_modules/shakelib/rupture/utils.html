
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>shakelib.rupture.utils &#8212; ShakeMap Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for shakelib.rupture.utils</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># stdlib modules</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib.geo.point</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib.geo.utils</span> <span class="kn">import</span> <span class="n">OrthographicProjection</span>

<span class="kn">from</span> <span class="nn">impactutils.vectorutils.ecef</span> <span class="kn">import</span> <span class="n">latlon2ecef</span>
<span class="kn">from</span> <span class="nn">impactutils.vectorutils.vector</span> <span class="kn">import</span> <span class="n">Vector</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.exception</span> <span class="kn">import</span> <span class="n">ShakeLibException</span>
<span class="kn">from</span> <span class="nn">shakelib.rupture</span> <span class="kn">import</span> <span class="n">constants</span>


<div class="viewcode-block" id="is_quad"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.is_quad">[docs]</a><span class="k">def</span> <span class="nf">is_quad</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks that an individual quad is coplanar.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four OQ Points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Bool for whether or not the points are planar within tolerance;</span>
<span class="sd">            and also the corrected quad where p2 is adjusted to be on the same</span>
<span class="sd">            plane as the other points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>

    <span class="c1"># Convert points to ECEF</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>

    <span class="c1"># Unit vector along top edge</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>

    <span class="c1"># Distance along bottom edge</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span><span class="o">.</span><span class="n">mag</span><span class="p">()</span>

    <span class="c1"># New location for p2 by extending from p3 the same distance and</span>
    <span class="c1"># direction that p1 is from p0:</span>
    <span class="n">new_p2</span> <span class="o">=</span> <span class="n">p3</span> <span class="o">+</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">d</span>

    <span class="c1"># How far off of the plane is the origin p2?</span>
    <span class="n">planepoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">get_distance_to_plane</span><span class="p">(</span><span class="n">planepoints</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

    <span class="c1"># Is it close enough?</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">constants</span><span class="o">.</span><span class="n">OFFPLANE_TOLERANCE</span><span class="p">:</span>
        <span class="n">on_plane</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">on_plane</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Fixed quad</span>
    <span class="n">fquad</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">toPoint</span><span class="p">(),</span>
             <span class="n">p1</span><span class="o">.</span><span class="n">toPoint</span><span class="p">(),</span>
             <span class="n">new_p2</span><span class="o">.</span><span class="n">toPoint</span><span class="p">(),</span>
             <span class="n">p3</span><span class="o">.</span><span class="n">toPoint</span><span class="p">()]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">on_plane</span><span class="p">,</span> <span class="n">fquad</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_quad_width"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_width">[docs]</a><span class="k">def</span> <span class="nf">get_quad_width</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return width of an individual planar trapezoid, where the p0-p1 distance</span>
<span class="sd">    represents the long side.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Width of planar trapezoid in km.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>
    <span class="n">AB</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">-</span> <span class="n">p1</span>
    <span class="n">AC</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">-</span> <span class="n">p3</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">AB</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">AC</span><span class="p">)</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">AB</span><span class="p">))</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AC</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.0</span>

    <span class="k">return</span> <span class="n">width</span></div>


<div class="viewcode-block" id="get_quad_mesh"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_mesh">[docs]</a><span class="k">def</span> <span class="nf">get_quad_mesh</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a mesh from a quadrilateal.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>
<span class="sd">        dx (float):  Target dx in km; used to get nx and ny of mesh, but mesh</span>
<span class="sd">            snaps to edges of rupture so actual dx/dy will not actually equal</span>
<span class="sd">            this value in general.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Mesh dictionary, which includes numpy arrays:</span>

<span class="sd">        - llx: lower left x coordinate in ECEF coords.</span>
<span class="sd">        - lly: lower left y coordinate in ECEF coords.</span>
<span class="sd">        - llz: lower left z coordinate in ECEF coords.</span>
<span class="sd">        - ulx: upper left x coordinate in ECEF coords.</span>
<span class="sd">        - etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>  <span class="c1"># fromPoint converts to ECEF</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>

    <span class="c1"># Get nx based on length of top edge, minimum allowed is 2</span>
    <span class="n">toplen_km</span> <span class="o">=</span> <span class="n">get_quad_length</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">toplen_km</span> <span class="o">/</span> <span class="n">dx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># Get array of points along top and bottom edges</span>
    <span class="n">xfac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="n">topp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xfac</span><span class="p">]</span>
    <span class="n">botp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p3</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p3</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xfac</span><span class="p">]</span>

    <span class="c1"># Get ny based on mean length of vectors connecting top and bottom points</span>
    <span class="n">ylen_km</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
        <span class="n">ylen_km</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">topp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">botp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">mag</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ylen_km</span><span class="p">)</span> <span class="o">/</span> <span class="n">dx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="n">yfac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

    <span class="c1"># Build mesh: dict of ny by nx arrays (x, y, z):</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">]),</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">[</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">]),</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">])}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
        <span class="n">mpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">topp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">botp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">topp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">yfac</span><span class="p">]</span>
        <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mpts</span><span class="p">]</span>
        <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mpts</span><span class="p">]</span>
        <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mpts</span><span class="p">]</span>

    <span class="c1"># Make arrays of pixel corners</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lrx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;ulx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;urx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;uly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;ury&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lrz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;ulz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;urz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llx&#39;</span><span class="p">])</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llx&#39;</span><span class="p">])</span>
    <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llx&#39;</span><span class="p">])</span>

    <span class="c1"># i and j are indices over subruptures</span>
    <span class="n">ni</span><span class="p">,</span> <span class="n">nj</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ni</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nj</span><span class="p">):</span>
            <span class="c1"># Rupture corner points</span>
            <span class="n">pp0</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span>
                <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;ulx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;uly&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;ulz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">pp1</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span>
                <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;urx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;ury&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;urz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">pp2</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span>
                <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lrx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lry&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lrz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">pp3</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span>
                <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;lly&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;llz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="c1"># Find center of quad</span>
            <span class="n">mp0</span> <span class="o">=</span> <span class="n">pp0</span> <span class="o">+</span> <span class="p">(</span><span class="n">pp1</span> <span class="o">-</span> <span class="n">pp0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">mp1</span> <span class="o">=</span> <span class="n">pp3</span> <span class="o">+</span> <span class="p">(</span><span class="n">pp2</span> <span class="o">-</span> <span class="n">pp3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">mp0</span> <span class="o">+</span> <span class="p">(</span><span class="n">mp1</span> <span class="o">-</span> <span class="n">mp0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">x</span>
            <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpy&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">y</span>
            <span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;cpz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">z</span>
    <span class="k">return</span> <span class="n">mesh</span></div>


<div class="viewcode-block" id="get_local_unit_slip_vector"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_local_unit_slip_vector">[docs]</a><span class="k">def</span> <span class="nf">get_local_unit_slip_vector</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the components of a unit slip vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        strike (float): Clockwise angle (deg) from north of the line at the</span>
<span class="sd">            intersection of the rupture plane and the horizontal plane.</span>
<span class="sd">        dip (float): Angle (deg) between rupture plane and the horizontal plane</span>
<span class="sd">            normal to the strike (0-90 using right hand rule).</span>
<span class="sd">        rake (float): Direction of motion of the hanging wall relative to the</span>
<span class="sd">            foot wall, as measured by the angle (deg) from the strike vector.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: Unit slip vector in &#39;local&#39; N-S, E-W, U-D coordinates.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span>
    <span class="n">rake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span> <span class="o">+</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span> <span class="o">+</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_local_unit_slip_vector_DS"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_local_unit_slip_vector_DS">[docs]</a><span class="k">def</span> <span class="nf">get_local_unit_slip_vector_DS</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the DIP SLIP components of a unit slip vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        strike (float): Clockwise angle (deg) from north of the line at the</span>
<span class="sd">            intersection of the rupture plane and the horizontal plane.</span>
<span class="sd">        dip (float): Angle (degrees) between rupture plane and the horizontal</span>
<span class="sd">            plane normal to the strike (0-90 using right hand rule).</span>
<span class="sd">        rake (float): Direction of motion of the hanging wall relative to the</span>
<span class="sd">            foot wall, as measured by the angle (deg) from the strike vector.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: Unit slip vector in &#39;local&#39; N-S, E-W, U-D coordinates.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span>
    <span class="n">rake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_local_unit_slip_vector_SS"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_local_unit_slip_vector_SS">[docs]</a><span class="k">def</span> <span class="nf">get_local_unit_slip_vector_SS</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the STRIKE SLIP components of a unit slip vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        strike (float): Clockwise angle (deg) from north of the line at the</span>
<span class="sd">            intersection of the rupture plane and the horizontal plane.</span>
<span class="sd">        dip (float): Angle (degrees) between rupture plane and the horizontal</span>
<span class="sd">            plane normal to the strike (0-90 using right hand rule).</span>
<span class="sd">        rake (float): Direction of motion of the hanging wall relative to the</span>
<span class="sd">            foot wall, as measured by the angle (deg) from the strike vector.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: Unit slip vector in &#39;local&#39; N-S, E-W, U-D coordinates.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span>
    <span class="n">rake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rake</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span></div>


<div class="viewcode-block" id="reverse_quad"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.reverse_quad">[docs]</a><span class="k">def</span> <span class="nf">reverse_quad</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reverse the verticies of a quad in the sense that the strike direction</span>
<span class="sd">    is flipped.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Reversed quadrilateral.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span></div>


<div class="viewcode-block" id="get_quad_slip"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_slip">[docs]</a><span class="k">def</span> <span class="nf">get_quad_slip</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rake</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the unit slip vector in ECEF space for a quad and rake angle.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>
<span class="sd">        rake (float): Direction of motion of the hanging wall relative to</span>
<span class="sd">        the foot wall, as measured by the angle (deg) from the strike vector.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: Unit slip vector in ECEF space.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">strike</span> <span class="o">=</span> <span class="n">P0</span><span class="o">.</span><span class="n">azimuth</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">dip</span> <span class="o">=</span> <span class="n">get_quad_dip</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">s1_local</span> <span class="o">=</span> <span class="n">get_local_unit_slip_vector</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="p">)</span>
    <span class="n">s0_local</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">qlats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">latitude</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">q</span><span class="p">]</span>
    <span class="n">qlons</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">longitude</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">q</span><span class="p">]</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">OrthographicProjection</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">qlons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">qlons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">qlats</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">qlats</span><span class="p">))</span>
    <span class="n">s1_ll</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s1_local</span><span class="o">.</span><span class="n">x</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s1_local</span><span class="o">.</span><span class="n">y</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s0_ll</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s0_local</span><span class="o">.</span><span class="n">x</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s0_local</span><span class="o">.</span><span class="n">y</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s1_ecef</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromTuple</span><span class="p">(</span><span class="n">latlon2ecef</span><span class="p">(</span><span class="n">s1_ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s1_ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s1_local</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
    <span class="n">s0_ecef</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromTuple</span><span class="p">(</span><span class="n">latlon2ecef</span><span class="p">(</span><span class="n">s0_ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s0_ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s0_local</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
    <span class="n">slp_ecef</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1_ecef</span> <span class="o">-</span> <span class="n">s0_ecef</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">slp_ecef</span></div>


<div class="viewcode-block" id="get_quad_length"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_length">[docs]</a><span class="k">def</span> <span class="nf">get_quad_length</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Length of top eduge of a quadrilateral.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Length of quadrilateral in km.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>  <span class="c1"># fromPoint converts to ECEF</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">qlength</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">mag</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="k">return</span> <span class="n">qlength</span></div>


<div class="viewcode-block" id="get_quad_dip"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_dip">[docs]</a><span class="k">def</span> <span class="nf">get_quad_dip</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dip of a quadrilateral.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Dip in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">get_quad_normal</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">get_vertical_vector</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Vector</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">V</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">dip</span></div>


<div class="viewcode-block" id="get_quad_normal"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_normal">[docs]</a><span class="k">def</span> <span class="nf">get_quad_normal</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the unit normal vector for a quadrilateral in</span>
<span class="sd">    ECEF coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: Normalized normal vector for the quadrilateral in ECEF coords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>  <span class="c1"># fromPoint converts to ECEF</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">p3</span> <span class="o">-</span> <span class="n">p0</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">vn</span></div>


<div class="viewcode-block" id="get_quad_strike_vector"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_strike_vector">[docs]</a><span class="k">def</span> <span class="nf">get_quad_strike_vector</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the unit vector pointing in the direction of strike for a</span>
<span class="sd">    quadrilateral in ECEF coordinates. Top edge assumed to be horizontal.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: The unit vector pointing in strike direction in ECEF coords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>  <span class="c1"># fromPoint converts to ECEF</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">v1</span></div>


<div class="viewcode-block" id="get_quad_down_dip_vector"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_quad_down_dip_vector">[docs]</a><span class="k">def</span> <span class="nf">get_quad_down_dip_vector</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the unit vector pointing down dip for a quadrilateral in</span>
<span class="sd">    ECEF coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: The unit vector pointing down dip in ECEF coords.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>  <span class="c1"># fromPoint converts to ECEF</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">p0p1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>
    <span class="n">qnv</span> <span class="o">=</span> <span class="n">get_quad_normal</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">ddv</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">p0p1</span><span class="p">,</span> <span class="n">qnv</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ddv</span></div>


<div class="viewcode-block" id="get_vertical_vector"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_vertical_vector">[docs]</a><span class="k">def</span> <span class="nf">get_vertical_vector</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the vertical unit vector for a quadrilateral</span>
<span class="sd">    in ECEF coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Vector: Normalized vertical vector for the quadrilateral in ECEF</span>
<span class="sd">                coords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">P0_up</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
    <span class="n">P0_up</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">P0_up</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>   <span class="c1"># fromPoint converts to ECEF</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0_up</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">v1</span></div>


<span class="k">def</span> <span class="nf">_quad_distance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the shortest distance from a set of points to a rupture surface.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (list): A quadrilateral; list of four points.</span>
<span class="sd">        points (array): Numpy array Nx3 of points (ECEF) to calculate distance</span>
<span class="sd">            from.</span>
<span class="sd">        horizontal:  Boolean indicating whether to treat points inside quad as</span>
<span class="sd">            0 distance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Array of size N of distances (in km) from input points to</span>
<span class="sd">            rupture surface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span> <span class="o">=</span> <span class="n">q</span>

    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="c1"># project this quad to the surface</span>
        <span class="n">P0</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">P0</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P0</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">P1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">P1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">P2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">P2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">P3</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">P3</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P3</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Convert to ecef</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>

    <span class="c1"># Make a unit vector normal to the plane</span>
    <span class="n">normalVector</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">p0d</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span> <span class="o">-</span> <span class="n">points</span>
    <span class="n">p1d</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span> <span class="o">-</span> <span class="n">points</span>
    <span class="n">p2d</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span> <span class="o">-</span> <span class="n">points</span>
    <span class="n">p3d</span> <span class="o">=</span> <span class="n">p3</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span> <span class="o">-</span> <span class="n">points</span>

    <span class="c1"># Create 4 planes with normals pointing outside rectangle</span>
    <span class="n">n0</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normalVector</span><span class="p">)</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normalVector</span><span class="p">)</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normalVector</span><span class="p">)</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span> <span class="o">-</span> <span class="n">p3</span><span class="p">)</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normalVector</span><span class="p">)</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>

    <span class="n">sgn0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">signbit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n0</span> <span class="o">*</span> <span class="n">p0d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sgn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">signbit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">p1d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sgn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">signbit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n2</span> <span class="o">*</span> <span class="n">p2d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sgn3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">signbit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n3</span> <span class="o">*</span> <span class="n">p3d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">inside_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">sgn0</span> <span class="o">==</span> <span class="n">sgn1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sgn1</span> <span class="o">==</span> <span class="n">sgn2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sgn2</span> <span class="o">==</span> <span class="n">sgn3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">inside_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">inside_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p0d</span><span class="p">[</span><span class="n">inside_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">normalVector</span><span class="o">.</span><span class="n">getArray</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">outside_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">inside_idx</span><span class="p">)</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="n">_distance_sq_to_segment</span><span class="p">(</span><span class="n">p0d</span><span class="p">,</span> <span class="n">p1d</span><span class="p">)</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">_distance_sq_to_segment</span><span class="p">(</span><span class="n">p1d</span><span class="p">,</span> <span class="n">p2d</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">_distance_sq_to_segment</span><span class="p">(</span><span class="n">p2d</span><span class="p">,</span> <span class="n">p3d</span><span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">_distance_sq_to_segment</span><span class="p">(</span><span class="n">p3d</span><span class="p">,</span> <span class="n">p0d</span><span class="p">)</span>

    <span class="n">smin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">))</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">outside_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">smin</span><span class="p">[</span><span class="n">outside_idx</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">ShakeLibException</span><span class="p">(</span><span class="s2">&quot;Could not calculate some distances!&quot;</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span>


<div class="viewcode-block" id="get_distance_to_plane"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.get_distance_to_plane">[docs]</a><span class="k">def</span> <span class="nf">get_distance_to_plane</span><span class="p">(</span><span class="n">planepoints</span><span class="p">,</span> <span class="n">otherpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a point&#39;s distance to a plane.  Used to figure out if a</span>
<span class="sd">    quadrilateral points are all co-planar.</span>

<span class="sd">    Args:</span>
<span class="sd">        planepoints (list): List of three points (from Vector class) defining a</span>
<span class="sd">            plane.</span>
<span class="sd">        otherpoint (Vector): 4th Vector to compare to points defining the</span>
<span class="sd">            plane.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Distance (in meters) from otherpoint to plane.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># from</span>
    <span class="c1"># https://en.wikipedia.org/wiki/Plane_(geometry)#Describing_a_plane_through_three_points</span>
    <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">planepoints</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
    <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">z3</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">],</span> <span class="p">[</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">z3</span><span class="p">]]))</span>
    <span class="k">if</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">z3</span><span class="p">]]))</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z2</span><span class="p">],</span> <span class="p">[</span><span class="n">x3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z3</span><span class="p">]]))</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">/</span> <span class="n">D</span><span class="p">)</span> <span class="o">*</span> <span class="n">at</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">/</span> <span class="n">D</span><span class="p">)</span> <span class="o">*</span> <span class="n">bt</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">/</span> <span class="n">D</span><span class="p">)</span> <span class="o">*</span> <span class="n">ct</span>

        <span class="n">numer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">otherpoint</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span>
                       <span class="n">b</span> <span class="o">*</span> <span class="n">otherpoint</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span>
                       <span class="n">c</span> <span class="o">*</span> <span class="n">otherpoint</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">numer</span> <span class="o">/</span> <span class="n">denom</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">dist</span></div>


<span class="k">def</span> <span class="nf">_distance_sq_to_segment</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the distance^2 from the origin to a segment defined by two</span>
<span class="sd">    vectors</span>

<span class="sd">    Args:</span>
<span class="sd">        p0 (array): Numpy array Nx3 (ECEF).</span>
<span class="sd">        p1 (array): Numpy array Nx3 (ECEF).</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The squared distance from the origin to a segment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># /*</span>
    <span class="c1">#  * This algorithm is from (Vince&#39;s) CS1 class.</span>
    <span class="c1">#  * It returns the distance^2 from the origin to a segment defined</span>
    <span class="c1">#  * by two vectors</span>
    <span class="c1">#  */</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1"># /* Are the two points equal? */</span>
    <span class="n">idx_equal</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">p1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">p0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">p1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p0</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">p1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">idx_equal</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p0</span><span class="p">[</span><span class="n">idx_equal</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                              <span class="n">p0</span><span class="p">[</span><span class="n">idx_equal</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p0</span><span class="p">[</span><span class="n">idx_equal</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>

    <span class="c1"># /*</span>
    <span class="c1">#  * C1 = c1/|v| is the projection of the origin O on line (P0,P1).</span>
    <span class="c1">#  * If C1 is negative, then O is outside the segment and</span>
    <span class="c1">#  * closer to the P0 side.</span>
    <span class="c1">#  * If C1 is positive and &gt;V then O is on the other side.</span>
    <span class="c1">#  * If C1 is positive and &lt;V then O is inside.</span>
    <span class="c1">#  */</span>

    <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p0</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">idx_neg</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">idx_neg</span><span class="p">]</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">idx_neg</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p0</span><span class="p">[</span><span class="n">idx_neg</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p0</span><span class="p">[</span><span class="n">idx_neg</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">idx_less_c1</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">&lt;=</span> <span class="n">c1</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">idx_less_c1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">idx_less_c1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
        <span class="n">p1</span><span class="p">[</span><span class="n">idx_less_c1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="n">idx_less_c1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">idx_other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">idx_neg</span> <span class="o">|</span> <span class="n">idx_equal</span> <span class="o">|</span> <span class="n">idx_less_c1</span><span class="p">)</span>

    <span class="n">nr</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">/</span> <span class="n">c2</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">t1</span><span class="p">)</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">idx_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">idx_other</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
        <span class="n">tmp</span><span class="p">[</span><span class="n">idx_other</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">[</span><span class="n">idx_other</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">dist</span>


<div class="viewcode-block" id="rake_to_mech"><a class="viewcode-back" href="../../../shakelib/shakelib.rupture.utils.html#shakelib.rupture.utils.rake_to_mech">[docs]</a><span class="k">def</span> <span class="nf">rake_to_mech</span><span class="p">(</span><span class="n">rake</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert rake to mechanism.</span>

<span class="sd">    Args:</span>
<span class="sd">        rake (float): Rake angle in degrees.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Mechanism.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mech</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>
    <span class="k">if</span> <span class="n">rake</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rake</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">180</span> <span class="ow">and</span> <span class="n">rake</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">150</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="n">rake</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">30</span> <span class="ow">and</span> <span class="n">rake</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="n">rake</span> <span class="o">&gt;=</span> <span class="mi">150</span> <span class="ow">and</span> <span class="n">rake</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">):</span>
            <span class="n">mech</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
        <span class="k">if</span> <span class="n">rake</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">rake</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">60</span><span class="p">:</span>
            <span class="n">mech</span> <span class="o">=</span> <span class="s1">&#39;NM&#39;</span>
        <span class="k">if</span> <span class="n">rake</span> <span class="o">&gt;=</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">rake</span> <span class="o">&lt;=</span> <span class="mi">120</span><span class="p">:</span>
            <span class="n">mech</span> <span class="o">=</span> <span class="s1">&#39;RS&#39;</span>
    <span class="k">return</span> <span class="n">mech</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/northridge_thumbnail_light_16x9.png" alt="Logo"/>
    
    <h1 class="logo logo-name">ShakeMap Documentation</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual4_0/index.html">ShakeMap 4.0 Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../programs/programs.html">ShakeMap 4.0 Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/shakemap.html">ShakeMap 4.0 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manual3_5/index.html">ShakeMap 3.5 Manual (Deprecated)</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>